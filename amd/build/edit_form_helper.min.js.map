{"version":3,"sourceRoot":"..","sources":["server/course/format/tiles/amd/src/edit_form_helper.js"],"sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/* eslint space-before-function-paren: 0 */\n\n/**\n * Javascript Module to handle changes which are made to the course > edit settings\n * form as the user changes various options\n * e.g. if user deselects one item, this deselects another linked one for them\n * if the user picks an invalid option it will be detected by format_tiles::edit_form_validation (lib.php)\n * but this is to help them avoid triggering that if they have JS enabled\n *\n * @module      edit_form_helper\n * @package     course/format\n * @subpackage  tiles\n * @copyright   2018 David Watson {@link http://evolutioncode.uk}\n * @license     http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n * @since       Moodle 3.3\n */\n\ndefine([\"jquery\", \"core/notification\", \"core/str\", \"core/templates\", \"format_tiles/browser_storage\"],\n    function ($, Notification, str, Templates, browserStorage) {\n        \"use strict\";\n        return {\n            init: function (pageType, courseDefaultIcon, courseId, sectionId, section, userId, allowphototiles, documentationUrl) {\n                $(document).ready(function () {\n                    $(\"select#id_courseusesubtiles\").change(function (e) {\n                        if (e.currentTarget.value !== \"0\") {\n                            // We are changing to use sub tiles.\n                            // For convenience, uncheck the \"Emphasise headings with coloured tab\" box.\n                            // User can change it back if they want.\n                            $(\"input#id_courseusebarforheadings\").prop(\"checked\", false);\n                        }\n                    });\n                    $(\"select#id_courseshowtileprogress\").change(function (e) {\n                        if (e.currentTarget.value !== \"0\") {\n                            var enableCompBox = $(\"select#id_enablecompletion\");\n                            if (enableCompBox.val() === \"0\") {\n                                // We are changing to show progress on tiles\n                                // For convenience, if completion tracking if off at course level, switch it on and tell the user.\n                                // User can change it back if they want.  See under \"completion tracking > enable.\n                                enableCompBox.val(\"1\");\n                                str.get_strings([\n                                    {key: \"completion\", component: \"completion\"},\n                                    {key: \"completionswitchhelp\", component: \"format_tiles\"}\n                                ]).done(function (s) {\n                                    Notification.alert(\n                                        s[0],\n                                        s[1]\n                                    );\n                                });\n                            }\n                        }\n                    });\n                    $(\"select#id_enablecompletion\").change(function (e) {\n                        if (e.currentTarget.value === \"0\") {\n                            // We are changing switch completion tracking off at course level too.\n                            // See under \"completion tracking > enable.\n                            // It follows that we must be hiding progress on tiles too.\n                            $(\"select#id_courseshowtileprogress\").val(\"0\");\n                        }\n                    });\n\n                    // Create clickable colour swatch for each colour in the select drop down to help user choose.\n                    var colourSelectMenu = $(\"select#id_basecolour\");\n                    Templates.render(\"format_tiles/colour_picker\", {\n                        colours: colourSelectMenu.find(\"option\").map(\n                            function (index, option) {\n                                var optselector = $(option);\n                                var colour = optselector.attr(\"value\");\n                                return {\n                                    colour: colour,\n                                    colourname: optselector.text(),\n                                    selected: colour === colourSelectMenu.val(),\n                                    id: colour.replace(\"#\", \"\")\n                                };\n                            }\n                        ).toArray()\n                    }).done(function (html) {\n                        // Add the newly created colour picker next to the standard select menu.\n                        $(html).insertAfter(colourSelectMenu);\n                        // Now that users are using the colour circles we can hide the text menu.\n                        colourSelectMenu.hide();\n                        // Watch for clicks on each circle and set select menu to correct colour on click.\n\n                        var circles = $(\".colourpickercircle\");\n\n                        circles.click(function (e) {\n                            var clicked = $(e.currentTarget);\n                            circles.removeClass(\"selected\");\n                            clicked.addClass(\"selected\");\n                            colourSelectMenu.val(clicked.attr(\"data-colour\"));\n                            $(\"#colourselectnotify\").fadeIn(200).fadeOut(1200);\n                        });\n\n                        colourSelectMenu.change(function () {\n                            circles.removeClass(\"selected\");\n                            $(\"#colourpick_\" + colourSelectMenu.val().replace(\"#\", \"\")).addClass(\"selected\");\n                        });\n\n                        // If the course is being switched in to \"Tiles\", body will still have old format class e.g. format-topics.\n                        // This comes from core.  We want body to have format-tiles class for our colour picker CSS, so we add it.\n                        var body = $(\"body\");\n                        if (!body.hasClass(\"format-tiles\")) {\n                            body.addClass(\"format-tiles\");\n                        }\n                    });\n\n                    // If we are on the course edit settings form, render a button to be added to it.\n                    // Put it next to the existing drop down select box for course default tile icon.\n                    // Add it to the page.\n\n                    var selectedIconName;\n                    var selectBox;\n                    if (pageType === \"course-edit\") {\n                        selectBox = $(\"#id_defaulttileicon\");\n                        selectedIconName = $(\"#id_defaulttileicon option:selected\").text();\n                    } else if (pageType === \"course-editsection\") {\n                        selectBox = $(\"#id_tileicon\");\n                        selectedIconName = $(\"#id_tileicon option:selected\").text();\n                    }\n                    if (pageType === \"course-edit\" || (pageType === \"course-editsection\" && section !== \"0\")) {\n                        var currentIcon;\n                        if (selectBox.val() === \"\") {\n                            currentIcon = courseDefaultIcon;\n                        } else {\n                            currentIcon = selectBox.val();\n                        }\n                        Templates.render(\"format_tiles/icon_picker_launch_btn\", {\n                            initialicon: currentIcon,\n                            initialname: selectedIconName,\n                            sectionId: sectionId,\n                            allowphototiles: allowphototiles\n                        }).done(function (html) {\n                            $(html).insertAfter(selectBox);\n\n                            // We can hide the original select box now as users will use the button instead.\n                            selectBox.hide();\n                            require([\"format_tiles/edit_icon_picker\"], function(iconPicker) {\n                                iconPicker.init(courseId, pageType, allowphototiles, documentationUrl);\n                            });\n                        });\n                    } else if (pageType === \"course-editsection\" && section === \"0\") {\n                        selectBox.closest(\".row\").hide(); // Don't have an icon for section zero.\n                    }\n\n                    // Add a row to the page with link to plugin documentation.\n                    Templates\n                        .render(\"format_tiles/edit_form_helptext\", {documentationurl: documentationUrl + '/teacher'})\n                        .done(function (html) {\n                            $(html).appendTo($(\"#id_courseformathdr .fcontainer\"));\n                        });\n\n                    // Clean up all browser storage since the settings may have changed so stored content is wrong.\n                    browserStorage.init(courseId, 1, true, 1, 0, true, userId);\n                    browserStorage.cleanUpStorage();\n                });\n            }\n        };\n    }\n);"],"names":["define","$","Notification","str","Templates","browserStorage","init","pageType","courseDefaultIcon","courseId","sectionId","section","userId","allowphototiles","documentationUrl","document","ready","change","e","currentTarget","value","prop","enableCompBox","val","get_strings","key","component","done","s","alert","colourSelectMenu","render","colours","find","map","index","option","optselector","colour","attr","colourname","text","selected","id","replace","toArray","html","insertAfter","hide","circles","click","clicked","removeClass","addClass","fadeIn","fadeOut","body","hasClass","selectedIconName","selectBox","currentIcon","initialicon","initialname","require","iconPicker","closest","documentationurl","appendTo","cleanUpStorage"],"mappings":"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"}