{"version":3,"sourceRoot":"..","sources":["server/course/format/tiles/amd/src/edit_course_mod.js"],"sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/* global setTimeout, document, window, Y, M */\n/* eslint space-before-function-paren: 0 */\n\n/**\n * Javascript Module to handle edit actions on course modules.\n *\n * @module      edit_course_mod\n * @package     course/format\n * @subpackage  tiles\n * @copyright   2018 David Watson {@link http://evolutioncode.uk}\n * @license     http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n * @since       Moodle 3.3\n */\n\ndefine([\"jquery\", \"core/ajax\", \"core/templates\", \"core/notification\", \"core/str\", \"core/url\", \"core/config\"],\n    function ($, ajax, Templates, Notification, str, url, config) {\n        \"use strict\";\n\n        /**\n         * Keep references for all modals we have already added to the page,\n         * so that we can relaunch then if needed without asking server\n         * @type {{}}\n         */\n        var stringStore = {};\n\n        var body = $(\"html,body\");\n        var page = $(\"#page\");\n\n        var Selector = {\n            MENU_ACTION: \".menu-action-text\",\n            SUBTILE: \".subtile\",\n            SPACER: \".spacer\",\n            AVAIL_INFO: \".availabilityinfo\",\n            ACTIVITY_INSTANCE: \".subtile-activityinstance\",\n            INSTANCE_NAME: \".instancename\",\n            SECTION_CM_EDIT_ACTIONS: \".section-cm-edit-actions\",\n            EDITING_MOVE: \".editing_move\",\n            LABEL_CONVERT: \".editing_labelconvert\",\n            CM_EDIT_ACTION: \".cm-edit-action\",\n            ACTIVITY_ICON: \".activityicon\",\n            EDITING_DELETE: \".editing_delete\",\n            SECTION_MAIN: \".section.main\",\n            STEALTH_UNAVAIL_LINK: '.editing_makeunavailable'\n        };\n\n        var ClassNames = {\n            SHOW: \"show\",\n            HIDE: \"hide\",\n            FA_EYE_SLASH: \"fa-eye-slash\",\n            FA_EYE: \"fa-eye\",\n            DIMMED: \"dimmed\",\n            EDITING: \"editing_\",\n            ACTIVITY: \"activity\",\n            LABEL: \"label\",\n            SECTION_DRAGGABLE: \"sectiondraggable\"\n        };\n\n        var Event = {\n            CLICK: \"click\",\n            MODULE_ADDED: \"filter-content-updated\",\n            MOUSEDOWN: \"mousedown\"\n        };\n\n        /**\n         * This dates from before the change to using AJAX for editing teacher content (not yet released).\n         * Once the new functionality is released and no longer experimental, this can be removed.\n         *\n         *  If an editing user clicks a show/hide menu item on a course module\n         * @param {object} clickEvent\n         */\n        var legacyToggleHideCourseMod = function (clickEvent) {\n            var clickedLink = $(clickEvent.currentTarget);\n            var actions;\n            if (body.hasClass(\"totara\")) {\n                return;\n            }\n            if (clickedLink.attr(\"data-action\") === \"tiles-hide\") {\n                actions = {changeTo: ClassNames.HIDE, old: ClassNames.SHOW};\n                $(Selector.STEALTH_UNAVAIL_LINK).hide();\n            } else if (clickedLink.attr(\"data-action\") === \"tiles-show\") {\n                actions = {changeTo: ClassNames.SHOW, old: ClassNames.HIDE};\n            }\n            if (actions) {\n                clickEvent.preventDefault();\n                clickedLink.attr(\"data-action\", \"tiles-\" + actions.old);\n                var promises = ajax.call([{\n                    methodname: \"core_course_edit_module\",\n                    args: {\n                        id: clickedLink.attr(\"data-cmid\"),\n                        action: actions.changeTo\n                    }\n                }], true);\n                promises[0].done(function (HTMLresult) {\n                    // This core web service returns the new HTML for the course module.\n                    // However we don't want to use it, as we are using different templates for the CM.\n                    // To save re-implementing the core function, we replace elements in the old HTML instead of new.\n                    // TODO - consider if it is preferable to re-implement the core function or re-render CM.\n\n                    clickedLink.removeClass(ClassNames.EDITING + actions.old).addClass(ClassNames.EDITING + actions.changeTo);\n                    clickedLink.attr(\n                        \"href\", clickedLink.attr(\"href\").replace(\"&\" + actions.old + \"=\", \"&\" + actions.changeTo + \"=\")\n                    );\n                    // Replace the string on the menu item to \"Hide\" or \"Show\", and icon, as appropriate to reflect new state.\n                    var menuActionText = clickedLink.find(Selector.MENU_ACTION);\n                    var subtile = clickedLink.closest(Selector.SUBTILE);\n                    if (actions.changeTo === ClassNames.SHOW) {\n                        menuActionText.html(menuActionText.html().replace(stringStore.show, stringStore.hide));\n                        clickedLink.find(\"i\").removeClass(ClassNames.FA_EYE_SLASH).addClass(ClassNames.FA_EYE);\n                        subtile.removeClass(ClassNames.DIMMED); // Dim the related sub-tile.\n                    } else if (actions.changeTo === ClassNames.HIDE) {\n                        menuActionText.html(menuActionText.html().replace(stringStore.hide, stringStore.show));\n                        clickedLink.find(\"i\").removeClass(ClassNames.FA_EYE).addClass(ClassNames.FA_EYE_SLASH); // Replace the icon.\n                        subtile.addClass(ClassNames.DIMMED);\n                    }\n                    // Now replace the availability info displayed on the sub tile.\n                    var newAvailabilityInfo = $(HTMLresult).find(Selector.AVAIL_INFO);\n                    var oldAvailabilityInfo = subtile.find(Selector.AVAIL_INFO);\n                    if (newAvailabilityInfo) {\n                        if (oldAvailabilityInfo.length) {\n                            oldAvailabilityInfo.replaceWith(newAvailabilityInfo);\n                        } else {\n                            newAvailabilityInfo.appendTo(subtile.find(Selector.ACTIVITY_INSTANCE));\n                        }\n                    } else {\n                        oldAvailabilityInfo.hide();\n                    }\n                });\n                promises[0].fail(function () {\n                    // We failed to use JS to handle so refer user to the original PHP URL instead.\n                    window.location.replace(clickedLink.attr(\"href\"));\n                });\n            }\n        };\n\n        /**\n         * This dates from before the change to using AJAX for editing teacher content.\n         * Once the new functionality is no longer experimental, this can be removed.\n         *\n         * When a new item is added to course by drag drop, we have to convert it to subtile format\n         * For this we need to know which class to add to it (e.g. ppt) so that it has the correct icon\n         * and colouring on the sub tile.  The easiest way to work this out is to use the icon URL\n         * from the standard activity\n         * @param {string} iconURL the icon URL oe.g. [wwwroot]/theme/image.php/boost/core/1535409577/f/pdf-24\n         * @returns {string} the type e.g. 'pdf'\n         */\n        var legacyFileTypeFromIconURL = function (iconURL) {\n            var extensions = {\n                powerpoint: \"ppt\",\n                document: \"doc\",\n                spreadsheet: \"xls\",\n                archive: \"zip\",\n                pdf: \"pdf\",\n                mp3: \"mp3\",\n                mpeg: \"mp4\",\n                jpeg: \"jpeg\",\n                text: \"txt\",\n                html: \"html\"\n            };\n            if (iconURL) {\n                // Return the type corresponding to the last item in the URL, excluding anything after '-'.\n                return extensions[iconURL.split(\"/\").slice(-1)[0].split(\"-\")[0]];\n            } else {\n                return false;\n            }\n        };\n\n        /**\n         * This dates from before the change to using AJAX for editing teacher content.\n         * Once the new functionality is no longer experimental, this can be removed.\n         *\n         * When a new course module is dragged and dropped into the course\n         * we need its attributes so that we can convert it into a sub tile if needed\n         * This assembles them ready to be sent to the mustache template\n         *\n         * @param {object} cmObject the jquery object added\n         * @param {string} modResourceType type of module e.g. 'page'\n         * @param {string} displayname e.g. \"Spreadsheet\"\n         * @returns {object} promise for the module attributes\n         */\n        var legacyCourseModGetSubtileAttributes = function (cmObject, modResourceType, displayname) {\n            // TODO would be better to handle this whole function with a web service for cm data?\n            if (displayname === undefined || displayname === \"\") {\n                // Failed to get string for this type\n                displayname = stringStore.other; // Use \"other\" instead of proper word.\n            }\n            // We take the course module edit menu from the new CM which core added to the course.\n            // We remove the data-action attributes from the hide menu item, as we dont want it to call JS.\n            // if it called JS, the result would not only hide the item (good) but re-render it using standard core template (bad).\n            cmObject.find('a.cm-edit-action').each(function (index, editItem) {\n                $(editItem).attr('data-action', '');\n            });\n            cmObject.find('a.editing_moveright').remove(); // We do not use this with subtiles (indent).\n            var returnData = {\n                cmid: cmObject.attr(\"id\").split(\"-\").slice(-1)[0], // Last item.\n                modtitle: cmObject.find(Selector.INSTANCE_NAME).html().split(\"<\")[0],\n                cmeditmenu: cmObject.find(Selector.SECTION_CM_EDIT_ACTIONS)[0].outerHTML.replace(/\\n/g, \"\"),\n                cmmove: cmObject.find(Selector.EDITING_MOVE)[0].outerHTML,\n                modname: \"resource\",\n                modResourceType: modResourceType,\n                modnameDisplay: displayname,\n                useSubtiles: 1,\n                isEmbeddedResource: 0,\n                clickable: 1,\n                isediting: 1,\n                visible: 1\n            };\n            returnData.isPdf = returnData.modResourceType === \"pdf\";\n            return returnData;\n        };\n\n        /**\n         * This dates from before the change to using AJAX for editing teacher content.\n         * Once the new functionality is no longer experimental, this can be removed.\n         * @param {number} courseId\n         * @param {object} addedCourseModule\n         * @param {object} sectionAddedTo\n         * @param {string} msg\n         */\n        var legacyHandleCmAddedToPage = function(courseId, addedCourseModule, sectionAddedTo, msg) {\n            if (sectionAddedTo.hasClass(ClassNames.SECTION_DRAGGABLE)\n                && window.location.href.indexOf('expand=') === -1) {\n                // An item has been dragged into a section when we are on the multi tile screen.\n                // However the section is not yet expanded.\n                // Therefore expand the section it has been dragged into so teacher can see it.\n                window.location = config.wwwroot + '/course/view.php?id=' + courseId\n                    + \"&expand=\" + sectionAddedTo.attr(\"data-section\")\n                    + \"#section-\" + sectionAddedTo.attr(\"data-section\");\n            } else if (addedCourseModule.hasClass(ClassNames.LABEL)\n                && addedCourseModule.closest('ul').hasClass('subtiles')) {\n                // The mod type is probably an image (being dragged in to the course.\n                // When this happens, core adds a label and puts it in.\n                // So allow this to happen, then reload the page.\n                // This ensures the image displays correctly (only bother if we are using subtiles).\n                window.location.reload();\n            } else if (\n                addedCourseModule.hasClass(ClassNames.ACTIVITY) && addedCourseModule.closest('ul').hasClass('subtiles')\n            ) {\n                // Only course modules and not (for example) user tours modal.\n                // If we are not using sub tiles in section zero, don't bother changing it there.\n                addedCourseModule.children().hide();\n                addedCourseModule.append($(\"<img/>\")\n                    .attr(\"src\", url.imageUrl(\"loading\", \"format_tiles\"))\n                    .addClass(\"loading-subtile\").attr('title', stringStore.loading));\n                var previousNonSpacer = addedCourseModule.prevAll(Selector.SUBTILE).not(Selector.SPACER).first();\n                addedCourseModule.prevUntil(previousNonSpacer, Selector.SPACER).hide();\n\n                // Get cmid, modtitle, modnameDisplay, cmeditmenu of ite just added to course by AJAX.\n                // Re-render it in the correct style for this format (as sub tile).\n                var modResourceType = legacyFileTypeFromIconURL(addedCourseModule.find(Selector.ACTIVITY_ICON).attr(\"src\"));\n                if (modResourceType === undefined) {\n                    // We have probably dragged an image into the course and chosen to add it as a file resource.\n                    window.location.reload();\n                }\n                var stringKey = \"displaytitle_mod_\" + modResourceType;\n                if (stringStore[stringKey] === undefined) {\n                    str.get_string(stringKey, \"format_tiles\")\n                        .done(function (string) {\n                            if (string.substring(0, 2) !== \"[[\") {\n                                // The [[ means unknown string.\n                                stringStore[stringKey] = string;\n                            } else {\n                                string = \"\";\n                            }\n                            var cmAttributes = legacyCourseModGetSubtileAttributes(\n                                addedCourseModule, modResourceType, string\n                            );\n                            Templates.render(\n                                \"format_tiles/course_module\",\n                                cmAttributes\n                            ).done(function (html) {\n                                addedCourseModule.replaceWith(html);\n                                // Flash the new item to bring attention to it.\n                                var newItem = $(\"#\" + $(msg).attr(\"id\"));\n                                body.animate({scrollTop: newItem.offset().top - 130}, \"fast\");\n                                for (var x = 0; x < 3; x++) {\n                                    newItem.fadeOut(300).fadeIn(300);\n                                }\n                                // The move cm icon will not work, so if is clicked, we refresh page so it works.\n                                $('#module-' + cmAttributes.cmid).find('.editing_move')\n                                    .attr('data-action', '')\n                                    .on(Event.MOUSEDOWN, function() {\n                                        window.location.reload();\n                                    });\n                            });\n                        });\n                } else {\n                    var cmAttributes = legacyCourseModGetSubtileAttributes(\n                        addedCourseModule, modResourceType, stringStore[stringKey]\n                    );\n                    Templates.render(\"format_tiles/course_module\", cmAttributes).done(function (html) {\n                        addedCourseModule.replaceWith(html);\n                        // The move cm icon will not work, so if is clicked, we refresh page so it works.\n                        $('#module-' + cmAttributes.cmid).find('.editing_move')\n                            .attr('data-action', '')\n                            .on(Event.MOUSEDOWN, function() {\n                                window.location.reload();\n                            });\n                    });\n                }\n            } else {\n                // We are leaving the course module in the old style as added by core drag-drop.\n                // Adjust the inner div styling slightly to make it consistent with the others.\n                addedCourseModule.find('div.mod-indent-outer')\n                    .css('position', 'absolute').css('top', '0')\n                    .css('width', '100%').css('padding-left', '0');\n            }\n        };\n\n        return {\n            init: function (courseId, displaySection, convertedLabel) {\n                $(document).ready(function () {\n                    // This is to cover something which can happen when dragging and dropping a course module.\n                    // In course/amd/src/action.js is a method called M.course.coursebase.register_module.\n                    // This is called on each drag drop and results in tbe course module which is drag dropped,\n                    // and refreshed afterwards, changing  it in the process to a non tiles format.  This stops that.\n                    // Ugly but seems to work and can't see another easy way to stop it firing.\n                    Y.use(\"moodle-course-coursebase\", function () {\n                        // Clear existing instance variable to stop it - delay is to ensure page is loaded.\n                        if (typeof M.course !== \"undefined\") {\n                            setTimeout(function () {\n                                M.course.coursebase.registermodules = [];\n                            }, 500);\n                        }\n                    });\n\n                    // User wants to convert a label to a page using action menu on label.\n                    $(Selector.LABEL_CONVERT).on(Event.CLICK, function (e) {\n                        e.preventDefault();\n                        Notification.confirm(\n                            stringStore.areyousure,\n                            stringStore.converttopage_confirm,\n                            stringStore.yes,\n                            stringStore.no,\n                            function () {\n                                window.location = $(e.currentTarget).attr(\"href\");\n                            },\n                            null\n                        );\n                    });\n\n                    if (convertedLabel !== 0) {\n                        // User has just converted a label to a page, so highlight the new item they just converted.\n                        var newPage = $(\"#module-\" + convertedLabel);\n                        if (newPage !== undefined) {\n                            body.animate({scrollTop: newPage.offset().top - 130}, \"fast\");\n                            for (var x = 0; x < 3; x++) {\n                                newPage.fadeOut(300).fadeIn(300);\n                            }\n                        }\n                    }\n\n                    // If user clicks show/hide on a course module.\n                    page.on(\"click\", Selector.CM_EDIT_ACTION, function (e) {\n                        legacyToggleHideCourseMod(e);\n                    });\n\n                    // Listen for new items being added to course by drag drop and convert them to subtile format.\n                    // Otherwise the core JS will add them to the page in standard \"list\" format.\n                    // This can be moved to edit_course once legacy functions are removed.\n                    $(document).on(Event.MODULE_ADDED, function (event, msg) {\n                        var addedCourseModule = $(\"#\" + $(msg).attr(\"id\"));\n                        var sectionAddedTo = addedCourseModule.closest(Selector.SECTION_MAIN);\n                        if (sectionAddedTo.length >= 1) {\n                            legacyHandleCmAddedToPage(courseId, addedCourseModule, sectionAddedTo, msg);\n                        }\n                    });\n\n                    // If the teacher deletes a subtile, we need to hide any \"spacer\" subtiles directly before it.\n                    // We want none between what was the previous activity to the one we just deleted, and the next.\n                    page.on(Event.CLICK, Selector.EDITING_DELETE, function (e) {\n                        var deletedItem = $(e.currentTarget).closest(\"li\" + ClassNames.ACTIVITY);\n                        var previousNonSpacer = deletedItem.prevAll(Selector.SUBTILE).not(Selector.SPACER).first();\n                        if (deletedItem.hasClass(ClassNames.LABEL)) {\n                            deletedItem.prevUntil(previousNonSpacer, Selector.SPACER).hide();\n                        }\n                    });\n\n                    str.get_strings([\n                        {key: \"yes\"},\n                        {key: \"no\"},\n                        {key: \"show\"},\n                        {key: \"hide\"},\n                        {key: \"converttopage_confirm\", component: \"format_tiles\"},\n                        {key: \"areyousure\"},\n                        {key: \"complete\", component: \"format_tiles\"},\n                        {key: \"fileaddedtobottom\", component: \"format_tiles\"},\n                        {key: \"loading\", component: \"format_tiles\"}\n                    ]).done(function (s) {\n                        stringStore = {\n                            \"yes\": s[0],\n                            \"no\": s[1],\n                            \"show\": s[2],\n                            \"hide\": s[3],\n                            \"converttopage_confirm\": s[4],\n                            \"areyousure\": s[5],\n                            \"complete\": s[6],\n                            \"fileaddedtobottom\": s[7],\n                            \"loading\": s[8]\n                        };\n                    });\n                });\n            }\n        };\n    }\n);"],"names":["define","$","ajax","Templates","Notification","str","url","config","stringStore","body","page","Selector","MENU_ACTION","SUBTILE","SPACER","AVAIL_INFO","ACTIVITY_INSTANCE","INSTANCE_NAME","SECTION_CM_EDIT_ACTIONS","EDITING_MOVE","LABEL_CONVERT","CM_EDIT_ACTION","ACTIVITY_ICON","EDITING_DELETE","SECTION_MAIN","STEALTH_UNAVAIL_LINK","ClassNames","SHOW","HIDE","FA_EYE_SLASH","FA_EYE","DIMMED","EDITING","ACTIVITY","LABEL","SECTION_DRAGGABLE","Event","CLICK","MODULE_ADDED","MOUSEDOWN","legacyToggleHideCourseMod","clickEvent","clickedLink","currentTarget","actions","hasClass","attr","changeTo","old","hide","preventDefault","promises","call","methodname","args","id","action","done","HTMLresult","removeClass","addClass","replace","menuActionText","find","subtile","closest","html","show","newAvailabilityInfo","oldAvailabilityInfo","length","replaceWith","appendTo","fail","window","location","legacyFileTypeFromIconURL","iconURL","extensions","powerpoint","document","spreadsheet","archive","pdf","mp3","mpeg","jpeg","text","split","slice","legacyCourseModGetSubtileAttributes","cmObject","modResourceType","displayname","undefined","other","each","index","editItem","remove","returnData","cmid","modtitle","cmeditmenu","outerHTML","cmmove","modname","modnameDisplay","useSubtiles","isEmbeddedResource","clickable","isediting","visible","isPdf","legacyHandleCmAddedToPage","courseId","addedCourseModule","sectionAddedTo","msg","href","indexOf","wwwroot","reload","children","append","imageUrl","loading","previousNonSpacer","prevAll","not","first","prevUntil","stringKey","get_string","string","substring","cmAttributes","render","newItem","animate","scrollTop","offset","top","x","fadeOut","fadeIn","on","css","init","displaySection","convertedLabel","ready","Y","use","M","course","setTimeout","coursebase","registermodules","e","confirm","areyousure","converttopage_confirm","yes","no","newPage","event","deletedItem","get_strings","key","component","s","complete","fileaddedtobottom"],"mappings":"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"}