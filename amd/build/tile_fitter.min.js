define(["jquery","core/ajax"],function($,ajax){"use strict";var reOrgLocked=false;var courseId;var Selector={PAGE:"#page",TILE:".tile",TILEID:"#tile-",TILE_COLLAPSED:".tile-collapsed",TILES:".format-tiles.jsenabled ul.tiles",ACTIVITY:".activity",SPACER:".spacer",SECTION_ID:"#section-",OPEN_SECTION:".moveablesection:visible",SECTION_ZERO:"#section-0",CONTENT_SECTIONS:".moveablesection"};var timeoutBeforeResizeAjax=null;var resizeTilesDivWidth=function(){var winWidth=$(window).width();var dfd=new $.Deferred;var tiles=$(Selector.TILES);var TILE_WIDTHS={standard:260,min:225,mobileMin:160};try{var tilesParentWidth=tiles.parent().innerWidth();var firstTile=$(tiles.find(Selector.TILE)[0]);var oneTileWidth=firstTile.width()?firstTile.width():TILE_WIDTHS.standard;var tileMargin=14;oneTileWidth=oneTileWidth+tileMargin;var resizeWidth="inherit";var maxPossibleTilesPerRow=Math.floor(tilesParentWidth/TILE_WIDTHS.min);var tileCount=$(Selector.TILE).not(Selector.SPACER).length;if(tilesParentWidth<TILE_WIDTHS.mobileMin*2){dfd.reject("Too narrow to resize")}else if(tileCount<=3&&tilesParentWidth>tileCount*TILE_WIDTHS.mobileMin){resizeWidth=TILE_WIDTHS.standard*4}else if(tilesParentWidth<TILE_WIDTHS.min*3){resizeWidth=(TILE_WIDTHS.standard-tileMargin)*2}else if(maxPossibleTilesPerRow<4){resizeWidth=TILE_WIDTHS.standard*maxPossibleTilesPerRow}else{var range=function(start,end){var res=[];for(start;start<=end;start+=1){res.push(start)}return res};var rowMaxCount=Math.min(Math.floor(tilesParentWidth/oneTileWidth),tileCount);if(tileCount<=rowMaxCount&&tileCount>5){resizeWidth=(Math.floor(tileCount/2)+1)*oneTileWidth}else if(rowMaxCount>3&&tileCount/rowMaxCount<=3){var rowMinCount=Math.floor(tilesParentWidth/oneTileWidth);var possibleRowCounts=range(rowMinCount,rowMaxCount).reverse();var lastRowRemainderTiles=possibleRowCounts.map(function(num){return tileCount%num});if(lastRowRemainderTiles.indexOf(0)!==-1){resizeWidth=oneTileWidth*possibleRowCounts[lastRowRemainderTiles.indexOf(0)]}else if(tileCount<rowMinCount){resizeWidth=tileCount*oneTileWidth}else{resizeWidth=oneTileWidth*possibleRowCounts[lastRowRemainderTiles.indexOf(Math.max.apply(null,lastRowRemainderTiles))]}}else{resizeWidth=rowMaxCount*oneTileWidth}}var existingWidth=parseInt(tiles.css("max-width").replace("px",""));if(Math.abs(resizeWidth-existingWidth)<100){dfd.resolve()}else{var resizeTime=500;tiles.css("max-width",winWidth).animate({"max-width":resizeWidth},resizeTime,"swing",function(){setTimeout(function(){dfd.resolve()},resizeTime+100);$(Selector.CONTENT_SECTIONS).animate({"max-width":resizeWidth},resizeTime,"swing")})}if(timeoutBeforeResizeAjax){clearTimeout(timeoutBeforeResizeAjax)}timeoutBeforeResizeAjax=setTimeout(function(){ajax.call([{methodname:"format_tiles_set_session_width",args:{courseid:courseId,width:Math.floor(resizeWidth)}}])},3e3)}catch(err){tiles.css("max-width",winWidth).animate({"max-width":"100%"},500,"swing");ajax.call([{methodname:"format_tiles_set_session_width",args:{courseid:courseId,width:0}}]);dfd.reject("Failed to resize")}return dfd.promise()};var organiser={getContentSectionPositions:function(){var rows=[];var currentSectionId;var previousTile;var openSections=$(Selector.OPEN_SECTION);openSections.css("display","none");var maxTilesPerRow=1;var thisRowCount=0;var allTiles=$(Selector.TILES).children(Selector.TILE).not(Selector.TILE_COLLAPSED).not(".spacer");allTiles.each(function(index,tile){currentSectionId=$(tile).attr("data-section");var maxVerticalPositionDifference=100;if(currentSectionId){if(index===0){thisRowCount=1}else if(Math.abs($(tile).position().top-$(previousTile).position().top)<=maxVerticalPositionDifference){thisRowCount+=1}else{thisRowCount=0}if(thisRowCount>maxTilesPerRow){maxTilesPerRow=thisRowCount}previousTile=tile}});openSections.css("display","block");allTiles.each(function(index,tile){currentSectionId=$(tile).attr("data-section");if(rows.length===0||rows[rows.length-1].sections.length>=maxTilesPerRow){if(rows.length>=1){rows[rows.length-1].displayAfterTile=rows[rows.length-1].sections[rows[rows.length-1].sections.length-1]}rows.push({displayAfterTile:"",sections:[currentSectionId]})}else{rows[rows.length-1].sections.push(currentSectionId)}});rows[rows.length-1].displayAfterTile=rows[rows.length-1].sections[rows[rows.length-1].sections.length-1];return rows},moveContentSectionsToPlaces:function(positionData,callbacks){positionData.forEach(function(row){row.sections.forEach(function(contentSection){if(row.displayAfterTile===positionData[positionData.length-1].displayAfterTile){$(Selector.SECTION_ID+contentSection).detach().insertAfter($("ul.tiles .tile").last())}else{$(Selector.SECTION_ID+contentSection).detach().insertAfter($("#tile-"+row.displayAfterTile))}})});callbacks.forEach(function(func){if(typeof func==="function"){func()}})},runReOrg:function(delayBefore){var dfd=new $.Deferred;if(reOrgLocked===true){dfd.reject("Re-org locked")}reOrgLocked=true;var action=function(){organiser.moveContentSectionsToPlaces(organiser.getContentSectionPositions(),[function(){$("body").removeClass("modal-open");dfd.resolve("Finished organising tiles");reOrgLocked=false}])};if(delayBefore===true){setTimeout(function(){action();dfd.resolve("Re-org complete")},1e3)}else{action();dfd.resolve("Re-org complete")}return dfd.promise()}};var setListeners=function(){$(".block-hider-hide").click(function(){organiser.runReOrg(true)});$(".block-hider-show").click(function(){organiser.runReOrg(true)});$('.navbar button[data-action="toggle-drawer"]').click(function(){setTimeout(function(){organiser.runReOrg(true);resizeTilesDivWidth()},600)})};var unHideTiles=function(){$(Selector.TILES).animate({opacity:1},"fast");$(Selector.TILE).removeClass("initiallyhidden");$(Selector.SECTION_ZERO).animate({opacity:1},"fast");$("#page-loading-icon").fadeOut(500).remove()};return{init:function(courseIdInit,sectionOpen,fitTilesToWidth,isEditing){courseId=courseIdInit;$(document).ready(function(){setListeners();if($(Selector.TILES).css("opacity")==="1"){organiser.runReOrg().done(function(){if(sectionOpen!==0){$(Selector.TILEID+sectionOpen).click()}})}var organiseAndRevealTiles=function(){organiser.runReOrg().done(function(){if(sectionOpen!==0&&$(Selector.OPEN_SECTION).length===0){$(Selector.TILEID+sectionOpen).click()}unHideTiles()})};if(fitTilesToWidth&&!isEditing){resizeTilesDivWidth().done(function(){organiseAndRevealTiles()}).fail(function(){organiseAndRevealTiles()})}else{organiseAndRevealTiles()}})},resizeTilesDivWidth:function(){return resizeTilesDivWidth()},runReOrg:function(delayBefore){return organiser.runReOrg(delayBefore)}}});
//# sourceMappingURL=tile_fitter.min.js.map