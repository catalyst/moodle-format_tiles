define(["jquery","format_tiles/browser_storage_set_up"],function($,storageSetUp){"use strict";var courseId;var userId;var localStorageKeyElements={prefix:"mdl-tiles-",course:"mdl-tiles-course-",lastSection:"-lastSecId",content:"-content",lastUpdated:"-lastUpdated",collapseSecZero:"-collapsesec0",user:"-user-",section:"-sec-",userChoicePrefix:"mdl-tiles-userPrefStorage-"};var MAX_SECTIONS_TO_STORE;var encodeLastVistedSectionKeyName=function(){return localStorageKeyElements.course+courseId+localStorageKeyElements.user+userId+localStorageKeyElements.lastSection};var encodeContentKeyName=function(sectionId){return localStorageKeyElements.course+courseId+localStorageKeyElements.section+sectionId.toString()+localStorageKeyElements.user+userId+localStorageKeyElements.content};var encodeContentLastUpdatedKeyName=function(sectionId){return localStorageKeyElements.course+courseId+localStorageKeyElements.section+sectionId.toString()+localStorageKeyElements.user+userId+localStorageKeyElements.lastUpdated};var collapseSecZeroKey=function(){return localStorageKeyElements.course+courseId+localStorageKeyElements.user+userId+localStorageKeyElements.collapseSecZero};var isContentLastUpdatedKeyName=function(key){return key.indexOf(localStorageKeyElements.prefix)===0&&key.substr(-localStorageKeyElements.lastUpdated.length)===localStorageKeyElements.lastUpdated};var storeCourseContent=function(courseId,sectionId,html){if(sectionId===undefined||courseId===undefined){throw new Error("Missing section id")}try{if(html!==undefined&&html!==""&&storageSetUp.Enabled.session&&storageSetUp.storageAllowed()===true){sessionStorage.setItem(encodeContentKeyName(sectionId),html);sessionStorage.setItem(encodeContentLastUpdatedKeyName(sectionId),Math.round(Date.now()/1e3).toString())}else{sessionStorage.removeItem(encodeContentKeyName(sectionId));sessionStorage.removeItem(encodeContentLastUpdatedKeyName(sectionId))}}catch(err){require(["core/log"],function(log){log.debug(err)})}};var decodeLastUpdatedKey=function(key){var splitKey=key.split("-");if(isContentLastUpdatedKeyName(key)){return{courseId:parseInt(splitKey[splitKey.indexOf("course")+1]),sectionId:parseInt(splitKey[splitKey.indexOf("sec")+1]),userId:parseInt(splitKey[splitKey.indexOf("user")+1]),title:"lastUpdated"}}else{throw new Error("Invalid lastUpdated key")}};var cleanUp=function(contentDeleteMins,clearBrowserStorage,maxNumberToKeep){if(clearBrowserStorage){Object.keys(localStorage).filter(function(key){return key.indexOf(localStorageKeyElements.prefix)===0&&key.indexOf(localStorageKeyElements.userChoicePrefix)!==0}).forEach(function(item){localStorage.removeItem(item)});Object.keys(sessionStorage).filter(function(key){return key.indexOf(localStorageKeyElements.prefix)===0}).forEach(function(itemKey){if(isContentLastUpdatedKeyName(itemKey)){var params=decodeLastUpdatedKey(itemKey);storeCourseContent(params.courseId,params.sectionId,"")}})}else{var staleTime=Math.round(Date.now()/1e3)-contentDeleteMins*60;Object.keys(sessionStorage).filter(function(key){return key.indexOf(localStorageKeyElements.prefix)===0}).forEach(function(itemKey){if(isContentLastUpdatedKeyName(itemKey)){var params=decodeLastUpdatedKey(itemKey);if(sessionStorage.getItem(itemKey)<staleTime||contentDeleteMins===0){storeCourseContent(params.courseId,params.sectionId,"")}}});var lastUpdateKeys=Object.keys(sessionStorage).filter(function(item){return isContentLastUpdatedKeyName(item)});if(lastUpdateKeys.length>maxNumberToKeep){var lastUpdateTimes=lastUpdateKeys.map(function(key){return parseInt(sessionStorage[key])}).sort();var cutOffTime=lastUpdateTimes[lastUpdateTimes.length-maxNumberToKeep];if(maxNumberToKeep===0){cutOffTime=Date.now()}var params;lastUpdateKeys.filter(function(key){return sessionStorage[key]<cutOffTime}).forEach(function(expiredKey){params=decodeLastUpdatedKey(expiredKey);storeCourseContent(params.courseId,params.sectionId,"")})}}};var clearAllStorage=function(){cleanUp(0,1,1)};var setLastVisitedSection=function(sectionNum){if(sectionNum&&storageSetUp.Enabled.local){localStorage.setItem(encodeLastVistedSectionKeyName(),sectionNum.toString())}else{localStorage.removeItem(encodeLastVistedSectionKeyName())}};var Module={init:function(course,maxContentSectionsToStore,isEditing,sectionNum,storedContentDeleteMins,assumeDataStoreConsent,user){courseId=course.toString();userId=user.toString();MAX_SECTIONS_TO_STORE=parseInt(maxContentSectionsToStore);storageSetUp.init(userId,assumeDataStoreConsent,clearAllStorage);$(document).ready(function(){if(storageSetUp.storageAllowed()!==true){cleanUp(0,1,0)}if(isEditing){setLastVisitedSection(sectionNum);cleanUp(0,1,0);if(storageSetUp.Enabled.session){storeCourseContent(courseId,sectionNum,"")}$('a.menu-action[data-title="switchroleto,moodle"]').click(function(){cleanUp(0,1,0)})}else{var pageContent=$("#page-content");if(pageContent.length===0){pageContent=$("#region-main")}pageContent.on("click",".tile",function(){setTimeout(function(){cleanUp(parseInt(storedContentDeleteMins),0,MAX_SECTIONS_TO_STORE)},2e3)})}})},storageEnabledSession:function(){return storageSetUp.Enabled.session},storageEnabledLocal:function(){return storageSetUp.Enabled.local},storagestorageSetUperence:function(){return storageSetUp.storageAllowed()},getLastVisitedSection:function(){return storageSetUp.Enabled.local&&localStorage.getItem(encodeLastVistedSectionKeyName())},getCourseContent:function(courseId,sectionId){return sessionStorage.getItem(encodeContentKeyName(sectionId))},getStoredContentAge:function(courseId,sectionId){var storedTime=parseInt(sessionStorage.getItem(encodeContentLastUpdatedKeyName(sectionId)));if(storedTime){return Math.round(Date.now()/1e3-storedTime)}else{return false}},setSecZeroCollapseStatus:function(status){if(storageSetUp.Enabled.local&&storageSetUp.storageAllowed()){if(status==="collapsed"){localStorage.removeItem(collapseSecZeroKey())}else{localStorage.setItem(collapseSecZeroKey(),"1")}}},getSecZeroCollapseStatus:function(){return!!localStorage.getItem(collapseSecZeroKey())},storeCourseContent:function(courseId,sectionId,html){storeCourseContent(courseId,sectionId,html)},cleanUpStorage:function(){clearAllStorage()},setLastVisitedSection:function(sectionNum){if(storageSetUp.storageAllowed()){setLastVisitedSection(sectionNum)}}};return Module});
//# sourceMappingURL=browser_storage.min.js.map