{"version":3,"sourceRoot":"..","sources":["server/course/format/tiles/amd/src/edit_browser_storage.js"],"sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * Javascript Module to handle browser storage for editing interface.\n *\n * @module edit_browser_storage\n * @package course/format\n * @subpackage tiles\n * @copyright 2019 David Watson {@link http://evolutioncode.uk}\n * @license http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n * @since Moodle 3.3\n */\n\n/* eslint space-before-function-paren: 0 */\n\ndefine([\"jquery\", \"format_tiles/browser_storage_set_up\"], function ($, storageSetUp) {\n    \"use strict\";\n    var Selector = {\n        PAGE: '#page',\n        EDITING_COLLAPSE_SECID: \"#collapse\",\n        EDITING_COLLAPSE_SEC: \".collapse-section\",\n        EDITING_EXPAND_SEC: \".expand-section\",\n        EDITING_EXPAND_SECID: \"#expand\",\n        SECTION_CONTENT: \"li.section.main .content\",\n        SECTION_MAIN: \"li.section.main\",\n        SECTION_ID: \"#section-\"\n    };\n\n    var courseId;\n    var userId;\n\n    var StorageKeys = {\n        COURSE_VISIT: \"mdl-tiles-editing-last-visit-course-\",\n        EDITING_COURSE: \"mdl-tiles-editing-course-\",\n        SECTION: \"-section-\",\n        COURSE: \"mdl-tiles-course-\",\n        LAST_SECTION: \"-lastSecId\",\n        USER: \"-user-\",\n        PREFIX: \"mdl-tiles-\",\n        USER_CHOICE_PREFIX: \"mdl-tiles-userPrefStorage-\",\n        CONTENT_SUFFIX: \"-content\",\n        LAST_UPDATED_SUFFIX: \"-lastUpdated\"\n    };\n\n    var StorageValues = {\n        OPEN: \"1\",\n        CLOSED: \"0\"\n    };\n\n    var lastInteractedSection;\n\n    var encodeSectionStatus = function(sectionNum) {\n        return StorageKeys.EDITING_COURSE + courseId + StorageKeys.SECTION + sectionNum + StorageKeys.USER + userId;\n    };\n\n    /**\n     * Find out which sections of this course the user has showing as open in their browser storage.\n     * @param {number} maxSection\n     * @returns {Array}\n     */\n    var getOpenSections = function(maxSection) {\n        if (!maxSection || maxSection > 50) {\n            maxSection = 50; // Do not check more than 50 sections.\n        }\n        var sections = [];\n        var value;\n        for (var secNum = 1; secNum <= maxSection; secNum++) {\n            value = sessionStorage.getItem(encodeSectionStatus(secNum));\n            if (value === StorageValues.OPEN) {\n                sections.push(secNum);\n            }\n        }\n        return sections;\n    };\n\n    /**\n     * Storage key for the last section user was using.\n     * This is the same key as when not editing.\n     * @returns {string}\n     */\n    var lastSectionStorageKey = function () {\n        return StorageKeys.COURSE + courseId +\n        StorageKeys.USER + userId + StorageKeys.LAST_SECTION;\n    };\n\n    /**\n     * Set the last section the user was using.  This is the same key as when not editing.\n     * @param {number} sectionNum\n     */\n    var setLastSection = function(sectionNum) {\n        if (!sectionNum) {\n            localStorage.clear(lastSectionStorageKey());\n        } else if (sectionNum !== lastInteractedSection && storageSetUp.storageAllowed) {\n            lastInteractedSection = sectionNum;\n            localStorage.setItem(lastSectionStorageKey(), sectionNum.toString());\n        }\n    };\n\n    var getLastSection = function() {\n        if (!lastInteractedSection) {\n            lastInteractedSection = localStorage.getItem(lastSectionStorageKey());\n        }\n         return lastInteractedSection;\n    };\n\n    var setSectionStatus = function(secNum, open) {\n        if (storageSetUp.storageAllowed && open) {\n            sessionStorage.setItem(encodeSectionStatus(secNum), StorageValues.OPEN);\n        } else {\n            sessionStorage.removeItem(encodeSectionStatus(secNum));\n        }\n    };\n\n    /**\n     * If we are editing, we want to clear all stored content on initial page load.\n     * This ensure that, when we go back to not editing, our new content is shown not the old.\n     */\n    var clearStoredContent = function() {\n        Object.keys(sessionStorage).filter(function (key) {\n            return key.indexOf(StorageKeys.PREFIX) === 0 &&\n                (key.indexOf(StorageKeys.CONTENT_SUFFIX) === key.length - StorageKeys.CONTENT_SUFFIX.length\n                    || key.indexOf(StorageKeys.LAST_UPDATED_SUFFIX) === key.length - StorageKeys.LAST_UPDATED_SUFFIX.length);\n        }).forEach(function (item) {\n            // Item does relate to this plugin.\n            // It is not the user's preference about whether to use storage or not (keep that).\n            sessionStorage.removeItem(item);\n        });\n    };\n\n    /**\n     * Clear all browser storage used by this plugin.\n     */\n    var clearStorage = function() {\n        Object.keys(localStorage).filter(function (key) {\n            return key.indexOf(StorageKeys.PREFIX) === 0 && key.indexOf(StorageKeys.USER_CHOICE_PREFIX) === -1;\n        }).forEach(function (item) {\n            // Item does relate to this plugin.\n            // It is not the user's preference about whether to use storage or not (keep that).\n            localStorage.removeItem(item);\n        });\n        Object.keys(sessionStorage).filter(function (key) {\n            return key.indexOf(StorageKeys.PREFIX) === 0 && key.indexOf(StorageKeys.USER_CHOICE_PREFIX) === -1;\n        }).forEach(function (item) {\n            // Item does relate to this plugin.\n            // It is not the user's preference about whether to use storage or not (keep that).\n            sessionStorage.removeItem(item);\n        });\n    };\n\n    return {\n        getOpenSections: function(maxSection) {\n            return getOpenSections(maxSection);\n        },\n        init: function(\n            userIdInit,\n            courseIdInit,\n            maxContentSectionsToStore,\n            storedContentDeleteMins,\n            assumeDataStoreConsent,\n            lastSectionNum,\n            collapsingAllFromURL\n        ) {\n            courseId = courseIdInit;\n            userId = userIdInit;\n            if (lastSectionNum) {\n                setSectionStatus(lastSectionNum, true);\n            }\n            $(document).ready(function () {\n                storageSetUp.init(userId, assumeDataStoreConsent, clearStorage);\n                clearStoredContent();\n                if (storageSetUp.storageAllowed()) {\n                    sessionStorage.setItem(StorageKeys.COURSE_VISIT + courseId + StorageKeys.USER + userId, Date.now().toString());\n\n                    if (collapsingAllFromURL) {\n                        for (var i = 1; i <= lastSectionNum; i++) {\n                            setSectionStatus(i, false);\n                        }\n                    }\n                    // When section content is clicked, update the last visited section.\n                    $(Selector.PAGE).on(\"click\", Selector.SECTION_CONTENT, function(e) {\n                        var currTar = $(e.currentTarget);\n                        var sectionClicked = currTar.closest(Selector.SECTION_MAIN).attr(\"data-section\");\n                        setLastSection(sectionClicked);\n                    });\n                }\n            });\n        },\n        getLastSection: function() {\n            return getLastSection();\n        },\n        setSectionStatus: function(secNum, open) {\n            return setSectionStatus(secNum, open);\n        },\n        setLastSection: function(secNum) {\n            return setLastSection(secNum);\n        }\n    };\n});"],"names":["define","$","storageSetUp","Selector","PAGE","EDITING_COLLAPSE_SECID","EDITING_COLLAPSE_SEC","EDITING_EXPAND_SEC","EDITING_EXPAND_SECID","SECTION_CONTENT","SECTION_MAIN","SECTION_ID","courseId","userId","StorageKeys","COURSE_VISIT","EDITING_COURSE","SECTION","COURSE","LAST_SECTION","USER","PREFIX","USER_CHOICE_PREFIX","CONTENT_SUFFIX","LAST_UPDATED_SUFFIX","StorageValues","OPEN","CLOSED","lastInteractedSection","encodeSectionStatus","sectionNum","getOpenSections","maxSection","sections","value","secNum","sessionStorage","getItem","push","lastSectionStorageKey","setLastSection","localStorage","clear","storageAllowed","setItem","toString","getLastSection","setSectionStatus","open","removeItem","clearStoredContent","Object","keys","filter","key","indexOf","length","forEach","item","clearStorage","init","userIdInit","courseIdInit","maxContentSectionsToStore","storedContentDeleteMins","assumeDataStoreConsent","lastSectionNum","collapsingAllFromURL","document","ready","Date","now","i","on","e","currTar","currentTarget","sectionClicked","closest","attr"],"mappings":"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"}