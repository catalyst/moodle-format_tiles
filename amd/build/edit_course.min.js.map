{"version":3,"sourceRoot":"..","sources":["server/course/format/tiles/amd/src/edit_course.js"],"sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * Main Javascript module for format_tiles for when user *IS* editing.\n * See course.js for if they are not editing.\n * Handles the UI changes when tiles are selected and anything else not\n * covered by the specific modules\n *\n * @module edit_course\n * @package course/format\n * @subpackage tiles\n * @copyright 2019 David Watson {@link http://evolutioncode.uk}\n * @license http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n * @since Moodle 3.3\n */\n/* global document, window */\n/* eslint space-before-function-paren: 0 */\n\ndefine(\n    [\"jquery\", \"core/config\", \"core/str\", \"core/ajax\", \"format_tiles/edit_browser_storage\"],\n    function($, config, str, ajax, browserStorageEdit) {\n        \"use strict\";\n        var Selector = {\n            EDITING_COLLAPSE_SECID: \"#collapse\",\n            EDITING_COLLAPSE_SEC: \".collapse-section\",\n            EDITING_EXPAND_SEC: \".expand-section\",\n            EDITING_EXPAND_SECID: \"#expand\",\n            ACTIVITY: \"li.activity\",\n            SECTION_ID: \"#section-\",\n            TILE_TITLE: \"li.section.main .tile_bar_text .inplaceeditable a:not(.quickeditlink)\",\n            TILE_BAR_TEXT: \".tile_bar_text\",\n            SECTION: \"ul.section\",\n            SECTION_MAIN: \"li.section.main\",\n            DNDUPLOAD_HIDDEN: \"dndupload-hidden\",\n            ACTIVITYACTION: 'a.cm-edit-action',\n            ACTIONAREA: '.actions',\n            EXPAND_ALL_BTNS: \".expand-collapse-all-btns a\",\n            EXPAND_COLLAPSE_SEC: \".expand-collapse-sec \",\n            EDIT_TITLE_PENCIL: \".quickeditlink\",\n            ICON_PICKER_BTN: \".tileiconcontainer\",\n            TILE_BAR: \".tile_bar\",\n            SECTIONACTIONMENU: '.section_action_menu',\n            MENU_ACTION: \".menu-action\"\n        };\n\n        var Keyboard = {\n            ESCAPE: 27,\n            TAB: 9,\n            RETURN: 13\n        };\n\n        var Event = {\n            CLICK: \"click\",\n            KEYDOWN: \"keydown\",\n            SCROLL: \"scroll\"\n        };\n\n        var DataAttributes = {\n            SECTION: \"data-section\",\n            ORIG_TITLE: \"data-original-title\"\n        };\n\n        var courseId;\n\n        /**\n         * Collapse a given section according to the collapse button pressed.\n         * @param {number} secNum\n         */\n        var collapseSectionFromSecNum = function(secNum) {\n            var section = $(Selector.SECTION_ID + secNum);\n            $(Selector.SECTION_ID + secNum + \"-content\").animate({opacity: 0}, 300);\n            section.find(Selector.ACTIVITY).slideUp(500);\n            section.find(\".section-modchooser\").slideUp(500);\n            section.addClass(\"collapsed\").removeClass(\"expanded\");\n            section.find(\".mod-chooser-outer\").fadeOut(500);\n            browserStorageEdit.setSectionStatus(secNum, false);\n        };\n\n        return {\n            // All args down to \"filttilestowidth\" are copied from course.js.\n            init: function(\n                courseIdInit,\n                useJavascriptNav, // Set by site admin see settings.php.\n                maxContentSectionsToStore, // Set by site admin see settings.php.\n                isMobile,\n                sectionNum,\n                storedContentExpirySecs, // Set by site admin see settings.php.\n                storedContentDeleteMins, // Set by site admin see settings.php.\n                useFilterButtons,\n                assumeDataStoreConsent, // Set by site admin see settings.php.\n                reopenLastSection, // Set by site admin see settings.php.\n                userId,\n                fitTilesToWidth,\n                useWindowOverlay,\n                pageType,\n                allowPhotoTiles,\n                useSubTiles,\n                areConvertingLabel,\n                documentationurl\n            ) {\n                courseId = courseIdInit;\n                // Some args are strings or ints but we prefer bool.  Change to bool now as they are passed on elsewhere.\n                assumeDataStoreConsent = assumeDataStoreConsent === \"1\";\n                // This is also called from lib.php, via edit_form_helper, if user is on course/edit.php or editsection.php.\n                require(['format_tiles/edit_icon_picker'], function(iconPicker) {\n                    iconPicker.init(courseId, pageType, allowPhotoTiles, documentationurl);\n                });\n\n                if (useSubTiles) {\n                    require(['format_tiles/edit_course_mod'], function (editCourseMod) {\n                        editCourseMod.init(\n                            courseId,\n                            sectionNum,\n                            areConvertingLabel\n                        );\n                    });\n                }\n\n                $(document).ready(function() {\n                    $(Selector.TILE_BAR_TEXT).on(Event.KEYDOWN, function(e) {\n                        if (e.keyCode === Keyboard.RETURN && !$(e.target).hasClass('form-control')) {\n                            // Return key has been pressed and *not* while the user was inplace editing the title.\n                            window.location = config.wwwroot + '/course/view.php?id=' + courseId\n                                + '&section=' + $(e.currentTarget).parent().attr(DataAttributes.SECTION);\n                        }\n                    });\n\n                    // If the user preference is for JS off, or site admin has disabled, or user is mobile, no JS nav.\n                    if (useJavascriptNav && !isMobile) {\n                        var collapsingAllSectionFromURL = (window.location.search).indexOf(\"expanded=-1\") !== -1;\n                        var finalSectionInCourse = $(Selector.SECTION_MAIN).last().attr(\"data-section\");\n                        browserStorageEdit.init(\n                            userId,\n                            courseId,\n                            maxContentSectionsToStore,\n                            storedContentDeleteMins,\n                            assumeDataStoreConsent,\n                            finalSectionInCourse,\n                            collapsingAllSectionFromURL\n                        );\n                    }\n\n                    if (!isMobile) {\n                        // Initialise tooltips shown for example when hover over tile icon \"Click to change icon\".\n                        // But not on mobile as they make clicks harder.\n                        var toolTips = $(\"[data-toggle=tooltip]\");\n                        if (toolTips.length !== 0) {\n                            try {\n                                toolTips.tooltip();\n                            } catch (err) {\n                                require([\"core/log\"], function(log) {\n                                    log.debug(err);\n                                });\n                            }\n                        }\n                    }\n\n                    // We don't want to re-implement show/hide sections, so we let core handle it.\n                    // Core will re-render all activties when it hides section, and they will be in non subtiles form.\n                    // So we just delete them and can add them back when we un-hide or expand.\n                    $('body').on('click keypress', Selector.SECTION_MAIN + ' ' +\n                        Selector.SECTIONACTIONMENU + '[data-sectionid] ' +\n                        'a[data-action]', function(e) {\n                            var target = $(e.target).closest(Selector.MENU_ACTION);\n                            var sectionMain = target.closest(Selector.SECTION_MAIN);\n                            if (target.attr(\"data-action\") === \"hide\" || target.attr(\"data-action\") === \"show\") {\n                                // If teacher has clicked \"show\" we still collapse sec to hide the core change - they can re-expand.\n                                collapseSectionFromSecNum(sectionMain.attr(\"data-section\"));\n                                sectionMain.find(Selector.SECTION).find(Selector.ACTIVITY).slideUp(300).remove();\n                            }\n                        });\n                });\n            }\n        };\n    }\n);"],"names":["define","$","config","str","ajax","browserStorageEdit","Selector","EDITING_COLLAPSE_SECID","EDITING_COLLAPSE_SEC","EDITING_EXPAND_SEC","EDITING_EXPAND_SECID","ACTIVITY","SECTION_ID","TILE_TITLE","TILE_BAR_TEXT","SECTION","SECTION_MAIN","DNDUPLOAD_HIDDEN","ACTIVITYACTION","ACTIONAREA","EXPAND_ALL_BTNS","EXPAND_COLLAPSE_SEC","EDIT_TITLE_PENCIL","ICON_PICKER_BTN","TILE_BAR","SECTIONACTIONMENU","MENU_ACTION","Keyboard","ESCAPE","TAB","RETURN","Event","CLICK","KEYDOWN","SCROLL","DataAttributes","ORIG_TITLE","courseId","collapseSectionFromSecNum","secNum","section","animate","opacity","find","slideUp","addClass","removeClass","fadeOut","setSectionStatus","init","courseIdInit","useJavascriptNav","maxContentSectionsToStore","isMobile","sectionNum","storedContentExpirySecs","storedContentDeleteMins","useFilterButtons","assumeDataStoreConsent","reopenLastSection","userId","fitTilesToWidth","useWindowOverlay","pageType","allowPhotoTiles","useSubTiles","areConvertingLabel","documentationurl","require","iconPicker","editCourseMod","document","ready","on","e","keyCode","target","hasClass","window","location","wwwroot","currentTarget","parent","attr","collapsingAllSectionFromURL","indexOf","finalSectionInCourse","last","toolTips","length","tooltip","err","log","debug","closest","sectionMain","remove"],"mappings":"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"}