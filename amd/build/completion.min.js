define(["jquery","core/templates","core/config","format_tiles/completion"],function($,Templates,config){"use strict";var courseId;var strings={};var dataKeys={cmid:"data-cmid",numberComplete:"data-numcomplete",numberOutOf:"data-numoutof",section:"data-section"};var Selector={launchModuleModal:'[data-action="launch-tiles-module-modal"]',launchResourceModal:'[data-action="launch-tiles-resource-modal"]',pageContent:"#page-content",regionMain:"#region-main",resourceModule:".activity.resource",completeonevent:".completeonevent",completeonview:".completeonview",activity:"li.activity",section:"li.section.main",togglecompletion:"form.togglecompletion"};var Icon={completionYes:"completion-icon-y",completionNo:"completion-icon-n"};var noCompletionTrackingMods=[];var progressTemplateData=function(tileId,numComplete,outOf,asPercent){var data={tileid:tileId,numComplete:numComplete,numOutOf:outOf,showAsPercent:asPercent,percent:Math.round(numComplete/outOf*100),percentCircumf:106.8,percentOffset:Math.round((outOf-numComplete)/outOf*106.8),isComplete:false,isSingleDigit:false};if(tileId===0){data.isOverall=1}else{data.isOverall=0}if(numComplete>=outOf){data.isComplete=true}if(data.percent<10){data.isSingleDigit=true}return data};var changeProgressIndicators=function(sectionNum,tileProgressIndicator,progressChange){if(tileProgressIndicator.attr(dataKeys.numberComplete)===0&&progressChange<0){return}var newTileProgressValue=Math.min(parseInt(tileProgressIndicator.attr(dataKeys.numberComplete))+progressChange,tileProgressIndicator.attr(dataKeys.numberOutOf));var overallProgressIndicator=$("#tileprogress-0");var newOverallProgressValue=Math.min(parseInt(overallProgressIndicator.attr(dataKeys.numberComplete))+progressChange,overallProgressIndicator.attr(dataKeys.numberOutOf));Templates.render("format_tiles/progress",progressTemplateData(sectionNum,newTileProgressValue,tileProgressIndicator.attr(dataKeys.numberOutOf),tileProgressIndicator.hasClass("percent"))).done(function(html){tileProgressIndicator.replaceWith(html);$("#tileprogress-"+sectionNum).tooltip()});Templates.render("format_tiles/progress",progressTemplateData(0,newOverallProgressValue,overallProgressIndicator.attr(dataKeys.numberOutOf),true)).done(function(html){$("#tileprogress-0").replaceWith(html).fadeOut(0).animate({opacity:1},500)})};var toggleCompletionTiles=function(form){var cmid=form.attr(dataKeys.cmid);var completionState=$("#completionstate_"+cmid);var data={id:cmid,completionstate:parseInt(completionState.attr("value")),fromajax:1,sesskey:config.sesskey};form.tooltip("hide");var url=config.wwwroot+"/course/togglecompletion.php";$.post(url,data,function(returnData,status){if(status==="success"&&returnData==="OK"){var progressChange;var completionImage=$(".completion_img_"+cmid);if(completionState.attr("value")==="1"){$("#completion_dynamic_change").attr("value",0);completionState.attr("value",0);progressChange=+1;completionImage.addClass(Icon.completionYes).removeClass(Icon.completionNo);$(".complete-y-"+cmid).fadeIn(200).fadeOut(1e3)}else{$("#completion_dynamic_change").attr("value",1);completionState.attr("value",1);progressChange=-1;$(".complete-n-"+cmid).fadeIn(200).fadeOut(1e3);completionImage.addClass(Icon.completionNo).removeClass(Icon.completionYes)}if(!completionState.closest(Selector.activity).is(noCompletionTrackingMods.map(function(cls){return"."+cls}).join(","))){changeProgressIndicators(form.attr(dataKeys.section),$("#tileprogress-"+form.attr(dataKeys.section)),progressChange);require(["format_tiles/browser_storage"],function(storage){storage.storeCourseContent(courseId,form.attr("data-section"),"")})}}}).fail(function(){throw new Error("Failed to register completion change with server")})};var markAsAutoCompleteInUI=function(activity){var sectionNum=activity.closest(Selector.section).attr("data-section");if(activity.hasClass("completeonview")){var completionIcon=activity.find(".completion-icon");var parent=completionIcon.closest(".completioncheckbox");if(parent.attr("data-ismanual")==="0"&&parent.attr("data-completionstate")==="0"){completionIcon.addClass(Icon.completionYes).removeClass(Icon.completionNo);parent.attr("data-completionstate",1);parent.attr("data-original-title",strings.completeauto);parent.tooltip();changeProgressIndicators(sectionNum,$("#tileprogress-"+sectionNum),1)}}require(["format_tiles/browser_storage"],function(storage){storage.storeCourseContent(courseId,sectionNum,"")})};return{init:function(courseIdInit,strCompleteAuto,labelLikeCourseMods){courseId=courseIdInit;$(document).ready(function(){noCompletionTrackingMods=JSON.parse(labelLikeCourseMods);strings.completeauto=strCompleteAuto;$("body").on("click",Selector.togglecompletion,function(e){e.preventDefault();toggleCompletionTiles($(e.currentTarget))});var pageContent=$("#page-content");if(pageContent.length===0){pageContent=$("#region-main")}pageContent.on("click",Selector.launchModuleModal+", "+Selector.launchResourceModal,function(e){var clickedActivity=$(e.currentTarget).closest(Selector.activity);if(clickedActivity.hasClass("completeonview")){markAsAutoCompleteInUI(clickedActivity)}});$(Selector.pageContent).on("click",Selector.completeonevent+", "+Selector.completeonview,function(e){var sectionNum=$(e.currentTarget).closest(Selector.section).attr("data-section");require(["format_tiles/browser_storage"],function(storage){storage.storeCourseContent(courseId,sectionNum,"")})})})},markAsAutoCompleteInUI:function(courseIdInit,activity){courseId=courseIdInit;markAsAutoCompleteInUI(activity)}}});
//# sourceMappingURL=completion.min.js.map