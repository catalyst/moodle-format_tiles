{"version":3,"sourceRoot":"..","sources":["server/course/format/tiles/amd/src/course.js"],"sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/* global setTimeout, document, window */\n/* eslint space-before-function-paren: 0 */\n\n/**\n * Main Javascript module for format_tiles for when user is *NOT* editing.\n * See course_edit for if they are editing.\n * Handles the UI changes when tiles are selected and anything else not\n * covered by the specific modules\n *\n * @module      format_tiles/course\n * @package     course/format\n * @subpackage  tiles\n * @copyright   2018 David Watson {@link http://evolutioncode.uk}\n * @license     http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\n\ndefine([\"jquery\", \"core/templates\", \"core/ajax\", \"format_tiles/browser_storage\",\n        \"core/notification\", \"core/str\", \"format_tiles/tile_fitter\", \"format_tiles/window_overlay\"],\n    function ($, Templates, ajax, browserStorage, Notification, str, tileFitter, windowOverlay) {\n        \"use strict\";\n\n        var body = $(\"body\");\n        var bodyHtml = $(\"body, html\");\n        var isMobile;\n        var loadingIconHtml;\n        var windowOverlayDiv = false; // Will change below if we are using it.\n        var stringStore = [];\n        var scrollFuncLock = false;\n        var sectionIsOpen = false;\n        var HEADER_BAR_HEIGHT = 60; // This varies by theme and version so will be reset once pages loads below.\n        var reopenLastVisitedSection = false;\n        var backDropZIndex = 0;\n        var courseId;\n        var resizeLocked = false;\n\n         // Keep a record of which tile is currently open.\n        var openTile = 0;\n\n        var Selector = {\n            PAGE: \"#page\",\n            TILE: \".tile\",\n            TILEID: \"#tile-\",\n            MOVEABLE_SECTION: \".moveablesection\",\n            FILTER_BUTTON: \".filterbutton\",\n            TILE_LOADING_ICON: \".tile-loading-icon\",\n            TILE_LOADING_ICON_ID: \"#loading-icon-\",\n            TILE_COLLAPSED: \".tile-collapsed\",\n            TILE_CLICKABLE: \".tile-clickable\",\n            TILES: \"ul.tiles\",\n            ACTIVITY: \".activity\",\n            SPACER: \".spacer\",\n            SECTION_MOVEABLE: \".moveablesection\",\n            SECTION_ID: \"#section-\",\n            SECTION_TITLE: \".sectiontitle\",\n            SECTION_MAIN: \".section.main\",\n            SECTION_BUTTONS: \"#sectionbuttons\",\n            CLOSE_SEC_BTN: \".closesectionbtn\",\n            HIDE_SEC0_BTN: \"#buttonhidesec0\",\n            SECTION_ZERO: \"#section-0\",\n            MOODLE_VIDEO: \".mediaplugin.mediaplugin_videojs\",\n            LAUNCH_STANDARD: '[data-action=\"launch-tiles-standard\"]',\n            TOOLTIP: \"[data-toggle=tooltip]\",\n            HEADER_BAR: [\"header.navbar\", \"nav.fixed-top.navbar\", \"#essentialnavbar.moodle-has-zindex\", \"#navwrap\",\n                \"nav.navbar-fixed-top\", \"#main-navbar\"]\n            // We try several different selectors for header bar as it varies between theme.\n            // (Boost based, clean based, essential etc).\n        };\n        var ClassNames = {\n            SELECTED: \"selected\",\n            HEADER_OVERLAY: \"header-overlay\",\n            OPEN: \"open\",\n            CLOSED: \"closed\",\n            LAUNCH_CM_MODAL: \"launch-tiles-cm-modal\",\n            STATE_VISIBLE: 'state-visible' // This is a Snap theme class and was added to make this format cooperate better with it.\n        };\n\n        var Event = {\n            CLICK: \"click\",\n            KEYDOWN: \"keydown\",\n            SCROLL: \"scroll\"\n        };\n\n        var CSS = {\n            DISPLAY: \"display\",\n            Z_INDEX: \"z-index\",\n            HEIGHT: \"height\",\n            BG_COLOUR: \"background-color\"\n        };\n        var Keyboard = {\n            ESCAPE: 27,\n            TAB: 9,\n            RETURN: 13\n        };\n\n        /**\n         * If we have embedded video in section, stop it.\n         * Runs when section is closed.\n         * @param {number} section where the video is.\n         */\n        var stopVideoPlaying = function(section) {\n            var contentSection = $(Selector.SECTION_ID + section);\n\n            // First iframes (e.g. embedded YouTube).\n            contentSection.find(\"iframe\").each(function (index, iframe) {\n                iframe = $(iframe);\n                // Remove the src from the iframe but keep it in case the section is re-opened.\n                iframe.attr('data-src', iframe.attr(\"src\"));\n                iframe.attr('src', \"\");\n            });\n\n            // Then Moodle media player.\n            var mediaPlayers = contentSection.find(Selector.MOODLE_VIDEO);\n            if (mediaPlayers.length > 0) {\n                contentSection.html(\"\");\n            }\n        };\n\n        /**\n         * When JS navigation is being used, when a user un-selects a tile, we have to move the tile's z-index back so that it is\n         * no longer on top of the overlay, as well as removing its \"selected\" class, and hiding the overlay\n         * @param {number} sectionToFocus if we want to focus a tile after closing, which one\n         */\n        var cancelTileSelections = function (sectionToFocus) {\n            $(Selector.MOVEABLE_SECTION).each(function (index, sec) {\n                sec = $(sec);\n                if (sec.is(\":visible\")) {\n                    stopVideoPlaying(sec.attr(\"data-section\"));\n                    sec.slideUp().removeClass(ClassNames.STATE_VISIBLE); // Excludes section 0.\n                }\n            });\n            $(Selector.TILE).removeClass(ClassNames.SELECTED).css(CSS.Z_INDEX, \"\").css(CSS.BG_COLOUR, \"\");\n            $(\".section \" + ClassNames.SELECTED).removeClass(ClassNames.SELECTED).css(CSS.Z_INDEX, \"\");\n            if (windowOverlayDiv) {\n                windowOverlay.fadeOut(300);\n            } else {\n                $(Selector.TILE).removeClass(\"faded\");\n            }\n\n            if (sectionToFocus !== undefined && sectionToFocus !== 0) {\n                $(Selector.TILEID + sectionToFocus).focus();\n            }\n            $(Selector.TILE_LOADING_ICON).fadeOut(300, function () {\n                $(Selector.TILE_LOADING_ICON).html(\"\");\n            });\n            sectionIsOpen = false;\n            openTile = 0;\n        };\n\n        /**\n         * Set the HTML for a course section to the correct div in the page\n         * @param {Object} contentArea the jquery object for the content area\n         * @param {String} content the HTML\n         * @returns {boolean} success\n         */\n        var setCourseContentHTML = function (contentArea, content) {\n            if (content) {\n                contentArea.html(content);\n                $(Selector.TILE_LOADING_ICON).fadeOut(300, function () {\n                    $(Selector.TILE_LOADING_ICON).html(\"\");\n                });\n\n                if (contentArea.attr(\"id\") !== Selector.SECTION_ZERO) {\n                    // Trap the tab key navigation in the content bearing section.\n                    // Until the user clicks the close button.\n                    // When user reaches last item, send them back to first.\n                    // And vice versa if going backwards.\n\n                    var activities = contentArea.find(Selector.ACTIVITY).not(Selector.SPACER);\n                    contentArea.on(Event.KEYDOWN, function (e) {\n                        if (e.keyCode === Keyboard.ESCAPE) {\n                            // Close open tile, and return focus to closed tile, for screen reader user.\n                            browserStorage.setLastVisitedSection(0);\n                            cancelTileSelections(0);\n                            $(Selector.TILEID + contentArea.attr('data-section')).focus();\n                        }\n                    });\n                    activities.on(Event.KEYDOWN, function (e) {\n                        if (e.keyCode === Keyboard.RETURN) {\n                            var toClick = $(e.currentTarget).find(\"a\");\n                            if (toClick.hasClass(ClassNames.LAUNCH_CM_MODAL)) {\n                                toClick.click();\n                            } else if (toClick.attr(\"href\") !== undefined) {\n                                window.location = toClick.attr(\"href\");\n                            }\n                        }\n                    });\n                    if (!isMobile) {\n                        activities.last().on(Event.KEYDOWN, function (e) {\n                            if (e.keyCode === Keyboard.TAB && !e.shiftKey\n                                    && $(e.relatedTarget).closest(Selector.SECTION_MAIN).attr(\"id\") !== contentArea.attr(\"id\")) {\n                                // RelatedTarget is the item we tabbed to.\n                                // If we reached here, the item we are on is not a member of the section we were in.\n                                // (I.e. we are trying to tab out of the bottom of section) so move tab back to first item instead.\n                                setTimeout(function () {\n                                    // Allow very short delay so we dont skip forward on the basis of our last key press.\n                                    contentArea.find(Selector.SECTION_TITLE).focus();\n                                    bodyHtml.animate({scrollTop: contentArea.offset().top - HEADER_BAR_HEIGHT}, \"slow\");\n                                    contentArea.find('#sectionbuttons').css(\"top\", \"\");\n                                }, 200);\n                            }\n                        });\n                        contentArea.find(Selector.SECTION_TITLE).on(Event.KEYDOWN, function (e) {\n                            if (e.keyCode === Keyboard.TAB && e.shiftKey\n                                    && $(e.relatedTarget).closest(Selector.SECTION_MAIN).attr(\"id\") !== contentArea.attr(\"id\")) {\n                                // See explanation previous block.\n                                // Here we are trying to tab backwards out of the top of our section.\n                                // So take us to last item instead.\n                                setTimeout(function () {\n                                    activities.last().focus();\n                                }, 200);\n                            }\n                        });\n                    }\n                }\n\n                if (!isMobile) {\n                    // Activate tooltips for completion toggle and any \"restricted\" items in this content.\n                    setTimeout(function () {\n                        // Manual forms, auto icons and \"Restricted until ...\" etc.\n                        try {\n                            contentArea.find(\".togglecompletion, .completioncheckbox, .tag-info\").tooltip();\n                        } catch (err) {\n                            require([\"core/log\"], function(log) {\n                                log.debug(err);\n                            });\n                        }\n                    }, 500);\n                }\n                // As we have just loaded new content, ensure that we initialise videoJS media player if required.\n                if (contentArea.find(Selector.MOODLE_VIDEO).length !== 0) {\n                    require([\"media_videojs/loader\"], function(videoJS) {\n                        videoJS.setUp();\n                    });\n                }\n\n                return true;\n            }\n            return false;\n        };\n\n        /**\n         * Expand a content containing section (e.g. on tile click)\n         * @param {object} contentArea\n         * @param {number} tileId to expand\n         */\n        var expandSection = function (contentArea, tileId) {\n            var expandAndScroll = function () {\n                // Scroll to the top of content bearing section\n                // we have to wait until possible reOrg and slide down totally before calling this, else co-ords are wrong.\n                var scrollTo = $(\"#tileText-\" + tileId).offset().top - HEADER_BAR_HEIGHT;\n                if (scrollTo === $(window).scrollTop) {\n                    // Scroll by at least one pixel otherwise z-index on selected tile is not changed.\n                    // Until mouse moves.\n                    scrollTo += 1;\n                }\n                contentArea.find(Selector.SECTION_TITLE).focus();\n                // If user tries to scroll during animation, stop animation.\n                var events = \"scroll mousedown wheel DOMMouseScroll mousewheel keyup touchmove\";\n                body.on(events, function () {\n                    body.stop();\n                });\n\n                bodyHtml.animate({scrollTop: scrollTo}, \"slow\", function () {\n                    // Animation complete, remove stop handler.\n                    bodyHtml.off(events, function () {\n                        bodyHtml.stop();\n                    });\n                });\n                sectionIsOpen = true;\n                openTile = tileId;\n\n                // For users with screen readers, move focus to the first item within the tile.\n                contentArea.find(Selector.ACTIVITY).first().focus();\n\n                // If we have any iframes in the section which were previous emptied out, re-populate.\n                // This will happen if we have previously closed a section with videos in, and they were muted.\n                contentArea.find(\"iframe\").each(function (index, iframe) {\n                    iframe = $(iframe);\n                    // If iframe has no src, add it from data-src.\n                    if (iframe.attr('src') === '' && iframe.attr('data-src') !== undefined) {\n                        iframe.attr('src', iframe.attr(\"data-src\"));\n                    }\n                });\n            };\n\n            /**\n             * Make sure that the section close and edit buttons always appear at the top of the section on scroll\n             */\n            var holdSectionButtonPosition = function () {\n                var buttons = contentArea.find(Selector.SECTION_BUTTONS);\n                $(window).on(Event.SCROLL, function () {\n                    if (!scrollFuncLock && sectionIsOpen) {\n                        scrollFuncLock = true;\n                        buttons.fadeOut(300);\n                        setTimeout(function () {\n                            var windowTop = $(window).scrollTop();\n                            var desiredNewPositionInSection = (windowTop - contentArea.offset().top + 50);\n                            if (desiredNewPositionInSection > 0\n                                    && desiredNewPositionInSection < contentArea.outerHeight() - 100) {\n                                desiredNewPositionInSection = (windowTop - contentArea.offset().top + 50);\n                                buttons.css(\"top\", desiredNewPositionInSection);\n                                if (windowOverlayDiv) {\n                                    windowOverlay.fadeIn();\n                                }\n                            } else if (desiredNewPositionInSection < 0) {\n                                buttons.css(\"top\", 0);\n                            }\n                            if (windowTop > contentArea.offset().top + contentArea.outerHeight() - 50) {\n                                // We have scrolled down and content bottom has gone out of the top of window.\n                                if (windowOverlayDiv) {\n                                    windowOverlay.fadeOut();\n                                }\n                                buttons.css(\"top\", 0);\n                            } else if (contentArea.offset().top > windowTop + $(window).outerHeight()) {\n                                // We have scrolled up and  content bottom has gone out of the bottom of window.\n                                if (windowOverlayDiv) {\n                                    windowOverlay.fadeOut();\n                                }\n                                buttons.css(\"top\", 0);\n                            } else {\n                                if (windowOverlayDiv) {\n                                    windowOverlay.fadeIn();\n                                }\n                            }\n                            buttons.fadeIn(300, function () {\n                                // Release lock on this function.\n                                scrollFuncLock = false;\n                            });\n                        }, 500);\n                    }\n                });\n                if (!scrollFuncLock && !sectionIsOpen && windowOverlay && windowOverlay.isVisible()) {\n                    windowOverlay.fadeOut();\n                }\n            };\n\n            contentArea.addClass(ClassNames.STATE_VISIBLE);\n            contentArea.slideDown(350, function () {\n                // Wait until we have finished sliding down before we work out where the top is for scroll.\n                expandAndScroll();\n                holdSectionButtonPosition();\n            });\n            openTile = tileId;\n        };\n\n        /**\n         * We find out what section is open, collapse them all, then run the re-org.\n         * Finally we re-open the section.\n         * This is to ensure that the content bearing section is on the row under the tile clicked.\n         * It is run at page load and again if window is re-sized etc.\n         * @param {boolean} delayBefore do we want a delay before we re-org.  This allows e.g. browser resizing to complete.\n         * @param {boolean} fitTilesToScreenWidth whether we need to resize the tiles window while tiles are closed.\n         * @returns {Promise}\n         */\n        var reOrgSections = function (delayBefore, fitTilesToScreenWidth) {\n            var dfd = new $.Deferred();\n            var openedSection = $(\".moveablesection:visible\");\n            var openedSectionNum = 0;\n            if (openedSection.length > 0) {\n                openedSectionNum = openedSection.attr(\"data-section\");\n                cancelTileSelections();\n            }\n            var reOrgFunc = function(delayBefore) {\n                tileFitter.runReOrg(delayBefore)\n                    .done(function(result) {\n                        if (openedSectionNum !== 0) {\n                            expandSection(openedSection, openedSectionNum);\n                        }\n                        dfd.resolve(result);\n                    })\n                    .fail(function(result) {\n                        if (openedSectionNum !== 0) {\n                            expandSection(openedSection, openedSectionNum);\n                        }\n                        dfd.reject(result);\n                    });\n            };\n\n            if (fitTilesToScreenWidth) {\n                setTimeout(function() {\n                    tileFitter.resizeTilesDivWidth(courseId).done(function() {\n                        reOrgFunc(false);\n                    }, delayBefore);\n                });\n\n            } else {\n                reOrgFunc(delayBefore);\n            }\n            return dfd.promise();\n        };\n\n        var failedLoadSectionNotify = function(sectionNum, failResult, contentArea) {\n            if (failResult) {\n                // Notify the user and invite them to refresh.  We did get a \"failResult\" from server,\n                // So it looks like we do have a connection and can launch this.\n                Notification.confirm(\n                    stringStore.sectionerrortitle,\n                    stringStore.sectionerrorstring,\n                    stringStore.refresh,\n                    stringStore.cancel,\n                    function () {\n                        window.location.reload();\n                    },\n                    null\n                );\n                contentArea.html(\"\"); // Clear loading icon.\n            } else {\n                // It looks like we may not have a connection so we can't launch notifications.\n                // We can warn the user like this instead.\n                setCourseContentHTML(contentArea, \"<p>\" + stringStore.noconnectionerror + \"</p>\");\n                setTimeout(function () {\n                    expandSection(contentArea, sectionNum);\n                }, 500);\n            }\n            require([\"core/log\"], function(log) {\n                log.debug(failResult);\n            });\n            throw new Error(\"Not successful retrieving tile content by AJAX for section \" + sectionNum);\n        };\n\n        /**\n         * For a given section, get the content from the server, add it to the store and maybe UI and maybe show it\n         * @param {number} courseId the id for the affected course\n         * @param {number} sectionNum the section number we are wanting to populate\n         * @return {Promise} promise to resolve when the ajax call returns.\n         */\n        var getSectionContentFromServer = function (courseId, sectionNum) {\n            return ajax.call([{\n                methodname: \"format_tiles_get_single_section_page_html\",\n                args: {\n                    courseid: courseId,\n                    sectionid: sectionNum,\n                    setjsusedsession: true\n                }\n            }])[0];\n        };\n\n        /**\n         * Used where the user clicks the window overlay but we want the active click to be behind the\n         * overlay e.g. the tile or custom menu item behind it.  So we get the co-ordinates of the click\n         * on the overlay and then repeat the click at that spot ignoring the overlay\n         * @param {object} e the click event object\n         */\n        var clickItemBehind = function (e) {\n            var clickedItem = $(e.currentTarget);\n            if (clickedItem.attr(\"id\") === \"window-overlay\" || clickedItem.attr(\"id\") === ClassNames.HEADER_OVERLAY) {\n                // We need to know what is behind the modal, so hide it for an instant to find out.\n                clickedItem.hide();\n                var BottomElement = $(document.elementFromPoint(e.clientX, e.clientY));\n                clickedItem.show();\n                if (clickedItem.attr(\"id\") === \"window-overlay\") {\n                    if (BottomElement.hasClass(\"filterbutton\") || BottomElement.hasClass(\"list-group-item\")) {\n                        // Must ba a filter button clicked or a nav drawer item.\n                        BottomElement.click();\n                    } else {\n                        // Must be a tile clicked.\n                        var clickedTile = BottomElement.closest(Selector.TILE);\n                        if (clickedTile) {\n                            clickedTile.click();\n                        }\n                    }\n                } else {\n                    // Must be a click on the header bar.\n                    cancelTileSelections(0);\n                    BottomElement.click();\n                }\n            }\n        };\n\n        /**\n         * If the user had section zero collapsed in this course previously, collapse it now\n         */\n        var setSectionZeroFromUserPref = function () {\n            var buttonHideSecZero = $(Selector.HIDE_SEC0_BTN);\n            var sectionZero = $(Selector.SECTION_ZERO);\n            if (browserStorage.storageEnabledLocal()) {\n                // Collapse section zero if user had it collapsed before - relies on local storage so only if enabled.\n                if (browserStorage.getSecZeroCollapseStatus() === true) {\n                    sectionZero.slideUp(0);\n                    buttonHideSecZero.addClass(ClassNames.CLOSED).removeClass(ClassNames.OPEN); // Button image.\n                } else {\n                    sectionZero.slideDown(300);\n                    buttonHideSecZero.addClass(ClassNames.OPEN).removeClass(ClassNames.CLOSED); // Button image.\n                }\n            } else {\n                // Storage not available so we dont know if sec zero was previously collapsed - expand it.\n                buttonHideSecZero.addClass(ClassNames.OPEN).removeClass(ClassNames.CLOSED);\n                sectionZero.slideDown(300);\n            }\n        };\n\n        /**\n         * To be called when a tile is clicked. Get content from server or storage and display or store it.\n         * @param {number} courseId courseId the id of this course.\n         * @param {object} thisTile jquery the tile object clicked.\n         * @param {number} dataSection the id number of the tile.\n         * @param {number} storedContentExpirySecs\n         */\n        var populateAndExpandSection = function(courseId, thisTile, dataSection, storedContentExpirySecs) {\n            if (windowOverlayDiv) {\n                windowOverlay.set(dataSection);\n            } else {\n                $(Selector.TILE).addClass(\"faded\");\n                thisTile.removeClass(\"faded\");\n            }\n            $(Selector.TILE).removeClass(ClassNames.SELECTED);\n            thisTile.addClass(ClassNames.SELECTED);\n            openTile = dataSection;\n            // Then close all open secs.\n            // Timed to finish in 200 so that it completes well before the opening next.\n            $(Selector.MOVEABLE_SECTION).each(function (index, sec) {\n                sec = $(sec);\n                if (sec.is(\":visible\")) {\n                    stopVideoPlaying(sec.attr(\"data-section\"));\n                    sec.slideUp(200).removeClass(ClassNames.STATE_VISIBLE); // Excludes section 0.\n                }\n            });\n            // Log the fact we viewed the section.\n            ajax.call([{\n                methodname: \"format_tiles_log_tile_click\", args: {\n                    courseid: courseId,\n                    sectionid: dataSection\n                }\n            }])[0].fail(Notification.exception);\n            // Get the content - use locally stored content first if available.\n            var relatedContentArea = $(Selector.SECTION_ID + dataSection);\n            if (relatedContentArea.find(Selector.ACTIVITY).length > 0) {\n                // There is already some content on the screen so display immediately.\n                expandSection(relatedContentArea, dataSection);\n                // Then refresh the content in storage only but do not change on screen.\n                if (browserStorage.getStoredContentAge(courseId, dataSection) > storedContentExpirySecs\n                || !browserStorage.getStoredContentAge(courseId, dataSection)) {\n                    // If stored content is old, replace it.\n                    getSectionContentFromServer(courseId, dataSection).done(function (response) {\n                        if (browserStorage.storageEnabledSession()) {\n                            browserStorage.storeCourseContent(courseId, dataSection, $(response.html).html());\n                        }\n                    });\n                }\n            } else {\n                relatedContentArea.html(loadingIconHtml);\n                if (browserStorage.storageEnabledLocal()) {\n                    var contentAge = browserStorage.getStoredContentAge(courseId, dataSection);\n                    if (contentAge) {\n                        // We have some stored content so display it even if it's expired.\n                        setCourseContentHTML(\n                            relatedContentArea,\n                            browserStorage.getCourseContent(courseId, dataSection)\n                        );\n                        expandSection(relatedContentArea, dataSection);\n                    }\n                    if (!contentAge || contentAge > storedContentExpirySecs) {\n                        // Content in local storage may not exist or have expired.\n                        // If so, get it again from server and display new content on receipt.\n                        var loadingIcon = $(Selector.TILE_LOADING_ICON_ID + dataSection);\n                        if (loadingIcon !== undefined) {\n                            loadingIcon.html(loadingIconHtml).fadeIn(200);\n                        } else {\n                            loadingIcon = $(\"<div>\").html(loadingIconHtml);\n                            relatedContentArea.html(loadingIcon);\n                        }\n                        getSectionContentFromServer(courseId, dataSection).done(function (response) {\n                            var contentToDisplay = $(response.html).html();\n                            setCourseContentHTML(relatedContentArea, contentToDisplay);\n                            expandSection(relatedContentArea, dataSection);\n                            if (browserStorage.storageEnabledSession()) {\n                                browserStorage.storeCourseContent(courseId, dataSection, contentToDisplay);\n                            }\n                        }).fail(function (failResult) {\n                            failedLoadSectionNotify(dataSection, failResult, relatedContentArea);\n                            cancelTileSelections(dataSection);\n                        });\n                    }\n                } else {\n                    // Not using storage so get from server.\n                    getSectionContentFromServer(courseId, dataSection).done(function (response) {\n                        setCourseContentHTML(relatedContentArea, $(response.html).html());\n                        expandSection(relatedContentArea, dataSection);\n                    }).fail(function (failResult) {\n                        failedLoadSectionNotify(dataSection, failResult, relatedContentArea);\n                        cancelTileSelections(dataSection);\n                    });\n                }\n            }\n            browserStorage.setLastVisitedSection(dataSection);\n        };\n\n        return {\n            init: function (\n                courseIdInit,\n                useJavascriptNav, // Set by site admin see settings.php.\n                maxContentSectionsToStore, // Set by site admin see settings.php.\n                isMobileInit,\n                sectionNum,\n                storedContentExpirySecs, // Set by site admin see settings.php.\n                storedContentDeleteMins, // Set by site admin see settings.php.\n                useFilterButtons,\n                assumeDataStoreConsent, // Set by site admin see settings.php.\n                reopenLastSectionInit, // Set by site admin see settings.php.\n                userId,\n                fitTilesToWidth,\n                useWindoOverlay\n            ) {\n                courseId = courseIdInit;\n                isMobile = isMobileInit;\n                // Some args are strings or ints but we prefer bool.  Change to bool now as they are passed on elsewhere.\n                reopenLastVisitedSection = reopenLastSectionInit === \"1\";\n                useFilterButtons = useFilterButtons === 1;\n                assumeDataStoreConsent = assumeDataStoreConsent === \"1\";\n                 // We want to initialise the browser storage JS module for storing user settings.\n                 // And (depending on maxContentSectionsToStore) possibly also content in browser.\n                browserStorage.init(\n                    courseId,\n                    maxContentSectionsToStore,\n                    false,\n                    sectionNum,\n                    storedContentDeleteMins,\n                    assumeDataStoreConsent,\n                    userId\n                );\n                $(document).ready(function () {\n                    var pageContent = $(\"#page-content\");\n                    if (pageContent.length === 0) {\n                        // Some themes e.g. RemUI do not have a #page-content div, so use #region-main.\n                        pageContent = $(\"#region-main\");\n                    }\n\n                    // If we are being told to launch a section number from the URL, use that.\n                    if (sectionNum !== 0) {\n                        openTile = sectionNum;\n                    } else {\n                        // Don't use the URL param - check local storage instead.\n                        if (reopenLastVisitedSection && browserStorage.storageEnabledLocal) {\n                            openTile = browserStorage.getLastVisitedSection();\n                            // If user is not on mobile, retrieve last visited section id from browser storage (if present).\n                            // And click it.\n                        }\n                    }\n                    if (openTile !== 0) {\n                        tileFitter.init(courseId, openTile, fitTilesToWidth, false);\n                    } else {\n                        // Set focus to the first tile (not section zero).\n                        $(Selector.TILEID + \"1\").focus();\n                        tileFitter.init(courseId, null, fitTilesToWidth, false);\n                    }\n                    var windowWidth = $(window).outerWidth();\n\n                    if (useJavascriptNav) {\n                        // User is not editing but is usingJS nav to view.\n\n                        if (useWindoOverlay) {\n                            windowOverlayDiv = windowOverlay.getWindowOverlay();\n                            // If user clicks the window overlay behind the visible tile content, deselect tile.\n                            // (They want to remove the overlay).\n                            windowOverlayDiv.click(function (e) {\n                                cancelTileSelections(0);\n                                clickItemBehind(e);\n                            });\n                        }\n\n                         // On a tile click, decide what to do an do it.\n                         // (Collapse if already expanded, or expand it and fill with content).\n                        pageContent.on(Event.CLICK, Selector.TILE_CLICKABLE, function (e) {\n                            // Prevent the link being followed to reload the PHP page as we are using JS instead.\n                            if (!useJavascriptNav) {\n                                return;\n                            }\n                            e.preventDefault();\n                            $(window).off(Event.SCROLL); // Stop listening for scroll events on ay previously opened tiles.\n                            // if other tiles have loading icons, fade them out (on the tile not the content sec).\n                            $(Selector.TILE_LOADING_ICON).fadeOut(300, function () {\n                                $(Selector.TILE_LOADING_ICON).html();\n                            });\n                            var thisTile = $(e.currentTarget).closest(Selector.TILE);\n                            var dataSection = parseInt(thisTile.attr(\"data-section\"));\n                            if (thisTile.hasClass(ClassNames.SELECTED)) {\n                                // This tile is already expanded so collapse it.\n                                cancelTileSelections(dataSection);\n                                browserStorage.setLastVisitedSection(0);\n                            } else {\n                                populateAndExpandSection(\n                                    courseId, thisTile, dataSection, storedContentExpirySecs\n                                );\n                            }\n                            // Silently set the *next* section's content to if it exists and if user is not on mobile.\n                            // short delay as more important to get current section content first (above).\n                            var nextSecIfExists = $(Selector.SECTION_ID + (dataSection + 1));\n                            if (!isMobile && nextSecIfExists.length && dataSection > 0) {\n                                setTimeout(function () {\n                                    var storedContentAge = browserStorage.getStoredContentAge(courseId, dataSection + 1);\n                                    if (storedContentAge) {\n                                        // We have some stored content so set this to screen (even if expired).\n                                        setCourseContentHTML(\n                                            nextSecIfExists,\n                                            browserStorage.getCourseContent(courseId, dataSection + 1)\n                                        );\n                                    }\n                                    if (!storedContentAge || storedContentAge > storedContentExpirySecs) {\n                                        // Stored content is too old or does not exist so get from server.\n                                        getSectionContentFromServer(courseId, dataSection + 1).done(function(response) {\n                                            setCourseContentHTML(\n                                                nextSecIfExists,\n                                                $(response.html).html()\n                                            );\n                                            if (browserStorage.storageEnabledSession()) {\n                                                browserStorage.storeCourseContent(\n                                                    courseId, dataSection + 1, $(response.html).html()\n                                                );\n                                            }\n                                        });\n                                    }\n                                }, 2000);\n                            }\n                        });\n\n                        // When window is re-sized, content sections under the tiles may be in wrong place.\n                        // So remove them and re-initialise them.\n                        // Collapse the selected section before doing this.\n                        // Otherwise the re-organisation won't work as the tiles' flow will be out when they are analysed.\n                        $(window).on(\"resize\", function () {\n                            // On iOS resize events are triggered often on scroll because the address bar hides itself.\n                            // Avoid this using windowWidth here.\n                            if (resizeLocked || windowWidth === $(window).outerWidth()) {\n                                return;\n                            }\n                            resizeLocked = true;\n\n                            // We wait for a short time before doing anything, as user may still be dragging window size change.\n                            // We don't want to react to say 20 resize events happening over a single drag.\n                            setTimeout(function() {\n                                // First assume that we are going to resize, but we have checks to make below.\n                                var resizeRequired = true;\n\n                                // If we have a Moodle media player div in the section in fullscreen, ignore this resize event.\n                                // It was probably caused when user pressed the full screen button.\n                                var openContentSection = $(\".moveablesection:visible\");\n                                if (openContentSection.length !== 0) {\n                                    var mediaPlayers = openContentSection.find(\".mediaplugin iframe\");\n                                    if (mediaPlayers.length !== 0) {\n                                        mediaPlayers.each(function (index, player) {\n                                            player = $(player);\n                                            if (player.outerWidth() > openContentSection.outerWidth()) {\n                                                // Video is present and playing full screen so don't react to resize event.\n                                                resizeRequired = false;\n                                            }\n                                        });\n                                    }\n                                }\n                                if (resizeRequired) {\n                                    // Set global for comparison next time.\n                                    windowWidth = $(window).outerWidth();\n                                    reOrgSections(true, fitTilesToWidth);\n                                }\n                                resizeLocked = false;\n                            }, 600);\n                        });\n\n                        if (useWindoOverlay) {\n                            // We want the main menu at the top to be on top of the tiles.\n                            // Even the ones which we have brought to the front on top of the window overlay.\n                            // But we also want it to still be greyed out.  So add an opaque overlay.\n                            // We can show this when the main overlay is active.\n                            // When a user clicks this overlay, they want to close the overlay and click menu item behind.\n                            // So provide for that here.\n                            // Z-INDICES: active tile will be at overlayZindex + 1.\n                            // Header bar will be at overlayZindex + 2 so that it is higher than tiles.\n                            // Header bar overlay will be at overlayZindex + 3 so that it is highest of all.\n\n                            var headerBar = $(Selector.HEADER_BAR.find(function(selector) {\n                                return $(selector).length > 0;\n                            }));\n\n                            if (headerBar !== undefined && headerBar.length !== 0) {\n                                HEADER_BAR_HEIGHT = headerBar.outerHeight();\n                                var headerBarOverlay = windowOverlay.getHeaderBarOverlay(headerBar);\n                                if (headerBarOverlay) {\n                                    headerBarOverlay.click(function (e) {\n                                        cancelTileSelections(0);\n                                        clickItemBehind(e);\n                                    });\n                                }\n                                headerBar.css(CSS.Z_INDEX, windowOverlay.getZIndex() + 2);\n                            } else {\n                                require([\"core/log\"], function(log) {\n                                    log.debug(\n                                        \"Failed to get navbar.  Ensure theme's navbar selector is included in global HEADER_BAR\"\n                                    );\n                                });\n                            }\n                        }\n\n                        // When user clicks to close a section using cross at top right in section.\n                        pageContent.on(Event.CLICK, Selector.CLOSE_SEC_BTN, function (e) {\n                            cancelTileSelections($(e.currentTarget).attr(\"data-section\"));\n                        });\n\n                        // If user clicks a sub tile body below the link, treat it as a click on the link itself.\n                        pageContent.on(Event.CLICK, Selector.LAUNCH_STANDARD, function(e) {\n                            var clickedLk = $(e.currentTarget);\n                            if (clickedLk.attr(\"href\") !== undefined) {\n                                window.location = clickedLk.attr(\"href\");\n                            } else if (clickedLk.find('a').attr(\"href\") !== undefined) {\n                                window.location = clickedLk.find('a').attr(\"href\");\n                            }\n                        });\n\n                        setSectionZeroFromUserPref();\n                        // Most filter button related JS is in filter_buttons.js module which is required below.\n\n                    }\n\n                    // When the user presses the button to collapse or expand Section zero (section at the top of the course).\n                    pageContent.on(Event.CLICK, Selector.HIDE_SEC0_BTN, function (e) {\n                        var sectionZero = $(Selector.SECTION_ZERO);\n                        if (sectionZero.css(CSS.DISPLAY) === \"none\") {\n                            // Sec zero is collapsed so expand it on user click.\n                            sectionZero.slideDown(250);\n                            $(e.currentTarget).addClass(ClassNames.OPEN).removeClass(ClassNames.CLOSED);\n                            browserStorage.setSecZeroCollapseStatus(\"collapsed\");\n                        } else {\n                            // Sec zero is expanded so collapse it on user click.\n                            sectionZero.slideUp(250);\n                            $(e.currentTarget).addClass(ClassNames.CLOSED).removeClass(ClassNames.OPEN);\n                            browserStorage.setSecZeroCollapseStatus(\"expanded\");\n                        }\n                    });\n\n                    if (useFilterButtons) {\n                        require([\"format_tiles/filter_buttons\"], function (filterButtons) {\n                            filterButtons.init(courseId, browserStorage.storageEnabledLocal);\n                        });\n                        if (useJavascriptNav) {\n                            pageContent.on(Event.CLICK, Selector.FILTER_BUTTON, function () {\n                                cancelTileSelections(0);\n                                reOrgSections(true, false);\n                            });\n                        }\n\n                    }\n                    // If theme is displaying the .tiles_coursenav class items, show items with this class.\n                    // They will be hidden otherwise.\n                    // They are hidden when initially rendered from PHP as we only want them shown if browser supports JS.\n                    // See lib.php extend_course_navigation.\n                    $(\".tiles_coursenav\").removeClass(\"hidden\");\n\n                    // Render the loading icon and store its HTML globally so that we can use it where needed later.\n                    Templates.render(\"format_tiles/loading\", {}).done(function (html) {\n                        loadingIconHtml = html;\n                    });\n\n                     // Get these strings now, in case we need them.\n                    // E.g. after we lose connection and cannot display content on a user tile click.\n                    var stringKeys = [\n                        {key: \"sectionerrortitle\", component: \"format_tiles\"},\n                        {key: \"sectionerrorstring\", component: \"format_tiles\"},\n                        {key: \"refresh\"},\n                        {key: \"cancel\"},\n                        {key: \"noconnectionerror\", component: \"format_tiles\"},\n                        {key: \"show\"},\n                        {key: \"hide\"},\n                        {key: \"other\", component: \"format_tiles\"},\n                        {key: \"blockedpopuptitle\", component: \"format_tiles\"}\n                    ];\n                    str.get_strings(stringKeys).done(function (s) {\n                        s.forEach(function(str, index) {\n                            stringStore[stringKeys[index].key] = str;\n                        });\n                    });\n\n                    // If a mobile user clicks an embedded video activity, we don't show them a modal.\n                    // It won't work well. Instead we direct them to the original site e.g. YouTube.\n                    if (isMobile) {\n                        pageContent.on(Event.CLICK, Selector.ACTIVITY + \".video a\", function(e) {\n                            var target = $(e.currentTarget);\n                            var url = target.closest(Selector.ACTIVITY).attr(\"data-url-secondary\");\n                            if (url !== undefined) {\n                                e.preventDefault();\n                                e.stopPropagation();\n                                var cm = target.closest(Selector.ACTIVITY);\n                                ajax.call([{\n                                    methodname: \"format_tiles_log_mod_view\", args: {\n                                        courseid: courseId,\n                                        cmid: cm.attr(\"data-cmid\")\n                                    }\n                                }])[0].done(function () {\n                                    // Because we intercepted the normal event for the click, process auto completion.\n                                    require([\"format_tiles/completion\"], function (completion) {\n                                        completion.markAsAutoCompleteInUI(courseId, cm);\n                                    });\n                                });\n                                window.location = url;\n                            }\n                        });\n                    } else {\n                        // If user is NOT on mobile device.\n\n                        // If return is pressed while an item is in focus, click the item.\n                        // This is to make the tiles keyboard navigable for users using screen readers.\n                        // User tabbing between tiles is handled by tabindex in the HTML.\n                        // Once the tile is clicked, the expand tile function will move focus to the first content item.\n                        // On escape key, we clear all selections and collapse tiles (handled above not here).\n                        $(Selector.TILE).on(Event.KEYDOWN, function (e) {\n                            if (e.keyCode === Keyboard.RETURN) { // Return key pressed.\n                                $(e.currentTarget).click();\n                            }\n                        });\n\n                        // Move focus to the first tile in the course (not sec zero contents if present).\n                        $(\"ul.tiles .tile\").first().focus();\n\n                        // Initialise tooltips shown for example for tile contents when hover on tile (\"Files: 1\")\n                        // But not on mobile as they make clicks harder.\n                        var toolTips = $(Selector.TOOLTIP);\n                        if (toolTips.length !== 0) {\n                            try {\n                                toolTips.tooltip();\n                            } catch (err) {\n                                require([\"core/log\"], function(log) {\n                                    log.debug(err);\n                                });\n                            }\n                        }\n                    }\n\n                    // If Adaptable theme is being used, and Glossary auto link filter is on, we need this.\n                    // Otherwise when the auto link is clicked, the resulting dialogue is under the main overlay.\n                    // Don't need this when Boost or Clean themes are used as they handle it themselves.\n                    $(document).on(\"filter-content-updated\", function (event, msg) {\n                        if (msg.length > 0) {\n                            var elem = $(msg[0]);\n                            if (elem.hasClass(\"moodle-dialogue\") && elem.css(\"z-index\") < backDropZIndex) {\n                                    elem.css(\"z-index\", backDropZIndex + 1);\n                            }\n                        }\n                    });\n                });\n            }\n        };\n    }\n);"],"names":["define","$","Templates","ajax","browserStorage","Notification","str","tileFitter","windowOverlay","body","bodyHtml","isMobile","loadingIconHtml","windowOverlayDiv","stringStore","scrollFuncLock","sectionIsOpen","HEADER_BAR_HEIGHT","reopenLastVisitedSection","backDropZIndex","courseId","resizeLocked","openTile","Selector","PAGE","TILE","TILEID","MOVEABLE_SECTION","FILTER_BUTTON","TILE_LOADING_ICON","TILE_LOADING_ICON_ID","TILE_COLLAPSED","TILE_CLICKABLE","TILES","ACTIVITY","SPACER","SECTION_MOVEABLE","SECTION_ID","SECTION_TITLE","SECTION_MAIN","SECTION_BUTTONS","CLOSE_SEC_BTN","HIDE_SEC0_BTN","SECTION_ZERO","MOODLE_VIDEO","LAUNCH_STANDARD","TOOLTIP","HEADER_BAR","ClassNames","SELECTED","HEADER_OVERLAY","OPEN","CLOSED","LAUNCH_CM_MODAL","STATE_VISIBLE","Event","CLICK","KEYDOWN","SCROLL","CSS","DISPLAY","Z_INDEX","HEIGHT","BG_COLOUR","Keyboard","ESCAPE","TAB","RETURN","stopVideoPlaying","section","contentSection","find","each","index","iframe","attr","mediaPlayers","length","html","cancelTileSelections","sectionToFocus","sec","is","slideUp","removeClass","css","fadeOut","undefined","focus","setCourseContentHTML","contentArea","content","activities","not","on","e","keyCode","setLastVisitedSection","toClick","currentTarget","hasClass","click","window","location","last","shiftKey","relatedTarget","closest","setTimeout","animate","scrollTop","offset","top","tooltip","err","require","log","debug","videoJS","setUp","expandSection","tileId","expandAndScroll","scrollTo","events","stop","off","first","holdSectionButtonPosition","buttons","windowTop","desiredNewPositionInSection","outerHeight","fadeIn","isVisible","addClass","slideDown","reOrgSections","delayBefore","fitTilesToScreenWidth","dfd","Deferred","openedSection","openedSectionNum","reOrgFunc","runReOrg","done","result","resolve","fail","reject","resizeTilesDivWidth","promise","failedLoadSectionNotify","sectionNum","failResult","confirm","sectionerrortitle","sectionerrorstring","refresh","cancel","reload","noconnectionerror","Error","getSectionContentFromServer","call","methodname","args","courseid","sectionid","setjsusedsession","clickItemBehind","clickedItem","hide","BottomElement","document","elementFromPoint","clientX","clientY","show","clickedTile","setSectionZeroFromUserPref","buttonHideSecZero","sectionZero","storageEnabledLocal","getSecZeroCollapseStatus","populateAndExpandSection","thisTile","dataSection","storedContentExpirySecs","set","exception","relatedContentArea","getStoredContentAge","response","storageEnabledSession","storeCourseContent","contentAge","getCourseContent","loadingIcon","contentToDisplay","init","courseIdInit","useJavascriptNav","maxContentSectionsToStore","isMobileInit","storedContentDeleteMins","useFilterButtons","assumeDataStoreConsent","reopenLastSectionInit","userId","fitTilesToWidth","useWindoOverlay","ready","pageContent","getLastVisitedSection","windowWidth","outerWidth","getWindowOverlay","preventDefault","parseInt","nextSecIfExists","storedContentAge","resizeRequired","openContentSection","player","headerBar","selector","headerBarOverlay","getHeaderBarOverlay","getZIndex","clickedLk","setSecZeroCollapseStatus","filterButtons","render","stringKeys","key","component","get_strings","s","forEach","target","url","stopPropagation","cm","cmid","completion","markAsAutoCompleteInUI","toolTips","event","msg","elem"],"mappings":"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"}