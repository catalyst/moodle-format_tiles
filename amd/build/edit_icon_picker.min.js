define(["jquery","core/templates","core/ajax","core/str","core/notification","core/config"],function($,Templates,ajax,str,Notification,config){"use strict";var modalStored;var stringStore={pickAnIcon:""};var iconSet=[];var recentPhotoSet=[];var getAndStoreIconSet=function(courseId,callback){var photosPromises=ajax.call([{methodname:"format_tiles_get_icon_set",args:{courseid:courseId}}]);photosPromises[0].done(function(response){if(response.photos){recentPhotoSet=JSON.parse(response.photos)}var icons=JSON.parse(response.icons);Object.keys(icons).forEach(function(icon){iconSet.push({filename:"tileicon/"+icon,displayname:icons[icon],tileiconcontext:{attributes:[{name:"src",value:config.wwwroot+"/theme/image.php?theme="+config.theme+"&component=format_tiles&image="+"tileicon/"+icon}]}})});if(iconSet.length<=0){require(["core/log"],function(log){log.error("Error empty icon set");log.debug(response)})}if(typeof callback==="function"){callback()}var photoNames=recentPhotoSet.map(function(photo){return photo.filename});$("#iconpickerphotos").find(".photo").each(function(index,ph){ph=$(ph);if(photoNames.indexOf(ph.attr("data-filename"))===-1){ph.fadeOut(500)}});if(response.status!==true){require(["core/log"],function(log){log.error("Non true status response when getting icon set");log.debug(response)})}});photosPromises[0].fail(function(response){require(["core/log"],function(log){log.error("Fail when getting icon set");log.debug(response)})})};var getPhotoTileButtonUrl=function(courseId,sectionId){return config.wwwroot+"/course/format/tiles/editimage.php?courseid="+courseId+"&sectionid="+sectionId};var setIcon=function(sectionId,sectionNum,icon,displayname,pageType,courseId,imageType,sourcecontextid,sourceitemid){var selectedIcon=$("#selectedicon");var changeUiTilePhoto=function(jqueryObjToChange,imageUrl,imageType){var templateToRender="";var templateParams={tileicon:icon,tileid:sectionNum,secid:sectionId,isediting:1};switch(imageType){case"tileicon":templateToRender="tileicon";break;case"tilephoto":templateToRender="tilebarphoto";templateParams.phototileurl=imageUrl;templateParams.phototileediturl=getPhotoTileButtonUrl(courseId,sectionId);templateParams.iamgetype=imageType;jqueryObjToChange.closest(".tileiconcontainer").addClass("hasphoto");setTimeout(function(){getAndStoreIconSet(courseId)},3e3);break;case"draftfile":templateToRender="tilebarphoto";templateParams.phototileurl=imageUrl;templateParams.phototileediturl=getPhotoTileButtonUrl(courseId,sectionId);templateParams.iamgetype=imageType;break;default:throw new Error("Invalid image type "+imageType)}var divToAnimate=pageType==="course-view-tiles"?jqueryObjToChange:selectedIcon;divToAnimate.animate({opacity:0},500,function(){Templates.render("format_tiles/"+templateToRender,templateParams).done(function(html){divToAnimate.html(html).animate({opacity:1},500);var newTileIcon=$("#tile-icon-"+sectionId).find(".icon");if(!newTileIcon.attr("src").endsWith(templateParams.tileicon)){newTileIcon.attr("src",newTileIcon.attr("src")+templateParams.tileicon)}})});if(pageType==="course-editsection"&&imageType==="tilephoto"){$("input[name=tilephoto]").val(icon)}};var ajaxIconPickArgs={image:icon,courseid:courseId,sectionid:sectionId,imagetype:imageType,sourcecontextid:sourcecontextid===undefined?0:sourcecontextid,sourceitemid:sourceitemid===undefined?0:sourceitemid};var setIconDbPromises=ajax.call([{methodname:"format_tiles_set_image",args:ajaxIconPickArgs}]);setIconDbPromises[0].done(function(response){if(response.status===true){if(pageType==="course-view-tiles"){changeUiTilePhoto($("#tileicon_"+sectionNum),response.imageurl,imageType)}else if(pageType==="course-edit"||pageType==="course-editsection"){var selectBox=$("#id_defaulttileicon");if(pageType==="course-editsection"){selectBox=$("#id_tileicon")}selectBox.val(icon);if(imageType==="tileicon"){Templates.renderPix("tileicon/"+icon,"format_tiles",displayname).done(function(newIcon){selectedIcon.html(newIcon);if(pageType==="course-editsection"){str.get_strings([{key:"tip",component:"format_tiles"},{key:"tileselecttip",component:"format_tiles"}]).done(function(strings){Notification.alert(strings[0],strings[1])})}});if(pageType==="course-editsection"){$("input[name=tilephoto]").val("")}}else if(imageType==="tilephoto"){changeUiTilePhoto($("#tileicon_"+sectionNum),response.imageurl,imageType)}}}}).fail(function(response){require(["core/log"],function(log){log.error("Fail setting icon");log.debug(response);log.debug(ajaxIconPickArgs)})})};var launchIconPicker=function(pageType,courseId,sectionId,section,allowPhotoTiles,documentationurl){var populatePhotoLibrary=function(photosHTML,modalRoot,modal){var photoLibrary=$("#iconpickerphotos");photoLibrary.html(photosHTML);var largeFileThreshold=2e5;var doLast=[];photoLibrary.find("img").each(function(index,image){image=$(image);if(image.attr("data-filesize")<largeFileThreshold){setTimeout(function(){image.attr("src",image.attr("data-url"))},index*20)}else{doLast.push(image)}image.click(function(e){var clickedImage=$(e.currentTarget);setIcon(modalRoot.attr("data-sectionid"),modalRoot.attr("data-section"),clickedImage.attr("data-filename"),clickedImage.attr("data-filename"),pageType,courseId,clickedImage.attr("data-imagetype"),clickedImage.attr("data-contextid"),clickedImage.attr("data-itemid"));modal.hide()})});setTimeout(function(){doLast.forEach(function(image){image.attr("src",image.attr("data-url"))})},1e3)};if(typeof modalStored!=="object"){var renderModal=function(){str.get_strings([{key:"photolibrary",component:"format_tiles"},{key:"documentation",component:"format_tiles"},{key:"search",component:"core"}]).done(function(strings){Templates.render("format_tiles/icon_picker_modal_body",{icon_picker_icons:iconSet,photosallowed:allowPhotoTiles,wwwroot:config.wwwroot,documentationurl:documentationurl,istotara:$("body").hasClass("totara"),photolibrarystring:strings[0],documentationstring:strings[1],searchstring:strings[2]}).done(function(iconsHTML){require(["core/modal_factory"],function(modalFact){modalFact.create({type:modalFact.types.DEFAULT,title:stringStore.pickAnIcon,body:iconsHTML}).done(function(modal){modalStored=modal;modal.setLarge();modal.show();var modalRoot=$(modal.root);modalRoot.attr("id","icon_picker_modal");modalRoot.attr("data-sectionid",sectionId);modalRoot.attr("data-section",section);modalRoot.addClass("icon_picker_modal");modalRoot.on("click",".pickericon",function(e){var newIcon=$(e.currentTarget);setIcon(sectionId,section,newIcon.attr("data-icon"),newIcon.attr("title"),pageType,courseId,"tileicon",newIcon.attr("data-contextid"),newIcon.attr("data-itemid"));modal.hide()});modalRoot.on("input","input.iconsearch",function(e){var searchText=e.currentTarget.value.toLowerCase();modalRoot.find(".pickericon").show();if(searchText.length>=3){modalRoot.find(".pickericon").filter(function(index,icon){return $(icon).attr("data-original-title").toLowerCase().indexOf(searchText)<0}).hide()}});try{$(".pickericon").tooltip()}catch(err){require(["core/log"],function(log){log.debug(err)})}if(allowPhotoTiles){var url=getPhotoTileButtonUrl(courseId,sectionId);modalRoot.find("#phototilebtn").attr("href",url);$("#launch-photo-library").click(function(){if(recentPhotoSet.length!==0){Templates.render("format_tiles/icon_picker_photos",{icon_picker_photos:recentPhotoSet,wwwroot:config.wwwroot}).done(function(photosHTML){populatePhotoLibrary(photosHTML,modalRoot,modal)})}})}})})})})};if(iconSet.length<=0){getAndStoreIconSet(courseId,renderModal)}else{renderModal()}}else{modalStored.root.attr("data-sectionid",sectionId);modalStored.root.attr("data-section",section);modalStored.root.off("click");modalStored.root.on("click",".pickericon",function(e){var newIcon=$(e.currentTarget);setIcon(sectionId,section,newIcon.attr("data-icon"),newIcon.attr("title"),pageType,courseId,newIcon.attr("data-imagetype"),newIcon.attr("data-contextid"),newIcon.attr("data-itemid"));modalStored.hide()});if(allowPhotoTiles){var url=getPhotoTileButtonUrl(courseId,sectionId);modalStored.root.find("#phototilebtn").attr("href",url)}modalStored.show()}};return{init:function(courseId,pageType,allowPhotoTiles,documentationurl){$(document).ready(function(){var stringKey=allowPhotoTiles?"picknewiconphoto":"picknewicon";str.get_string(stringKey,"format_tiles").done(function(pickAnIcon){stringStore.pickAnIcon=pickAnIcon});getAndStoreIconSet(courseId);var pageContent=$("#page-content");if(pageContent.length===0){pageContent=$("#region-main")}pageContent.on("click",".launchiconpicker",function(e){e.preventDefault();var clickedIcon=$(e.currentTarget);launchIconPicker(pageType,courseId,clickedIcon.attr("data-sectionid"),clickedIcon.attr("data-section"),allowPhotoTiles,documentationurl)})})}}});
//# sourceMappingURL=edit_icon_picker.min.js.map