define(["jquery","core/templates","core/ajax","core/str","core/notification","core/config"],function(a,b,c,d,e,f){"use strict";var g,h={pickAnIcon:""},i=[],j=[],k=function(b,d){var e=c.call([{methodname:"format_tiles_get_icon_set",args:{courseid:b}}]);e[0].done(function(b){b.photos&&(j=JSON.parse(b.photos));var c=JSON.parse(b.icons);Object.keys(c).forEach(function(a){i.push({filename:"tileicon/"+a,displayname:c[a]})}),i.length<=0&&require(["core/log"],function(a){a.error("Error empty icon set"),a.debug(b)}),"function"==typeof d&&d();var e=j.map(function(a){return a.filename});a("#iconpickerphotos").find(".photo").each(function(b,c){c=a(c),e.indexOf(c.attr("data-filename"))===-1&&c.fadeOut(500)}),b.status!==!0&&require(["core/log"],function(a){a.error("Non true status response when getting icon set"),a.debug(b)})}),e[0].fail(function(a){require(["core/log"],function(b){b.error("Fail when getting icon set"),b.debug(a)})})},l=function(a,b){return f.wwwroot+"/course/format/tiles/editimage.php?courseid="+a+"&sectionid="+b},m=function(f,g,h,i,j,m,n,o,p){var q=a("#selectedicon"),r=function(c,d,e){var i="",n={tileicon:h,tileid:g,secid:f,isediting:1};switch(e){case"tileicon":i="tileicon";break;case"tilephoto":i="tilebarphoto",n.phototileurl=d,n.phototileediturl=l(m,f),n.iamgetype=e,c.closest(".tileiconcontainer").addClass("hasphoto"),setTimeout(function(){k(m)},3e3);break;case"draftfile":i="tilebarphoto",n.phototileurl=d,n.phototileediturl=l(m,f),n.iamgetype=e;break;default:throw new Error("Invalid image type "+e)}var o="course-view-tiles"===j?c:q;o.animate({opacity:0},500,function(){b.render("format_tiles/"+i,n).done(function(b){o.html(b).animate({opacity:1},500);var c=a("#tile-icon-"+f).find(".icon");c.attr("src").endsWith(n.tileicon)||c.attr("src",c.attr("src")+n.tileicon)})}),"course-editsection"===j&&"tilephoto"===e&&a("input[name=tilephoto]").val(h)},s={image:h,courseid:m,sectionid:f,imagetype:n,sourcecontextid:void 0===o?0:o,sourceitemid:void 0===p?0:p},t=c.call([{methodname:"format_tiles_set_image",args:s}]);t[0].done(function(c){if(c.status===!0)if("course-view-tiles"===j)r(a("#tileicon_"+g),c.imageurl,n);else if("course-edit"===j||"course-editsection"===j){var f=a("#id_defaulttileicon");"course-editsection"===j&&(f=a("#id_tileicon")),f.val(h),"tileicon"===n?(b.renderPix("tileicon/"+h,"format_tiles",i).done(function(a){q.html(a),"course-editsection"===j&&d.get_strings([{key:"tip",component:"format_tiles"},{key:"tileselecttip",component:"format_tiles"}]).done(function(a){e.alert(a[0],a[1])})}),"course-editsection"===j&&a("input[name=tilephoto]").val("")):"tilephoto"===n&&r(a("#tileicon_"+g),c.imageurl,n)}}).fail(function(a){require(["core/log"],function(b){b.error("Fail setting icon"),b.debug(a),b.debug(s)})})},n=function(c,e,n,o,p,q){var r=function(b,d,f){var g=a("#iconpickerphotos");g.html(b);var h=2e5,i=[];g.find("img").each(function(b,g){g=a(g),g.attr("data-filesize")<h?setTimeout(function(){g.attr("src",g.attr("data-url"))},20*b):i.push(g),g.click(function(b){var g=a(b.currentTarget);m(d.attr("data-sectionid"),d.attr("data-section"),g.attr("data-filename"),g.attr("data-filename"),c,e,g.attr("data-imagetype"),g.attr("data-contextid"),g.attr("data-itemid")),f.hide()})}),setTimeout(function(){i.forEach(function(a){a.attr("src",a.attr("data-url"))})},1e3)};if("object"!=typeof g){var s=function(){d.get_strings([{key:"photolibrary",component:"format_tiles"},{key:"documentation",component:"format_tiles"},{key:"search"}]).done(function(d){b.render("format_tiles/icon_picker_modal_body",{icon_picker_icons:i,photosallowed:p,wwwroot:f.wwwroot,documentationurl:q,istotara:a("body").hasClass("totara"),photolibrarystring:d[0],documentationstring:d[1],searchstring:d[2]}).done(function(d){require(["core/modal_factory"],function(i){i.create({type:i.types.DEFAULT,title:h.pickAnIcon,body:d}).done(function(d){g=d,d.setLarge(),d.show();var h=a(d.root);h.attr("id","icon_picker_modal"),h.attr("data-sectionid",n),h.attr("data-section",o),h.addClass("icon_picker_modal"),h.on("click",".pickericon",function(b){var f=a(b.currentTarget);m(n,o,f.attr("data-icon"),f.attr("title"),c,e,"tileicon",f.attr("data-contextid"),f.attr("data-itemid")),d.hide()}),h.on("input","input.iconsearch",function(b){var c=b.currentTarget.value.toLowerCase();h.find(".pickericon").show(),c.length>=3&&h.find(".pickericon").filter(function(b,d){return a(d).attr("data-original-title").toLowerCase().indexOf(c)<0}).hide()});try{a(".pickericon").tooltip()}catch(i){require(["core/log"],function(a){a.debug(i)})}if(p){var k=l(e,n);h.find("#phototilebtn").attr("href",k),a("#launch-photo-library").click(function(){0!==j.length&&b.render("format_tiles/icon_picker_photos",{icon_picker_photos:j,wwwroot:f.wwwroot}).done(function(a){r(a,h,d)})})}})})})})};i.length<=0?k(e,s):s()}else{if(g.root.attr("data-sectionid",n),g.root.attr("data-section",o),g.root.off("click"),g.root.on("click",".pickericon",function(b){var d=a(b.currentTarget);m(n,o,d.attr("data-icon"),d.attr("title"),c,e,d.attr("data-imagetype"),d.attr("data-contextid"),d.attr("data-itemid")),g.hide()}),p){var t=l(e,n);g.root.find("#phototilebtn").attr("href",t)}g.show()}};return{init:function(b,c,e,f){a(document).ready(function(){var g=e?"picknewiconphoto":"picknewicon";d.get_string(g,"format_tiles").done(function(a){h.pickAnIcon=a}),k(b);var i=a("#page-content");0===i.length&&(i=a("#region-main")),i.on("click",".launchiconpicker",function(d){d.preventDefault();var g=a(d.currentTarget);n(c,b,g.attr("data-sectionid"),g.attr("data-section"),e,f)})})}}});