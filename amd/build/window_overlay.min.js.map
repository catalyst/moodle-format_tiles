{"version":3,"sourceRoot":"..","sources":["server/course/format/tiles/amd/src/window_overlay.js"],"sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * Javascript Module to handle adding and removing a semi transparent black overlay to the window.\n * Open tiles and tile content sit ojn top of it.  Closed tiles sit behind it.\n * Called when in non editing mode.\n * As this involves manipulating z-indices and can therefore cause conflict with some themes,\n * there is an option for the developer to disable it.  To do that, go to format.php and, in\n * the variable $jsparams set 'useWindowOverlay' to false.  This AMD module will then be ignored.\n *\n * @module window_overlay\n * @package course/format\n * @subpackage tiles\n * @copyright 2019 David Watson {@link http://evolutioncode.uk}\n * @license http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n * @since Moodle 3.7\n */\n\n/* eslint space-before-function-paren: 0 */\n\ndefine([\"jquery\"], function ($) {\n    \"use strict\";\n\n    var windowOverlay;\n    var headerOverlay;\n    var body = $(\"body\");\n\n    var Selector = {\n        PAGE: \"#page\",\n        TILEID: \"#tile-\",\n        SECTION_ID: \"#section-\",\n    };\n    var ClassNames = {\n        HEADER_OVERLAY: \"header-overlay\"\n    };\n\n    var CSS = {\n        DISPLAY: \"display\",\n        Z_INDEX: \"z-index\",\n        HEIGHT: \"height\",\n        BG_COLOUR: \"background-color\"\n    };\n    /**\n     * Because headeroverlay may not exist, we want to avoid trying to fade if not there.\n     * @param {boolean|undefined} fadeIn whether to fade in (fade out otherwise).\n     * @returns {boolean}\n     */\n    var fadeHeaderInOut = function (fadeIn) {\n        if (!headerOverlay) {\n            return false;\n        } else {\n            if (fadeIn === true) {\n                headerOverlay.fadeIn(300);\n            } else {\n                headerOverlay.fadeOut(300);\n            }\n            return true;\n        }\n    };\n\n    /**\n     * Temporary function to adjust shade of RGB colour\n     * (used for shading tiles to get around transparent background on overlay issue)\n     * @param {number} R\n     * @param {number} G\n     * @param {number} B\n     * @param {number} percent\n     * @returns {string}\n     */\n    var shadeRGBColor = function (R, G, B, percent) {\n        var t = percent < 0 ? 0 : 255;\n        var p = percent < 0 ? percent * -1 : percent;\n        var r = Math.round((t - R) * p) + R;\n        var g = Math.round((t - G) * p) + G;\n        var b = Math.round((t - B) * p) + B;\n        return \"rgb(\" + r + \",\" + g + \",\" + b + \")\";\n    };\n\n    var getZIndex = function () {\n        var overlayZIndex = parseInt(windowOverlay.css(CSS.Z_INDEX));\n        return overlayZIndex > 0 ? overlayZIndex : 0;\n    };\n\n    /**\n     * Add an opaque modal backdrop like div to obscure all other tiles and bring specified tile and content to front\n     * @param {number} secNumOnTop the section number which should be displayed on top of the overlay\n     */\n    var set = function (secNumOnTop) {\n        windowOverlay.fadeIn(300);\n        var backDropZIndex = parseInt(windowOverlay.css(CSS.Z_INDEX));\n        backDropZIndex = backDropZIndex > 0 ? backDropZIndex : 0;\n        var tile = $(Selector.TILEID + secNumOnTop);\n        tile.css(CSS.Z_INDEX, (backDropZIndex + 1));\n        fadeHeaderInOut(true);\n        $(Selector.SECTION_ID + secNumOnTop).css(CSS.Z_INDEX, (backDropZIndex + 1));\n        if (tile.css(CSS.BG_COLOUR) && tile.css(CSS.BG_COLOUR).substr(0, 4) === \"rgba\") {\n            // Tile may have transparent background from theme - needs to be solid otherwise modal shows through.\n            var existingColour = tile.css(CSS.BG_COLOUR).replace(\"rgba(\", \"\").replace(\")\", \"\").replace(\" \", \"\").split(\",\");\n            tile.css(CSS.BG_COLOUR, shadeRGBColor(\n                parseInt(existingColour[0]),\n                parseInt(existingColour[1]),\n                parseInt(existingColour[2]),\n                0.95\n            ));\n        }\n    };\n\n    var setHeaderBarOverlay = function (headerBar) {\n        if (headerBar.attr(\"id\") !== \"navwrap\") {\n            // ID navwrap suggests theme is Adaptable based. We don't bother with header overlay if so.\n            // Otherwise the header bar has a separate mini overlay of its own - find and hide this.\n            // If it is clicked, cancel tile selections and click the item behind where clicked.\n            // Do not include for Moodle 3.5 or higher as not needed.\n            if (headerBar.height() !== undefined) {\n                var headerOverlay = $(\"<div></div>\")\n                    .addClass(ClassNames.HEADER_OVERLAY).attr(\"id\", ClassNames.HEADER_OVERLAY)\n                    .css(CSS.DISPLAY, \"none\");\n                headerOverlay.insertAfter(Selector.PAGE)\n                    .css(CSS.Z_INDEX, (getZIndex()) + 3).css(CSS.HEIGHT, headerBar.outerHeight());\n                return headerOverlay;\n            }\n        }\n        return false;\n    };\n\n    return {\n        getZIndex: function () {\n            return getZIndex();\n        },\n\n        fadeIn: function () {\n            if (windowOverlay.css(CSS.DISPLAY) === \"none\") {\n                windowOverlay.fadeIn(300);\n            }\n        },\n\n        getWindowOverlay: function() {\n            if (windowOverlay === undefined) {\n                // When a tile is clicked we add an overlay to grey out the rest of the tiles on the page, so prepare it.\n                windowOverlay = $(\"<div></div>\").addClass(\"modal-backdrop fade in\").hide()\n                    .attr(\"id\", \"window-overlay\").appendTo(body);\n            }\n            return windowOverlay;\n        },\n\n        fadeOut: function () {\n            if (windowOverlay.css(CSS.DISPLAY) === \"block\") {\n                windowOverlay.fadeOut(300);\n                fadeHeaderInOut(false);\n            }\n        },\n\n        set: function (secNumOnTop) {\n            set(secNumOnTop);\n        },\n\n        getHeaderBarOverlay: function(headerBar) {\n            if (headerOverlay === undefined) {\n                headerOverlay = setHeaderBarOverlay(headerBar);\n            }\n            return headerOverlay;\n        },\n\n        isVisible: function() {\n            return windowOverlay.is(\":visible\");\n        }\n    };\n});"],"names":["define","$","windowOverlay","headerOverlay","body","Selector","PAGE","TILEID","SECTION_ID","ClassNames","HEADER_OVERLAY","CSS","DISPLAY","Z_INDEX","HEIGHT","BG_COLOUR","fadeHeaderInOut","fadeIn","fadeOut","shadeRGBColor","R","G","B","percent","t","p","r","Math","round","g","b","getZIndex","overlayZIndex","parseInt","css","set","secNumOnTop","backDropZIndex","tile","substr","existingColour","replace","split","setHeaderBarOverlay","headerBar","attr","height","undefined","addClass","insertAfter","outerHeight","getWindowOverlay","hide","appendTo","getHeaderBarOverlay","isVisible","is"],"mappings":"AAiCAA,OAAO,CAAC,UAAW,SAAUC,GACzB,aAEA,IAAIC,cACJ,IAAIC,cACJ,IAAIC,KAAOH,EAAE,MAAM,EAEnB,IAAII,SAAW,CACXC,KAAM,QACNC,OAAQ,SACRC,WAAY,WAChB,EACA,IAAIC,WAAa,CACbC,eAAgB,gBACpB,EAEA,IAAIC,IAAM,CACNC,QAAS,UACTC,QAAS,UACTC,OAAQ,SACRC,UAAW,kBACf,EAMA,IAAIC,gBAAkB,SAAUC,QAC5B,GAAI,CAACd,cAAe,CAChB,OAAO,KACX,KAAO,CACH,GAAIc,SAAW,KAAM,CACjBd,cAAcc,OAAO,GAAG,CAC5B,KAAO,CACHd,cAAce,QAAQ,GAAG,CAC7B,CACA,OAAO,IACX,CACJ,EAWA,IAAIC,cAAgB,SAAUC,EAAGC,EAAGC,EAAGC,SACnC,IAAIC,EAAID,QAAU,EAAI,EAAI,IAC1B,IAAIE,EAAIF,QAAU,EAAIA,QAAU,CAAC,EAAIA,QACrC,IAAIG,EAAIC,KAAKC,OAAOJ,EAAIJ,GAAKK,CAAC,EAAIL,EAClC,IAAIS,EAAIF,KAAKC,OAAOJ,EAAIH,GAAKI,CAAC,EAAIJ,EAClC,IAAIS,EAAIH,KAAKC,OAAOJ,EAAIF,GAAKG,CAAC,EAAIH,EAClC,MAAO,OAASI,EAAI,IAAMG,EAAI,IAAMC,EAAI,GAC5C,EAEA,IAAIC,UAAY,WACZ,IAAIC,cAAgBC,SAAS/B,cAAcgC,IAAIvB,IAAIE,OAAO,CAAC,EAC3D,OAAOmB,cAAgB,EAAIA,cAAgB,CAC/C,EAMA,IAAIG,IAAM,SAAUC,aAChBlC,cAAce,OAAO,GAAG,EACxB,IAAIoB,eAAiBJ,SAAS/B,cAAcgC,IAAIvB,IAAIE,OAAO,CAAC,EAC5DwB,eAAiBA,eAAiB,EAAIA,eAAiB,EACvD,IAAIC,KAAOrC,EAAEI,SAASE,OAAS6B,WAAW,EAC1CE,KAAKJ,IAAIvB,IAAIE,QAAUwB,eAAiB,CAAE,EAC1CrB,gBAAgB,IAAI,EACpBf,EAAEI,SAASG,WAAa4B,WAAW,EAAEF,IAAIvB,IAAIE,QAAUwB,eAAiB,CAAE,EAC1E,GAAIC,KAAKJ,IAAIvB,IAAII,SAAS,GAAKuB,KAAKJ,IAAIvB,IAAII,SAAS,EAAEwB,OAAO,EAAG,CAAC,IAAM,OAAQ,CAE5E,IAAIC,eAAiBF,KAAKJ,IAAIvB,IAAII,SAAS,EAAE0B,QAAQ,QAAS,EAAE,EAAEA,QAAQ,IAAK,EAAE,EAAEA,QAAQ,IAAK,EAAE,EAAEC,MAAM,GAAG,EAC7GJ,KAAKJ,IAAIvB,IAAII,UAAWI,cACpBc,SAASO,eAAe,EAAE,EAC1BP,SAASO,eAAe,EAAE,EAC1BP,SAASO,eAAe,EAAE,EAC1B,GACJ,CAAC,CACL,CACJ,EAEA,IAAIG,oBAAsB,SAAUC,WAChC,GAAIA,UAAUC,KAAK,IAAI,IAAM,UAAW,CAKpC,GAAID,UAAUE,OAAO,IAAMC,UAAW,CAClC,IAAI5C,cAAgBF,EAAE,aAAa,EAC9B+C,SAASvC,WAAWC,cAAc,EAAEmC,KAAK,KAAMpC,WAAWC,cAAc,EACxEwB,IAAIvB,IAAIC,QAAS,MAAM,EAC5BT,cAAc8C,YAAY5C,SAASC,IAAI,EAClC4B,IAAIvB,IAAIE,QAAUkB,UAAW,EAAI,CAAC,EAAEG,IAAIvB,IAAIG,OAAQ8B,UAAUM,YAAY,CAAC,EAChF,OAAO/C,aACX,CACJ,CACA,OAAO,KACX,EAEA,MAAO,CACH4B,UAAW,WACP,OAAOA,UAAU,CACrB,EAEAd,OAAQ,WACJ,GAAIf,cAAcgC,IAAIvB,IAAIC,OAAO,IAAM,OAAQ,CAC3CV,cAAce,OAAO,GAAG,CAC5B,CACJ,EAEAkC,iBAAkB,WACd,GAAIjD,gBAAkB6C,UAAW,CAE7B7C,cAAgBD,EAAE,aAAa,EAAE+C,SAAS,wBAAwB,EAAEI,KAAK,EACpEP,KAAK,KAAM,gBAAgB,EAAEQ,SAASjD,IAAI,CACnD,CACA,OAAOF,aACX,EAEAgB,QAAS,WACL,GAAIhB,cAAcgC,IAAIvB,IAAIC,OAAO,IAAM,QAAS,CAC5CV,cAAcgB,QAAQ,GAAG,EACzBF,gBAAgB,KAAK,CACzB,CACJ,EAEAmB,IAAK,SAAUC,aACXD,IAAIC,WAAW,CACnB,EAEAkB,oBAAqB,SAASV,WAC1B,GAAIzC,gBAAkB4C,UAAW,CAC7B5C,cAAgBwC,oBAAoBC,SAAS,CACjD,CACA,OAAOzC,aACX,EAEAoD,UAAW,WACP,OAAOrD,cAAcsD,GAAG,UAAU,CACtC,CACJ,CACJ,CAAC"}