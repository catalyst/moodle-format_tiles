define(["jquery","core/ajax","core/templates","core/notification","core/str","core/url","core/config"],function($,ajax,Templates,Notification,str,url,config){"use strict";var stringStore={};var body=$("html,body");var page=$("#page");var Selector={MENU_ACTION:".menu-action-text",SUBTILE:".subtile",SPACER:".spacer",AVAIL_INFO:".availabilityinfo",ACTIVITY_INSTANCE:".subtile-activityinstance",INSTANCE_NAME:".instancename",SECTION_CM_EDIT_ACTIONS:".section-cm-edit-actions",EDITING_MOVE:".editing_move",LABEL_CONVERT:".editing_labelconvert",CM_EDIT_ACTION:".cm-edit-action",ACTIVITY_ICON:".activityicon",EDITING_DELETE:".editing_delete",SECTION_MAIN:".section.main",STEALTH_UNAVAIL_LINK:".editing_makeunavailable"};var ClassNames={SHOW:"show",HIDE:"hide",FA_EYE_SLASH:"fa-eye-slash",FA_EYE:"fa-eye",DIMMED:"dimmed",EDITING:"editing_",ACTIVITY:"activity",LABEL:"label",SECTION_DRAGGABLE:"sectiondraggable"};var Event={CLICK:"click",MODULE_ADDED:"filter-content-updated",MOUSEDOWN:"mousedown"};var legacyToggleHideCourseMod=function(clickEvent){var clickedLink=$(clickEvent.currentTarget);var actions;if(body.hasClass("totara")){return}if(clickedLink.attr("data-action")==="tiles-hide"){actions={changeTo:ClassNames.HIDE,old:ClassNames.SHOW};$(Selector.STEALTH_UNAVAIL_LINK).hide()}else if(clickedLink.attr("data-action")==="tiles-show"){actions={changeTo:ClassNames.SHOW,old:ClassNames.HIDE}}if(actions){clickEvent.preventDefault();clickedLink.attr("data-action","tiles-"+actions.old);var promises=ajax.call([{methodname:"core_course_edit_module",args:{id:clickedLink.attr("data-cmid"),action:actions.changeTo}}],true);promises[0].done(function(HTMLresult){clickedLink.removeClass(ClassNames.EDITING+actions.old).addClass(ClassNames.EDITING+actions.changeTo);clickedLink.attr("href",clickedLink.attr("href").replace("&"+actions.old+"=","&"+actions.changeTo+"="));var menuActionText=clickedLink.find(Selector.MENU_ACTION);var subtile=clickedLink.closest(Selector.SUBTILE);if(actions.changeTo===ClassNames.SHOW){menuActionText.html(menuActionText.html().replace(stringStore.show,stringStore.hide));clickedLink.find("i").removeClass(ClassNames.FA_EYE_SLASH).addClass(ClassNames.FA_EYE);subtile.removeClass(ClassNames.DIMMED)}else if(actions.changeTo===ClassNames.HIDE){menuActionText.html(menuActionText.html().replace(stringStore.hide,stringStore.show));clickedLink.find("i").removeClass(ClassNames.FA_EYE).addClass(ClassNames.FA_EYE_SLASH);subtile.addClass(ClassNames.DIMMED)}var newAvailabilityInfo=$(HTMLresult).find(Selector.AVAIL_INFO);var oldAvailabilityInfo=subtile.find(Selector.AVAIL_INFO);if(newAvailabilityInfo){if(oldAvailabilityInfo.length){oldAvailabilityInfo.replaceWith(newAvailabilityInfo)}else{newAvailabilityInfo.appendTo(subtile.find(Selector.ACTIVITY_INSTANCE))}}else{oldAvailabilityInfo.hide()}});promises[0].fail(function(){window.location.replace(clickedLink.attr("href"))})}};var legacyFileTypeFromIconURL=function(iconURL){var extensions={powerpoint:"ppt",document:"doc",spreadsheet:"xls",archive:"zip",pdf:"pdf",mp3:"mp3",mpeg:"mp4",jpeg:"jpeg",text:"txt",html:"html"};if(iconURL){return extensions[iconURL.split("/").slice(-1)[0].split("-")[0]]}else{return false}};var legacyCourseModGetSubtileAttributes=function(cmObject,modResourceType,displayname){if(displayname===undefined||displayname===""){displayname=stringStore.other}cmObject.find("a.cm-edit-action").each(function(index,editItem){$(editItem).attr("data-action","")});cmObject.find("a.editing_moveright").remove();var returnData={cmid:cmObject.attr("id").split("-").slice(-1)[0],modtitle:cmObject.find(Selector.INSTANCE_NAME).html().split("<")[0],cmeditmenu:cmObject.find(Selector.SECTION_CM_EDIT_ACTIONS)[0].outerHTML.replace(/\n/g,""),cmmove:cmObject.find(Selector.EDITING_MOVE)[0].outerHTML,modname:"resource",modResourceType:modResourceType,modnameDisplay:displayname,useSubtiles:1,isEmbeddedResource:0,clickable:1,isediting:1,visible:1};returnData.isPdf=returnData.modResourceType==="pdf";return returnData};var legacyHandleCmAddedToPage=function(courseId,addedCourseModule,sectionAddedTo,msg){if(sectionAddedTo.hasClass(ClassNames.SECTION_DRAGGABLE)&&window.location.href.indexOf("expand=")===-1){window.location=config.wwwroot+"/course/view.php?id="+courseId+"&expand="+sectionAddedTo.attr("data-section")+"#section-"+sectionAddedTo.attr("data-section")}else if(addedCourseModule.hasClass(ClassNames.LABEL)&&addedCourseModule.closest("ul").hasClass("subtiles")){window.location.reload()}else if(addedCourseModule.hasClass(ClassNames.ACTIVITY)&&addedCourseModule.closest("ul").hasClass("subtiles")){addedCourseModule.children().hide();addedCourseModule.append($("<img/>").attr("src",url.imageUrl("loading","format_tiles")).addClass("loading-subtile").attr("title",stringStore.loading));var previousNonSpacer=addedCourseModule.prevAll(Selector.SUBTILE).not(Selector.SPACER).first();addedCourseModule.prevUntil(previousNonSpacer,Selector.SPACER).hide();var modResourceType=legacyFileTypeFromIconURL(addedCourseModule.find(Selector.ACTIVITY_ICON).attr("src"));if(modResourceType===undefined){window.location.reload()}var stringKey="displaytitle_mod_"+modResourceType;if(stringStore[stringKey]===undefined){str.get_string(stringKey,"format_tiles").done(function(string){if(string.substring(0,2)!=="[["){stringStore[stringKey]=string}else{string=""}var cmAttributes=legacyCourseModGetSubtileAttributes(addedCourseModule,modResourceType,string);Templates.render("format_tiles/course_module",cmAttributes).done(function(html){addedCourseModule.replaceWith(html);var newItem=$("#"+$(msg).attr("id"));body.animate({scrollTop:newItem.offset().top-130},"fast");for(var x=0;x<3;x++){newItem.fadeOut(300).fadeIn(300)}$("#module-"+cmAttributes.cmid).find(".editing_move").attr("data-action","").on(Event.MOUSEDOWN,function(){window.location.reload()})})})}else{var cmAttributes=legacyCourseModGetSubtileAttributes(addedCourseModule,modResourceType,stringStore[stringKey]);Templates.render("format_tiles/course_module",cmAttributes).done(function(html){addedCourseModule.replaceWith(html);$("#module-"+cmAttributes.cmid).find(".editing_move").attr("data-action","").on(Event.MOUSEDOWN,function(){window.location.reload()})})}}else{addedCourseModule.find("div.mod-indent-outer").css("position","absolute").css("top","0").css("width","100%").css("padding-left","0")}};return{init:function(courseId,displaySection,convertedLabel){$(document).ready(function(){Y.use("moodle-course-coursebase",function(){if(typeof M.course!=="undefined"){setTimeout(function(){M.course.coursebase.registermodules=[]},500)}});$(Selector.LABEL_CONVERT).on(Event.CLICK,function(e){e.preventDefault();Notification.confirm(stringStore.areyousure,stringStore.converttopage_confirm,stringStore.yes,stringStore.no,function(){window.location=$(e.currentTarget).attr("href")},null)});if(convertedLabel!==0){var newPage=$("#module-"+convertedLabel);if(newPage!==undefined){body.animate({scrollTop:newPage.offset().top-130},"fast");for(var x=0;x<3;x++){newPage.fadeOut(300).fadeIn(300)}}}page.on("click",Selector.CM_EDIT_ACTION,function(e){legacyToggleHideCourseMod(e)});$(document).on(Event.MODULE_ADDED,function(event,msg){var addedCourseModule=$("#"+$(msg).attr("id"));var sectionAddedTo=addedCourseModule.closest(Selector.SECTION_MAIN);if(sectionAddedTo.length>=1){legacyHandleCmAddedToPage(courseId,addedCourseModule,sectionAddedTo,msg)}});page.on(Event.CLICK,Selector.EDITING_DELETE,function(e){var deletedItem=$(e.currentTarget).closest("li"+ClassNames.ACTIVITY);var previousNonSpacer=deletedItem.prevAll(Selector.SUBTILE).not(Selector.SPACER).first();if(deletedItem.hasClass(ClassNames.LABEL)){deletedItem.prevUntil(previousNonSpacer,Selector.SPACER).hide()}});str.get_strings([{key:"yes"},{key:"no"},{key:"show"},{key:"hide"},{key:"converttopage_confirm",component:"format_tiles"},{key:"areyousure"},{key:"complete",component:"format_tiles"},{key:"fileaddedtobottom",component:"format_tiles"},{key:"loading",component:"format_tiles"}]).done(function(s){stringStore={yes:s[0],no:s[1],show:s[2],hide:s[3],converttopage_confirm:s[4],areyousure:s[5],complete:s[6],fileaddedtobottom:s[7],loading:s[8]}})})}}});
//# sourceMappingURL=edit_course_mod.min.js.map