{"version":3,"sourceRoot":"..","sources":["server/course/format/tiles/amd/src/tile_fitter.js"],"sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * Javascript Module to handle fitting tiles to screen.\n * Called when in non editing mode.\n *\n * @module tile_fitter\n * @package course/format\n * @subpackage tiles\n * @copyright 2019 David Watson {@link http://evolutioncode.uk}\n * @license http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n * @since Moodle 3.3\n */\n\n/* global setTimeout, document, window */\n/* eslint space-before-function-paren: 0 */\n\ndefine([\"jquery\", \"core/ajax\"], function ($, ajax) {\n    \"use strict\";\n\n    var reOrgLocked = false;\n    var courseId;\n    var Selector = {\n        PAGE: \"#page\",\n        TILE: \".tile\",\n        TILEID: \"#tile-\",\n        TILE_COLLAPSED: \".tile-collapsed\",\n        TILES: \".format-tiles.jsenabled ul.tiles\",\n        ACTIVITY: \".activity\",\n        SPACER: \".spacer\",\n        SECTION_ID: \"#section-\",\n        OPEN_SECTION: \".moveablesection:visible\",\n        SECTION_ZERO: \"#section-0\",\n        CONTENT_SECTIONS: \".moveablesection\"\n    };\n\n    // Used to store a delayed AJAX request so we can replace it if user sets again within one second or two.\n    var timeoutBeforeResizeAjax = null;\n\n    /**\n     * If we have a single tile on the last row it looks odd.\n     * We might want to shrink the tile window down a little to even it out.\n     * So we work out how many per row would be optimal, and shrink the window accordingly.\n     * @see format_tiles_width_template_data() in locallib.php for more information.\n     * @return {Promise}\n     */\n    var resizeTilesDivWidth = function() {\n        var winWidth = $(window).width();\n        // Create a new Deferred.\n        var dfd = new $.Deferred();\n        var tiles = $(Selector.TILES);\n        var TILE_WIDTHS = {\n            standard: 260,\n            min: 225,\n            mobileMin: 160\n        };\n        try {\n            var tilesParentWidth = tiles.parent().innerWidth();\n            var firstTile = $(tiles.find(Selector.TILE)[0]);\n            // Get the width of one tile.\n            var oneTileWidth = firstTile.width()\n                ? firstTile.width()\n                : TILE_WIDTHS.standard; // Default standard as min tile width if we can't get the actual width.\n            var tileMargin = 14; // Margin 7px either side.\n            oneTileWidth = oneTileWidth + tileMargin;\n            var resizeWidth = \"inherit\";\n            // Skip if window is only 2 or smaller than 2 tiles wide already.\n            // This ensures that we don't crush the tiles into the centre (i.e. we use at least x% of width).\n            var maxPossibleTilesPerRow = Math.floor(tilesParentWidth / TILE_WIDTHS.min);\n            var tileCount = ($(Selector.TILE).not(Selector.SPACER).length); // How many tiles in this course.\n            if (tilesParentWidth < TILE_WIDTHS.mobileMin * 2) {\n                // Only space for one tile - don't resize to save space.\n                dfd.reject(\"Too narrow to resize\");\n            } else if (tileCount <= 3 && tilesParentWidth > tileCount * TILE_WIDTHS.mobileMin) {\n                resizeWidth = TILE_WIDTHS.standard * 4;\n            } else if (tilesParentWidth < TILE_WIDTHS.min * 3) {\n                resizeWidth = (TILE_WIDTHS.standard - tileMargin) * 2;\n            } else if (maxPossibleTilesPerRow < 4) {\n                // Here we set the max width to the space we have available, so that tiles are centred.\n                resizeWidth = TILE_WIDTHS.standard * maxPossibleTilesPerRow;\n            } else {\n                // Make a range of numbers in an array.  e.g. range(2,5) = [2, 3, 4, 5].\n                var range = function (start, end) {\n                    var res = [];\n                    for (start; start <= end; start += 1) {\n                        res.push(start);\n                    }\n                    return res;\n                };\n\n                // How many tiles per row could we fit on the screen, if we put in as many as possible?\n                var rowMaxCount = Math.min(\n                    Math.floor(tilesParentWidth / oneTileWidth),\n                    tileCount\n                );\n                // If we'd have a single row of more than 5 tiles, split it into 2.\n                if (tileCount <= rowMaxCount && tileCount > 5) {\n                    resizeWidth = (Math.floor(tileCount / 2) + 1) * oneTileWidth;\n                } else if (rowMaxCount > 3 && tileCount / rowMaxCount <= 3) {\n                    // If we can fit 3 tiles per row max, we don't restrict to 2, as this makes content window unnecessarily small.\n                    // Also if we have 3 or more rows (3 or more) we don't bother restricting as the last row is not so noticeable.\n\n                    // How many tiles per row do we want as a minimum (in order to occupy a reasonable amount of width)?\n                    var rowMinCount = Math.floor(tilesParentWidth / oneTileWidth);\n\n                    // What are the possibilities for tiles per row?  Then we can look at which we want.\n                    var possibleRowCounts = range(rowMinCount, rowMaxCount).reverse(); // Something like [6, 5, 4, 3].\n\n                    // For each possibility, how many tiles would that leave on the last row?\n                    var lastRowRemainderTiles = possibleRowCounts.map(function (num) {\n                        return tileCount % num;\n                    });\n                    if (lastRowRemainderTiles.indexOf(0) !== -1) {\n                        // We have the option of having a *full* last row so take that.\n                        resizeWidth = oneTileWidth * possibleRowCounts[lastRowRemainderTiles.indexOf(0)];\n                    } else if (tileCount < rowMinCount) {\n                        resizeWidth = tileCount * oneTileWidth;\n                    } else {\n                        // Otherwise make the last row as full as possible (few tiles on last row looks worse).\n                        resizeWidth = oneTileWidth * possibleRowCounts[lastRowRemainderTiles.indexOf(\n                            Math.max.apply(null, lastRowRemainderTiles)\n                        )];\n                    }\n                } else {\n                    // In these cases, we don't artificially narrow the view, but we do put a max width on of the existing width.\n                    // This is so that, when sections open under the tiles, they do not stick out with extra width beyond the tiles.\n                    // It also allows the auto margin to centre the tiles.\n                    resizeWidth = rowMaxCount * oneTileWidth;\n                }\n            }\n\n            // If we already have the desired width, nothing to do here so skip it.\n            var existingWidth = parseInt(tiles.css(\"max-width\").replace(\"px\", \"\"));\n            if (Math.abs(resizeWidth - existingWidth) < 100) {\n                dfd.resolve();\n            } else {\n                // We set session width at the server so that next time it is rendered with PHP, it has the correct width already.\n                var resizeTime = 500;\n                tiles.css(\"max-width\", winWidth).animate({\"max-width\": resizeWidth}, resizeTime, \"swing\",\n                    function() {\n                        setTimeout(function() {\n                            // Wait additional time before confirm resolved to allow resize to complete else re-org is too early.\n                            dfd.resolve();\n                        }, resizeTime + 100);\n                        $(Selector.CONTENT_SECTIONS).animate({\"max-width\": resizeWidth}, resizeTime, \"swing\");\n                    }\n                );\n            }\n\n            // If we already have scheduled AJAX request to set width, cancel it and replace it with a more up to date one.\n            // We need not set the width on the server very often - once every 3 seconds is plenty.\n            if (timeoutBeforeResizeAjax) {\n                clearTimeout(timeoutBeforeResizeAjax);\n            }\n            timeoutBeforeResizeAjax = setTimeout(function () {\n\n                ajax.call([{\n                    methodname: \"format_tiles_set_session_width\",\n                    args: {courseid: courseId, width: Math.floor(resizeWidth)}\n                }]);\n            }, 3000);\n        } catch (err) {\n            // Unset widths as something went wrong.\n            tiles.css(\"max-width\", winWidth).animate({\"max-width\": \"100%\"}, 500, \"swing\");\n            ajax.call([{\n                methodname: \"format_tiles_set_session_width\",\n                args: {courseid: courseId, width: 0}\n            }]);\n            dfd.reject(\"Failed to resize\");\n        }\n        return dfd.promise();\n    };\n\n    var organiser = {\n        /**\n         * Content sections need to be displayed after the row in which the tile to which they relate appears\n         * e.g. we have a row of tiles 1-3 and then after that we need to have the content divs which contain the\n         * related content.  As this depends on device window size, we calcuate this on page load and after window changes\n         * e.g. navbar button at side is pressed or browser window is resized\n         * @returns {Array} of rows, with the tile they need to be displayed after, and the sections in each row\n         */\n        getContentSectionPositions: function () {\n            var rows = [];\n            var currentSectionId;\n            var previousTile;\n            var openSections = $(Selector.OPEN_SECTION);\n            // Hide these for an instant while we do the calculations.\n            openSections.css(\"display\", \"none\");\n\n            var maxTilesPerRow = 1;\n            var thisRowCount = 0;\n            var allTiles = $(Selector.TILES).children(Selector.TILE).not(Selector.TILE_COLLAPSED).not(\".spacer\");\n            allTiles.each(function (index, tile) {\n                currentSectionId = $(tile).attr(\"data-section\");\n                var maxVerticalPositionDifference = 100;\n                if (currentSectionId) {\n                    if (index === 0) {\n                        // We are on the first tile, so append a row and add tile ID to it.\n                        thisRowCount = 1;\n                    } else if (Math.abs($(tile).position().top - $(previousTile).position().top) <= maxVerticalPositionDifference) {\n                        thisRowCount += 1;\n                        // We are on the same row as the previous tile.\n                        // maxVerticalPositionDifference is because tiles on same row may have different vertical positions.\n                        // E.g. if one of the is in a hover state.  If they are within 100 px max they must be on same row.\n                    } else {\n                        // On a new row.\n                        thisRowCount = 0;\n                    }\n                    if (thisRowCount > maxTilesPerRow) {\n                        maxTilesPerRow = thisRowCount;\n                    }\n                    previousTile = tile;\n                }\n            });\n            openSections.css(\"display\", \"block\");\n\n            // Now allocate rows of maxTilesPerRow each until we run out of tiles.\n            allTiles.each(function (index, tile) {\n                currentSectionId = $(tile).attr(\"data-section\");\n                if (rows.length === 0 || rows[rows.length - 1].sections.length >= maxTilesPerRow) {\n                    if (rows.length >= 1) {\n                        // Update the display after tag on previous row.\n                        rows[rows.length - 1].displayAfterTile =\n                            rows[rows.length - 1].sections[(rows[rows.length - 1].sections).length - 1];\n                    }\n                    // Start a new row.\n                    rows.push({\n                        displayAfterTile: \"\",\n                        sections: [currentSectionId]\n                    });\n                } else {\n                    rows[rows.length - 1].sections.push(currentSectionId);\n                }\n            });\n            rows[rows.length - 1].displayAfterTile =\n                rows[rows.length - 1].sections[(rows[rows.length - 1].sections).length - 1];\n            return rows;\n        },\n\n        /**\n         * Move content sections to appear under the correct tiles\n         * so that when a tile is clicked, they expand under it\n         * @param {Array} positionData\n         * @param {[function]} callbacks\n         */\n        moveContentSectionsToPlaces: function (positionData, callbacks) {\n            positionData.forEach(function (row) {\n                row.sections.forEach(function (contentSection) {\n                    if (row.displayAfterTile === positionData[positionData.length - 1].displayAfterTile) {\n                        $(Selector.SECTION_ID + contentSection).detach().insertAfter($(\"ul.tiles .tile\").last());\n                    } else {\n                        $(Selector.SECTION_ID + contentSection).detach().insertAfter($(\"#tile-\" + row.displayAfterTile));\n                    }\n                });\n            });\n            callbacks.forEach(function(func) {\n                if (typeof func === \"function\") {\n                    func();\n                }\n            });\n        },\n\n        /**\n         * Re-organise the sections so that they are in the correct order\n         * e.g. content section 3 is on the row below tile 3, so that\n         * when tile 3 is clicked, content section 3 opens directly under it\n         * @param {boolean} delayBefore should we delay before doing the re-org?\n         * @return {Promise}\n         */\n        runReOrg: function (delayBefore) {\n            // Create a new Deferred.\n            var dfd = new $.Deferred();\n            if (reOrgLocked === true) {\n                // Avoid repeated re-organisations - one at a time.\n                dfd.reject(\"Re-org locked\");\n            }\n            reOrgLocked = true;\n            var action = function() {\n                organiser.moveContentSectionsToPlaces(\n                    organiser.getContentSectionPositions(),\n                    [\n                        function() {\n                            $(\"body\").removeClass(\"modal-open\");\n                            dfd.resolve(\"Finished organising tiles\");\n                            reOrgLocked = false;\n                        }\n                    ]\n                );\n            };\n\n            if (delayBefore === true) {\n                // We want to allow a delay before we start the re-org. This allows any page animation going on to end.\n                setTimeout(function() {\n                    action();\n                    dfd.resolve(\"Re-org complete\");\n                }, 1000);\n            } else {\n                action();\n                dfd.resolve(\"Re-org complete\");\n            }\n            return dfd.promise();\n        }\n    };\n\n    var setListeners = function () {\n        // If theme uses docked blocks (e.g. more) then re-organise if they move.\n        $(\".block-hider-hide\").click(function () {\n            organiser.runReOrg(true);\n        });\n\n        $(\".block-hider-show\").click(function () {\n            organiser.runReOrg(true);\n        });\n\n        // If nav drawer is opened or closed, this rezises the window so need to re-initialise content divs.\n        $(\".navbar button[data-action=\\\"toggle-drawer\\\"]\").click(function () {\n            setTimeout(function() {\n                organiser.runReOrg(true);\n                resizeTilesDivWidth();\n            }, 600);\n\n        });\n    };\n\n    /**\n     * On initial page load, we need to unhide the tiles.  They will have been hidden from PHP if we are using JS.\n     * This is to cover the initial setting up of div width (i.e. allow us time to get screen width and set up).\n     */\n    var unHideTiles = function() {\n        $(Selector.TILES).animate({opacity: 1}, \"fast\");\n        $(Selector.TILE).removeClass(\"initiallyhidden\");\n        $(Selector.SECTION_ZERO).animate({opacity: 1}, \"fast\");\n        $(\"#page-loading-icon\").fadeOut(500).remove();\n    };\n\n    return {\n        init: function(courseIdInit, sectionOpen, fitTilesToWidth, isEditing) {\n            courseId = courseIdInit;\n            $(document).ready(function() {\n                setListeners();\n                if ($(Selector.TILES).css(\"opacity\") === \"1\") {\n                    organiser.runReOrg().done(function() {\n                        if (sectionOpen !== 0) {\n                            // Tiles are already visible so open the tile user was on previously (if any).\n                            $(Selector.TILEID + sectionOpen).click();\n                        }\n                    });\n                }\n\n                // When we first load the page we want to move the tile contents divs.\n                // Put them in the correct rows according to which row of tiles they relate to.\n                // Only then do we re-open the last section the user had open.\n                var organiseAndRevealTiles = function () {\n                    organiser.runReOrg().done(function() {\n                        if (sectionOpen !== 0 && $(Selector.OPEN_SECTION).length === 0) {\n                            // Now open the tile user was on previously (if any).\n                            $(Selector.TILEID + sectionOpen).click();\n                        }\n                        unHideTiles();\n                    });\n                };\n                if (fitTilesToWidth && !isEditing) {\n                    // If we have a single tile on the last row it looks odd so resize window.\n                    resizeTilesDivWidth().done(function() {\n                        organiseAndRevealTiles();\n                    }).fail(function() {\n                        // If resize is rejected e.g. as screen is to narrow e.g. mobile.\n                        organiseAndRevealTiles();\n                    });\n                } else {\n                    organiseAndRevealTiles();\n                }\n            });\n        },\n        resizeTilesDivWidth: function() {\n            return resizeTilesDivWidth();\n        },\n        runReOrg: function (delayBefore) {\n            return organiser.runReOrg(delayBefore);\n        }\n    };\n});"],"names":["define","$","ajax","reOrgLocked","courseId","Selector","PAGE","TILE","TILEID","TILE_COLLAPSED","TILES","ACTIVITY","SPACER","SECTION_ID","OPEN_SECTION","SECTION_ZERO","CONTENT_SECTIONS","timeoutBeforeResizeAjax","resizeTilesDivWidth","winWidth","window","width","dfd","Deferred","tiles","TILE_WIDTHS","standard","min","mobileMin","tilesParentWidth","parent","innerWidth","firstTile","find","oneTileWidth","tileMargin","resizeWidth","maxPossibleTilesPerRow","Math","floor","tileCount","not","reject","range","start","end","res","push","rowMaxCount","rowMinCount","possibleRowCounts","reverse","lastRowRemainderTiles","map","num","indexOf","max","apply","existingWidth","parseInt","css","replace","abs","resolve","resizeTime","animate","max-width","setTimeout","clearTimeout","call","methodname","args","courseid","err","promise","organiser","getContentSectionPositions","rows","currentSectionId","previousTile","openSections","maxTilesPerRow","thisRowCount","allTiles","children","each","index","tile","attr","maxVerticalPositionDifference","position","top","length","sections","displayAfterTile","moveContentSectionsToPlaces","positionData","callbacks","forEach","row","contentSection","detach","insertAfter","last","func","runReOrg","delayBefore","action","removeClass","setListeners","click","unHideTiles","opacity","fadeOut","remove","init","courseIdInit","sectionOpen","fitTilesToWidth","isEditing","document","ready","done","organiseAndRevealTiles","fail"],"mappings":"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"}