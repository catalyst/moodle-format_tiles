define(["jquery","core/modal_factory","core/config","core/templates","core/notification","core/ajax"],function($,modalFactory,config,Templates,Notification,ajax){"use strict";var modalStore={};var loadingIconHtml;var win=$(window);var courseId;var Selector={toggleCompletion:".togglecompletion",modal:".modal",modalDialog:".modal-dialog",modalBody:".modal-body",sectionMain:".section.main",pageContent:"#page-content",regionMain:"#region-main",completionState:"#completionstate_",cmModalClose:".embed_cm_modal .close",cmModal:".embed_cm_modal",moodleMediaPlayer:".mediaplugin_videojs",urlModalLoadWarning:"#embed-url-error-msg-",closeBtn:"button.close",ACTIVITY:"li.activity",URLACTIVITYPOPUPLINK:".activity.modtype_url.urlpopup a",newWindowButton:".button_expand",modalHeader:".modal-header",embedModuleButtons:".embed-module-buttons"};var LaunchModalDataActions={launchResourceModal:"launch-tiles-resource-modal",launchModuleModal:"launch-tiles-module-modal",launchUrlModal:"launch-tiles-url-modal"};var modalMinWidth=function(){return Math.min(win.width(),1e3)};var stopAllVideosOnDismiss=function(modal){var iframes=modal.find("iframe");if(iframes.length>0){modal.find(Selector.closeBtn).click(function(e){$(e.currentTarget).closest(Selector.cmModal).find("iframe").each(function(index,iframe){iframe=$(iframe);iframe.attr("src",iframe.attr("src"))})})}var objects=modal.find("object");if(objects.length>0){modal.find(Selector.closeBtn).click(function(e){var modal=$(e.currentTarget).closest(Selector.cmModal);modal.find("object").each(function(index,object){object=$(object);object.attr("data","")});modalStore[modal.attr("data-cmid")]=undefined})}var moodleMediaPlayer=modal.find(Selector.moodleMediaPlayer);if(moodleMediaPlayer.length>0){modal.find(Selector.closeBtn).click(function(){modal.find(Selector.moodleMediaPlayer).html("")});modalStore[modal.attr("data-cmid")]=undefined}};var launchCourseResourceModal=function(clickedCmObject){var cmid=clickedCmObject.attr("data-cmid");modalFactory.create({type:modalFactory.types.DEFAULT,title:clickedCmObject.attr("data-title"),body:loadingIconHtml}).done(function(modal){modalStore[cmid]=modal;modal.setLarge();modal.show();var modalRoot=$(modal.root);modalRoot.attr("id","embed_mod_modal_"+cmid);modalRoot.attr("data-cmid",cmid);modalRoot.addClass("embed_cm_modal");var templateData={id:cmid,pluginfileUrl:clickedCmObject.attr("data-url"),objectType:"text/html",width:"100%",height:Math.round(win.height()-60),cmid:cmid,tileid:clickedCmObject.closest(Selector.sectionMain).attr("data-section"),isediting:0,sesskey:config.sesskey,modtitle:clickedCmObject.attr("data-title"),config:{wwwroot:config.wwwroot},showDownload:0,showNewWindow:0,completionInUseForCm:0};if(clickedCmObject.attr("data-modtype")==="resource_pdf"){templateData.objectType="application/pdf";templateData.showDownload=1;templateData.showNewWindow=1}Templates.render("format_tiles/embed_file_modal_body",templateData).done(function(html){modal.setBody(html);modalRoot.find(Selector.modalBody).animate({"min-height":Math.round(win.height()-60)},"fast");if(clickedCmObject.attr("data-modtype")==="resource_html"){modalRoot.find(Selector.modal).animate({"max-width":"100%"},"fast");modalRoot.find(Selector.modalDialog).animate({"max-width":"100%"},"fast");modalRoot.find(Selector.modalBody).animate({"max-width":"100%"},"fast");stopAllVideosOnDismiss(modalRoot)}else{modalRoot.find(Selector.modal).animate({"max-width":modalMinWidth()},"fast");modalRoot.find(Selector.modalDialog).animate({"max-width":modalMinWidth()},"fast")}}).fail(Notification.exception);if(clickedCmObject.find(Selector.toggleCompletion).length!==0){var inverseCompletionState=parseInt($(Selector.completionState+cmid).attr("value"));templateData.completionInUseForCm=1;templateData.completionstate=1-inverseCompletionState;templateData.completionicon=inverseCompletionState===1?"n":"y";templateData.completionstateInverse=inverseCompletionState;templateData.completionIsManual=clickedCmObject.find(Selector.toggleCompletion).attr("data-ismanual")}Templates.render("format_tiles/embed_module_modal_header_btns",templateData).done(function(html){modalRoot.find(Selector.modalHeader).append(html);modalRoot.find(Selector.closeBtn).detach().appendTo(modalRoot.find(Selector.embedModuleButtons))}).fail(Notification.exception);return true});return false};var launchEmbeddedUrlModal=function(clickedCmObject){var cmid=clickedCmObject.attr("data-cmid");modalFactory.create({type:modalFactory.types.DEFAULT,title:clickedCmObject.attr("data-title"),body:loadingIconHtml}).done(function(modal){modalStore[cmid]=modal;modal.setLarge();modal.show();var modalRoot=$(modal.root);modalRoot.attr("id","embed_mod_modal_"+cmid);modalRoot.attr("data-cmid",cmid);modalRoot.addClass("embed_cm_modal");var modalWidth=Math.round(win.width()*.9);var modalHeight=Math.round(win.height()*.9);var templateData={id:cmid,pluginfileUrl:clickedCmObject.attr("data-url"),objectType:"text/html",width:modalWidth-30,height:modalHeight-30,cmid:cmid,tileid:clickedCmObject.closest(Selector.sectionMain).attr("data-section"),isediting:0,sesskey:config.sesskey,modtitle:clickedCmObject.attr("data-title"),config:{wwwroot:config.wwwroot},showDownload:0,showNewWindow:1,completionInUseForCm:0,secondaryurl:clickedCmObject.closest(Selector.ACTIVITY).attr("data-url-secondary")};Templates.render("format_tiles/embed_url_modal_body",templateData).done(function(html){modal.setBody(html);modalRoot.find(Selector.modalBody).animate({"min-height":modalHeight},"fast");modalRoot.find(Selector.modal).animate({"max-width":modalWidth},"fast");modalRoot.find(Selector.modalDialog).animate({"max-width":modalWidth},"fast");modalRoot.find(Selector.modalBody).animate({"max-width":modalWidth},"fast");stopAllVideosOnDismiss(modalRoot);modalRoot.find(Selector.modalBody).addClass("text-center")}).fail(Notification.exception);if(clickedCmObject.find(Selector.toggleCompletion).length!==0){var inverseCompletionState=parseInt($(Selector.completionState+cmid).attr("value"));templateData.completionInUseForCm=1;templateData.completionstate=1-inverseCompletionState;templateData.completionicon=inverseCompletionState===1?"n":"y";templateData.completionstateInverse=inverseCompletionState;templateData.completionIsManual=clickedCmObject.find(Selector.toggleCompletion).attr("data-ismanual")}Templates.render("format_tiles/embed_module_modal_header_btns",templateData).done(function(html){modalRoot.find(Selector.modalHeader).append(html);modalRoot.find(Selector.closeBtn).detach().appendTo(modalRoot.find(Selector.embedModuleButtons))}).fail(Notification.exception);setTimeout(function(){modalRoot.find(Selector.newWindowButton).click(function(){modalStore[modalRoot.attr("data-cmid")]=undefined;modalRoot.remove();$(".modal-backdrop").not("#window-overlay").removeClass("show").addClass("hide")})},1e3);return true});return false};var resizeModal=function(modalRoot){modalRoot.find(Selector.modal).animate({"max-width":modalMinWidth()},"fast");var MODAL_MARGIN=70;var mediaPlayer=$(Selector.moodleMediaPlayer);mediaPlayer.find("div").each(function(index,child){$(child).css("max-width","")});if(mediaPlayer.length>0){stopAllVideosOnDismiss(modalRoot)}modalRoot.find("iframe").each(function(index,iframe){var modal;modal=modalRoot.find(Selector.modalDialog);if(modal.length===0){modal=modalRoot.find(Selector.modal)}var iframeWidth=Math.min($(iframe).width(),win.width());if(iframeWidth>modal.width()-MODAL_MARGIN){modal.animate({"max-width":Math.max(iframeWidth+MODAL_MARGIN,modalMinWidth())},"fast");modalRoot.find(Selector.modal).animate({"max-width":Math.max(iframeWidth+MODAL_MARGIN,modalMinWidth())},"fast")}var iframeHeight=Math.min($(iframe).height(),win.height());var modalBody=modalRoot.find(Selector.modalBody);if(iframeHeight>modalBody.height()-MODAL_MARGIN){modalBody.animate({"min-height":Math.min(iframeHeight+MODAL_MARGIN,win.height())},"fast")}modalBody.css("text-align","center");stopAllVideosOnDismiss(modalRoot)})};var launchCourseActivityModal=function(clickedCmObject){var cmid=clickedCmObject.attr("data-cmid");var methodName="format_tiles_get_mod_"+clickedCmObject.attr("data-modtype")+"_html";modalFactory.create({type:modalFactory.types.DEFAULT,title:clickedCmObject.attr("data-title"),body:loadingIconHtml}).done(function(modal){modalStore[cmid]=modal;modal.setLarge();modal.show();var modalRoot=$(modal.root);modalRoot.attr("data-cmid",cmid);modalRoot.attr("id","embed_mod_modal_"+cmid);modalRoot.addClass("embed_cm_modal");modalRoot.addClass("mod_"+clickedCmObject.attr("data-modtype"));stopAllVideosOnDismiss(modalRoot);ajax.call([{methodname:methodName,args:{courseid:courseId,cmid:cmid}}])[0].done(function(response){var templateData={cmid:cmid,modtitle:clickedCmObject.attr("data-title"),content:response.html};if(clickedCmObject.find(Selector.toggleCompletion).length!==0){var inverseCompletionState=parseInt($(Selector.completionState+cmid).attr("value"));templateData.completionInUseForCm=1;templateData.completionstate=1-inverseCompletionState;templateData.completionstateInverse=inverseCompletionState;templateData.completionIsManual=clickedCmObject.find(Selector.toggleCompletion).attr("data-ismanual");templateData.completionicon=inverseCompletionState===1?"n":"y"}else{templateData.completionInUseForCm=0}modal.setBody(templateData.content);Templates.render("format_tiles/embed_module_modal_header_btns",templateData).done(function(html){modalRoot.find(Selector.modalHeader).append(html);modalRoot.find(Selector.closeBtn).detach().appendTo(modalRoot.find(Selector.embedModuleButtons))}).fail(Notification.exception);resizeModal(modalRoot);return true}).fail(function(ex){if(config.developerdebug!==true){window.location=config.wwwroot+"/mod/"+clickedCmObject.attr("data-modtype")+"/view.php?id="+cmid}else{Notification.exception(ex)}})});return false};var launchUrlPopUp=function(e){var clickedActivity=$(e.currentTarget).closest(Selector.ACTIVITY);if(clickedActivity.attr("data-url")!==undefined){e.stopPropagation();e.preventDefault();ajax.call([{methodname:"format_tiles_log_mod_view",args:{courseid:courseId,cmid:clickedActivity.attr("data-cmid")}}])[0].done(function(){require(["format_tiles/completion"],function(completion){completion.markAsAutoCompleteInUI(courseId,clickedActivity)});var newWin=window.open(clickedActivity.attr("data-url"));try{newWin.focus()}catch(e){var popUpLink="<div>"+'<a href="'+clickedActivity.attr("data-url")+'">'+clickedActivity.attr("data-url")+"</a></div>";require(["core/str","core/notification"],function(Str,Notification){var stringKeys=[{key:"sectionerrortitle",component:"format_tiles"},{key:"blockedpopup",component:"format_tiles"},{key:"cancel"}];Str.get_strings(stringKeys).done(function(s){Notification.alert(s[0],s[1]+popUpLink,s[2])})})}}).fail(Notification.exception)}};return{init:function(courseIdInit,isEditing){courseId=courseIdInit;$(document).ready(function(){var modalSelectors=Object.keys(LaunchModalDataActions).map(function(key){return'[data-action="'+LaunchModalDataActions[key]+'"]'}).join(", ");var pageContent=$(Selector.pageContent);if(pageContent.length===0){pageContent=$(Selector.regionMain)}pageContent.on("click",modalSelectors,function(e){e.preventDefault();var tgt=$(e.currentTarget);var clickedCmObject=tgt.closest("li.activity");var existingModal=modalStore[clickedCmObject.attr("data-cmid")];if(typeof existingModal==="object"){existingModal.show()}else{switch(tgt.attr("data-action")){case LaunchModalDataActions.launchModuleModal:launchCourseActivityModal(clickedCmObject);break;case LaunchModalDataActions.launchResourceModal:launchCourseResourceModal(clickedCmObject);break;case LaunchModalDataActions.launchUrlModal:launchEmbeddedUrlModal(clickedCmObject);break;default:throw new Error("Unknown modal type "+tgt.attr("data-action"))}ajax.call([{methodname:"format_tiles_log_mod_view",args:{courseid:courseId,cmid:clickedCmObject.attr("data-cmid")}}])[0].fail(Notification.exception)}});Templates.render("format_tiles/loading",{}).catch(Notification.exception).done(function(html){loadingIconHtml=html}).fail(Notification.exception);if(!isEditing){pageContent.on("click",Selector.URLACTIVITYPOPUPLINK,function(e){launchUrlPopUp(e)})}})}}});
//# sourceMappingURL=course_mod_modal.min.js.map