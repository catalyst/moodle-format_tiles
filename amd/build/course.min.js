define(["jquery","core/templates","core/ajax","format_tiles/browser_storage","core/notification","core/str","format_tiles/tile_fitter","format_tiles/window_overlay"],function($,Templates,ajax,browserStorage,Notification,str,tileFitter,windowOverlay){"use strict";var body=$("body");var bodyHtml=$("body, html");var isMobile;var loadingIconHtml;var windowOverlayDiv=false;var stringStore=[];var scrollFuncLock=false;var sectionIsOpen=false;var HEADER_BAR_HEIGHT=60;var reopenLastVisitedSection=false;var backDropZIndex=0;var courseId;var resizeLocked=false;var openTile=0;var Selector={PAGE:"#page",TILE:".tile",TILEID:"#tile-",MOVEABLE_SECTION:".moveablesection",FILTER_BUTTON:".filterbutton",TILE_LOADING_ICON:".tile-loading-icon",TILE_LOADING_ICON_ID:"#loading-icon-",TILE_COLLAPSED:".tile-collapsed",TILE_CLICKABLE:".tile-clickable",TILES:"ul.tiles",ACTIVITY:".activity",SPACER:".spacer",SECTION_MOVEABLE:".moveablesection",SECTION_ID:"#section-",SECTION_TITLE:".sectiontitle",SECTION_MAIN:".section.main",SECTION_BUTTONS:"#sectionbuttons",CLOSE_SEC_BTN:".closesectionbtn",HIDE_SEC0_BTN:"#buttonhidesec0",SECTION_ZERO:"#section-0",MOODLE_VIDEO:".mediaplugin.mediaplugin_videojs",LAUNCH_STANDARD:'[data-action="launch-tiles-standard"]',TOOLTIP:"[data-toggle=tooltip]",HEADER_BAR:["header.navbar","nav.fixed-top.navbar","#essentialnavbar.moodle-has-zindex","#navwrap","nav.navbar-fixed-top","#main-navbar"]};var ClassNames={SELECTED:"selected",HEADER_OVERLAY:"header-overlay",OPEN:"open",CLOSED:"closed",LAUNCH_CM_MODAL:"launch-tiles-cm-modal",STATE_VISIBLE:"state-visible"};var Event={CLICK:"click",KEYDOWN:"keydown",SCROLL:"scroll"};var CSS={DISPLAY:"display",Z_INDEX:"z-index",HEIGHT:"height",BG_COLOUR:"background-color"};var Keyboard={ESCAPE:27,TAB:9,RETURN:13};var stopVideoPlaying=function(section){var contentSection=$(Selector.SECTION_ID+section);contentSection.find("iframe").each(function(index,iframe){iframe=$(iframe);iframe.attr("data-src",iframe.attr("src"));iframe.attr("src","")});var mediaPlayers=contentSection.find(Selector.MOODLE_VIDEO);if(mediaPlayers.length>0){contentSection.html("")}};var cancelTileSelections=function(sectionToFocus){$(Selector.MOVEABLE_SECTION).each(function(index,sec){sec=$(sec);if(sec.is(":visible")){stopVideoPlaying(sec.attr("data-section"));sec.slideUp().removeClass(ClassNames.STATE_VISIBLE)}});$(Selector.TILE).removeClass(ClassNames.SELECTED).css(CSS.Z_INDEX,"").css(CSS.BG_COLOUR,"");$(".section "+ClassNames.SELECTED).removeClass(ClassNames.SELECTED).css(CSS.Z_INDEX,"");if(windowOverlayDiv){windowOverlay.fadeOut(300)}else{$(Selector.TILE).removeClass("faded")}if(sectionToFocus!==undefined&&sectionToFocus!==0){$(Selector.TILEID+sectionToFocus).focus()}$(Selector.TILE_LOADING_ICON).fadeOut(300,function(){$(Selector.TILE_LOADING_ICON).html("")});sectionIsOpen=false;openTile=0};var setCourseContentHTML=function(contentArea,content){if(content){contentArea.html(content);$(Selector.TILE_LOADING_ICON).fadeOut(300,function(){$(Selector.TILE_LOADING_ICON).html("")});if(contentArea.attr("id")!==Selector.SECTION_ZERO){var activities=contentArea.find(Selector.ACTIVITY).not(Selector.SPACER);contentArea.on(Event.KEYDOWN,function(e){if(e.keyCode===Keyboard.ESCAPE){browserStorage.setLastVisitedSection(0);cancelTileSelections(0);$(Selector.TILEID+contentArea.attr("data-section")).focus()}});activities.on(Event.KEYDOWN,function(e){if(e.keyCode===Keyboard.RETURN){var toClick=$(e.currentTarget).find("a");if(toClick.hasClass(ClassNames.LAUNCH_CM_MODAL)){toClick.click()}else if(toClick.attr("href")!==undefined){window.location=toClick.attr("href")}}});if(!isMobile){activities.last().on(Event.KEYDOWN,function(e){if(e.keyCode===Keyboard.TAB&&!e.shiftKey&&$(e.relatedTarget).closest(Selector.SECTION_MAIN).attr("id")!==contentArea.attr("id")){setTimeout(function(){contentArea.find(Selector.SECTION_TITLE).focus();bodyHtml.animate({scrollTop:contentArea.offset().top-HEADER_BAR_HEIGHT},"slow");contentArea.find("#sectionbuttons").css("top","")},200)}});contentArea.find(Selector.SECTION_TITLE).on(Event.KEYDOWN,function(e){if(e.keyCode===Keyboard.TAB&&e.shiftKey&&$(e.relatedTarget).closest(Selector.SECTION_MAIN).attr("id")!==contentArea.attr("id")){setTimeout(function(){activities.last().focus()},200)}})}}if(!isMobile){setTimeout(function(){try{contentArea.find(".togglecompletion, .completioncheckbox, .tag-info").tooltip()}catch(err){require(["core/log"],function(log){log.debug(err)})}},500)}if(contentArea.find(Selector.MOODLE_VIDEO).length!==0){require(["media_videojs/loader"],function(videoJS){videoJS.setUp()})}return true}return false};var expandSection=function(contentArea,tileId){var expandAndScroll=function(){var scrollTo=$("#tileText-"+tileId).offset().top-HEADER_BAR_HEIGHT;if(scrollTo===$(window).scrollTop){scrollTo+=1}contentArea.find(Selector.SECTION_TITLE).focus();var events="scroll mousedown wheel DOMMouseScroll mousewheel keyup touchmove";body.on(events,function(){body.stop()});bodyHtml.animate({scrollTop:scrollTo},"slow",function(){bodyHtml.off(events,function(){bodyHtml.stop()})});sectionIsOpen=true;openTile=tileId;contentArea.find(Selector.ACTIVITY).first().focus();contentArea.find("iframe").each(function(index,iframe){iframe=$(iframe);if(iframe.attr("src")===""&&iframe.attr("data-src")!==undefined){iframe.attr("src",iframe.attr("data-src"))}})};var holdSectionButtonPosition=function(){var buttons=contentArea.find(Selector.SECTION_BUTTONS);$(window).on(Event.SCROLL,function(){if(!scrollFuncLock&&sectionIsOpen){scrollFuncLock=true;buttons.fadeOut(300);setTimeout(function(){var windowTop=$(window).scrollTop();var desiredNewPositionInSection=windowTop-contentArea.offset().top+50;if(desiredNewPositionInSection>0&&desiredNewPositionInSection<contentArea.outerHeight()-100){desiredNewPositionInSection=windowTop-contentArea.offset().top+50;buttons.css("top",desiredNewPositionInSection);if(windowOverlayDiv){windowOverlay.fadeIn()}}else if(desiredNewPositionInSection<0){buttons.css("top",0)}if(windowTop>contentArea.offset().top+contentArea.outerHeight()-50){if(windowOverlayDiv){windowOverlay.fadeOut()}buttons.css("top",0)}else if(contentArea.offset().top>windowTop+$(window).outerHeight()){if(windowOverlayDiv){windowOverlay.fadeOut()}buttons.css("top",0)}else{if(windowOverlayDiv){windowOverlay.fadeIn()}}buttons.fadeIn(300,function(){scrollFuncLock=false})},500)}});if(!scrollFuncLock&&!sectionIsOpen&&windowOverlay&&windowOverlay.isVisible()){windowOverlay.fadeOut()}};contentArea.addClass(ClassNames.STATE_VISIBLE);contentArea.slideDown(350,function(){expandAndScroll();holdSectionButtonPosition()});openTile=tileId};var reOrgSections=function(delayBefore,fitTilesToScreenWidth){var dfd=new $.Deferred;var openedSection=$(".moveablesection:visible");var openedSectionNum=0;if(openedSection.length>0){openedSectionNum=openedSection.attr("data-section");cancelTileSelections()}var reOrgFunc=function(delayBefore){tileFitter.runReOrg(delayBefore).done(function(result){if(openedSectionNum!==0){expandSection(openedSection,openedSectionNum)}dfd.resolve(result)}).fail(function(result){if(openedSectionNum!==0){expandSection(openedSection,openedSectionNum)}dfd.reject(result)})};if(fitTilesToScreenWidth){setTimeout(function(){tileFitter.resizeTilesDivWidth(courseId).done(function(){reOrgFunc(false)},delayBefore)})}else{reOrgFunc(delayBefore)}return dfd.promise()};var failedLoadSectionNotify=function(sectionNum,failResult,contentArea){if(failResult){Notification.confirm(stringStore.sectionerrortitle,stringStore.sectionerrorstring,stringStore.refresh,stringStore.cancel,function(){window.location.reload()},null);contentArea.html("")}else{setCourseContentHTML(contentArea,"<p>"+stringStore.noconnectionerror+"</p>");setTimeout(function(){expandSection(contentArea,sectionNum)},500)}require(["core/log"],function(log){log.debug(failResult)});throw new Error("Not successful retrieving tile content by AJAX for section "+sectionNum)};var getSectionContentFromServer=function(courseId,sectionNum){return ajax.call([{methodname:"format_tiles_get_single_section_page_html",args:{courseid:courseId,sectionid:sectionNum,setjsusedsession:true}}])[0]};var clickItemBehind=function(e){var clickedItem=$(e.currentTarget);if(clickedItem.attr("id")==="window-overlay"||clickedItem.attr("id")===ClassNames.HEADER_OVERLAY){clickedItem.hide();var BottomElement=$(document.elementFromPoint(e.clientX,e.clientY));clickedItem.show();if(clickedItem.attr("id")==="window-overlay"){if(BottomElement.hasClass("filterbutton")||BottomElement.hasClass("list-group-item")){BottomElement.click()}else{var clickedTile=BottomElement.closest(Selector.TILE);if(clickedTile){clickedTile.click()}}}else{cancelTileSelections(0);BottomElement.click()}}};var setSectionZeroFromUserPref=function(){var buttonHideSecZero=$(Selector.HIDE_SEC0_BTN);var sectionZero=$(Selector.SECTION_ZERO);if(browserStorage.storageEnabledLocal()){if(browserStorage.getSecZeroCollapseStatus()===true){sectionZero.slideUp(0);buttonHideSecZero.addClass(ClassNames.CLOSED).removeClass(ClassNames.OPEN)}else{sectionZero.slideDown(300);buttonHideSecZero.addClass(ClassNames.OPEN).removeClass(ClassNames.CLOSED)}}else{buttonHideSecZero.addClass(ClassNames.OPEN).removeClass(ClassNames.CLOSED);sectionZero.slideDown(300)}};var populateAndExpandSection=function(courseId,thisTile,dataSection,storedContentExpirySecs){if(windowOverlayDiv){windowOverlay.set(dataSection)}else{$(Selector.TILE).addClass("faded");thisTile.removeClass("faded")}$(Selector.TILE).removeClass(ClassNames.SELECTED);thisTile.addClass(ClassNames.SELECTED);openTile=dataSection;$(Selector.MOVEABLE_SECTION).each(function(index,sec){sec=$(sec);if(sec.is(":visible")){stopVideoPlaying(sec.attr("data-section"));sec.slideUp(200).removeClass(ClassNames.STATE_VISIBLE)}});ajax.call([{methodname:"format_tiles_log_tile_click",args:{courseid:courseId,sectionid:dataSection}}])[0].fail(Notification.exception);var relatedContentArea=$(Selector.SECTION_ID+dataSection);if(relatedContentArea.find(Selector.ACTIVITY).length>0){expandSection(relatedContentArea,dataSection);if(browserStorage.getStoredContentAge(courseId,dataSection)>storedContentExpirySecs||!browserStorage.getStoredContentAge(courseId,dataSection)){getSectionContentFromServer(courseId,dataSection).done(function(response){if(browserStorage.storageEnabledSession()){browserStorage.storeCourseContent(courseId,dataSection,$(response.html).html())}})}}else{relatedContentArea.html(loadingIconHtml);if(browserStorage.storageEnabledLocal()){var contentAge=browserStorage.getStoredContentAge(courseId,dataSection);if(contentAge){setCourseContentHTML(relatedContentArea,browserStorage.getCourseContent(courseId,dataSection));expandSection(relatedContentArea,dataSection)}if(!contentAge||contentAge>storedContentExpirySecs){var loadingIcon=$(Selector.TILE_LOADING_ICON_ID+dataSection);if(loadingIcon!==undefined){loadingIcon.html(loadingIconHtml).fadeIn(200)}else{loadingIcon=$("<div>").html(loadingIconHtml);relatedContentArea.html(loadingIcon)}getSectionContentFromServer(courseId,dataSection).done(function(response){var contentToDisplay=$(response.html).html();setCourseContentHTML(relatedContentArea,contentToDisplay);expandSection(relatedContentArea,dataSection);if(browserStorage.storageEnabledSession()){browserStorage.storeCourseContent(courseId,dataSection,contentToDisplay)}}).fail(function(failResult){failedLoadSectionNotify(dataSection,failResult,relatedContentArea);cancelTileSelections(dataSection)})}}else{getSectionContentFromServer(courseId,dataSection).done(function(response){setCourseContentHTML(relatedContentArea,$(response.html).html());expandSection(relatedContentArea,dataSection)}).fail(function(failResult){failedLoadSectionNotify(dataSection,failResult,relatedContentArea);cancelTileSelections(dataSection)})}}browserStorage.setLastVisitedSection(dataSection)};return{init:function(courseIdInit,useJavascriptNav,maxContentSectionsToStore,isMobileInit,sectionNum,storedContentExpirySecs,storedContentDeleteMins,useFilterButtons,assumeDataStoreConsent,reopenLastSectionInit,userId,fitTilesToWidth,useWindoOverlay){courseId=courseIdInit;isMobile=isMobileInit;reopenLastVisitedSection=reopenLastSectionInit==="1";useFilterButtons=useFilterButtons===1;assumeDataStoreConsent=assumeDataStoreConsent==="1";browserStorage.init(courseId,maxContentSectionsToStore,false,sectionNum,storedContentDeleteMins,assumeDataStoreConsent,userId);$(document).ready(function(){var pageContent=$("#page-content");if(pageContent.length===0){pageContent=$("#region-main")}if(sectionNum!==0){openTile=sectionNum}else{if(reopenLastVisitedSection&&browserStorage.storageEnabledLocal){openTile=browserStorage.getLastVisitedSection()}}if(openTile!==0){tileFitter.init(courseId,openTile,fitTilesToWidth,false)}else{$(Selector.TILEID+"1").focus();tileFitter.init(courseId,null,fitTilesToWidth,false)}var windowWidth=$(window).outerWidth();if(useJavascriptNav){if(useWindoOverlay){windowOverlayDiv=windowOverlay.getWindowOverlay();windowOverlayDiv.click(function(e){cancelTileSelections(0);clickItemBehind(e)})}pageContent.on(Event.CLICK,Selector.TILE_CLICKABLE,function(e){if(!useJavascriptNav){return}e.preventDefault();$(window).off(Event.SCROLL);$(Selector.TILE_LOADING_ICON).fadeOut(300,function(){$(Selector.TILE_LOADING_ICON).html()});var thisTile=$(e.currentTarget).closest(Selector.TILE);var dataSection=parseInt(thisTile.attr("data-section"));if(thisTile.hasClass(ClassNames.SELECTED)){cancelTileSelections(dataSection);browserStorage.setLastVisitedSection(0)}else{populateAndExpandSection(courseId,thisTile,dataSection,storedContentExpirySecs)}var nextSecIfExists=$(Selector.SECTION_ID+(dataSection+1));if(!isMobile&&nextSecIfExists.length&&dataSection>0){setTimeout(function(){var storedContentAge=browserStorage.getStoredContentAge(courseId,dataSection+1);if(storedContentAge){setCourseContentHTML(nextSecIfExists,browserStorage.getCourseContent(courseId,dataSection+1))}if(!storedContentAge||storedContentAge>storedContentExpirySecs){getSectionContentFromServer(courseId,dataSection+1).done(function(response){setCourseContentHTML(nextSecIfExists,$(response.html).html());if(browserStorage.storageEnabledSession()){browserStorage.storeCourseContent(courseId,dataSection+1,$(response.html).html())}})}},2e3)}});$(window).on("resize",function(){if(resizeLocked||windowWidth===$(window).outerWidth()){return}resizeLocked=true;setTimeout(function(){var resizeRequired=true;var openContentSection=$(".moveablesection:visible");if(openContentSection.length!==0){var mediaPlayers=openContentSection.find(".mediaplugin iframe");if(mediaPlayers.length!==0){mediaPlayers.each(function(index,player){player=$(player);if(player.outerWidth()>openContentSection.outerWidth()){resizeRequired=false}})}}if(resizeRequired){windowWidth=$(window).outerWidth();reOrgSections(true,fitTilesToWidth)}resizeLocked=false},600)});if(useWindoOverlay){var headerBar=$(Selector.HEADER_BAR.find(function(selector){return $(selector).length>0}));if(headerBar!==undefined&&headerBar.length!==0){HEADER_BAR_HEIGHT=headerBar.outerHeight();var headerBarOverlay=windowOverlay.getHeaderBarOverlay(headerBar);if(headerBarOverlay){headerBarOverlay.click(function(e){cancelTileSelections(0);clickItemBehind(e)})}headerBar.css(CSS.Z_INDEX,windowOverlay.getZIndex()+2)}else{require(["core/log"],function(log){log.debug("Failed to get navbar.  Ensure theme's navbar selector is included in global HEADER_BAR")})}}pageContent.on(Event.CLICK,Selector.CLOSE_SEC_BTN,function(e){cancelTileSelections($(e.currentTarget).attr("data-section"))});pageContent.on(Event.CLICK,Selector.LAUNCH_STANDARD,function(e){var clickedLk=$(e.currentTarget);if(clickedLk.attr("href")!==undefined){window.location=clickedLk.attr("href")}else if(clickedLk.find("a").attr("href")!==undefined){window.location=clickedLk.find("a").attr("href")}});setSectionZeroFromUserPref()}pageContent.on(Event.CLICK,Selector.HIDE_SEC0_BTN,function(e){var sectionZero=$(Selector.SECTION_ZERO);if(sectionZero.css(CSS.DISPLAY)==="none"){sectionZero.slideDown(250);$(e.currentTarget).addClass(ClassNames.OPEN).removeClass(ClassNames.CLOSED);browserStorage.setSecZeroCollapseStatus("collapsed")}else{sectionZero.slideUp(250);$(e.currentTarget).addClass(ClassNames.CLOSED).removeClass(ClassNames.OPEN);browserStorage.setSecZeroCollapseStatus("expanded")}});if(useFilterButtons){require(["format_tiles/filter_buttons"],function(filterButtons){filterButtons.init(courseId,browserStorage.storageEnabledLocal)});if(useJavascriptNav){pageContent.on(Event.CLICK,Selector.FILTER_BUTTON,function(){cancelTileSelections(0);reOrgSections(true,false)})}}$(".tiles_coursenav").removeClass("hidden");Templates.render("format_tiles/loading",{}).done(function(html){loadingIconHtml=html});var stringKeys=[{key:"sectionerrortitle",component:"format_tiles"},{key:"sectionerrorstring",component:"format_tiles"},{key:"refresh"},{key:"cancel"},{key:"noconnectionerror",component:"format_tiles"},{key:"show"},{key:"hide"},{key:"other",component:"format_tiles"},{key:"blockedpopuptitle",component:"format_tiles"}];str.get_strings(stringKeys).done(function(s){s.forEach(function(str,index){stringStore[stringKeys[index].key]=str})});if(isMobile){pageContent.on(Event.CLICK,Selector.ACTIVITY+".video a",function(e){var target=$(e.currentTarget);var url=target.closest(Selector.ACTIVITY).attr("data-url-secondary");if(url!==undefined){e.preventDefault();e.stopPropagation();var cm=target.closest(Selector.ACTIVITY);ajax.call([{methodname:"format_tiles_log_mod_view",args:{courseid:courseId,cmid:cm.attr("data-cmid")}}])[0].done(function(){require(["format_tiles/completion"],function(completion){completion.markAsAutoCompleteInUI(courseId,cm)})});window.location=url}})}else{$(Selector.TILE).on(Event.KEYDOWN,function(e){if(e.keyCode===Keyboard.RETURN){$(e.currentTarget).click()}});$("ul.tiles .tile").first().focus();var toolTips=$(Selector.TOOLTIP);if(toolTips.length!==0){try{toolTips.tooltip()}catch(err){require(["core/log"],function(log){log.debug(err)})}}}$(document).on("filter-content-updated",function(event,msg){if(msg.length>0){var elem=$(msg[0]);if(elem.hasClass("moodle-dialogue")&&elem.css("z-index")<backDropZIndex){elem.css("z-index",backDropZIndex+1)}}})})}}});
//# sourceMappingURL=course.min.js.map