{"version":3,"sourceRoot":"..","sources":["server/course/format/tiles/amd/src/browser_storage_set_up.js"],"sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * Javascript Module to help set up user needs browser storage.\n *\n * @module browser_storage_set_up\n * @package course/format\n * @subpackage tiles\n * @copyright 2019 David Watson {@link http://evolutioncode.uk}\n * @license http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n * @since Moodle 3.3\n */\n\n/* eslint space-before-function-paren: 0 */\n\ndefine([\"jquery\"], function ($) {\n    \"use strict\";\n\n    var storageUserConsent = {\n        GIVEN: \"yes\", // What to store in local storage to indicate consent granted.\n        DENIED: \"no\" // Or to indicate consent denied.\n    };\n\n    var localStorageKeyElements = {\n        userPrefStorage: \"mdl-tiles-userPrefStorage\",\n        user: \"-user-\"\n    };\n\n    var storageType = {\n        local: \"local\",\n        session: \"session\"\n    };\n\n    var Enabled = {\n        local: false,\n        session: false\n    };\n    var userId;\n\n    var userChoice = null; // The user's current choice - initially null as we have not yet checked local storage or asked user.\n\n    var encodeStorageKey = function() {\n        return localStorageKeyElements.userPrefStorage + localStorageKeyElements.user + userId;\n    };\n\n    var storageAllowed = function() {\n        if (userChoice !== null) {\n            return userChoice;\n        } else {\n            var browserChoice = localStorage.getItem(encodeStorageKey());\n            if (browserChoice) {\n                userChoice = browserChoice === storageUserConsent.GIVEN;\n                return userChoice;\n            } else {\n                // This shouldn't happen much as user asked for pref if not present.\n                return null;\n            }\n        }\n    };\n\n    var setAllowed = function(allowedOrNot) {\n        if (allowedOrNot) {\n            userChoice = true;\n            localStorage.setItem(encodeStorageKey(), storageUserConsent.GIVEN);\n        } else {\n            userChoice = false;\n            localStorage.setItem(encodeStorageKey(), storageUserConsent.DENIED);\n        }\n    };\n\n    /**\n     * Launch the window enabling the user to select whether we want to store data locally or not\n     * @param {function} cleanUpFunc the function to execute to clean data if user says no.\n     */\n    var obtainUserPreference = function (cleanUpFunc) {\n        require([\"core/str\", \"core/notification\"], function(str, Notification) {\n            str.get_strings([\n                {key: \"datapref\", component: \"format_tiles\"},\n                {key: \"dataprefquestion\", component: \"format_tiles\"},\n                {key: \"yes\"},\n                {key: \"no\"}\n            ]).done(function (s) {\n                Notification.confirm(\n                    s[0],\n                    s[1],\n                    s[2],\n                    s[3],\n                    function() {\n                        setAllowed(true);\n                    },\n                    function() {\n                        setAllowed(false);\n                        if (typeof cleanUpFunc === \"function\") {\n                            cleanUpFunc();\n                        }\n                    }\n                );\n            });\n        });\n    };\n\n    /**\n     * Check if the user's browser supports localstorage or session storage\n     * @param {String} localOrSession the type of storage we wish to check\n     * @returns {boolean} whether or not storage is supported\n     */\n    var storageInitialCheck = function (localOrSession) {\n        var storage;\n        try {\n            if (localOrSession === storageType.local) {\n                storage = localStorage;\n            } else if (localOrSession === storageType.session) {\n                storage = sessionStorage;\n            }\n            if (typeof storage === \"undefined\") {\n                return false;\n            }\n            storage.setItem(\"testItem\", \"testValue\");\n            if (storage.getItem(\"testItem\") === \"testValue\") {\n                storage.removeItem(\"testItem\");\n                return true;\n            }\n            return false;\n        } catch (err) {\n            require([\"core/log\"], function(log) {\n                log.debug(err);\n            });\n            return false;\n        }\n    };\n\n    return {\n\n        setAllowed: function(allowedOrNot) {\n            setAllowed(allowedOrNot);\n        },\n        storageAllowed: function() {\n            return storageAllowed();\n        },\n        getStorageKey: function() {\n            return encodeStorageKey();\n        },\n        Enabled: Enabled,\n\n        init: function(userIdInit, assumeConsent, cleanUpFunc) {\n            userId = userIdInit;\n            $(document).ready(function () {\n                Enabled.local = storageInitialCheck(storageType.local);\n                Enabled.session = storageInitialCheck(storageType.session);\n\n                if (assumeConsent) {\n                    userChoice = true;\n                } else if (storageAllowed() === null && Enabled.local) {\n                    // We wait 3 seconds before launching the dialog to ensure content finished loading.\n                    setTimeout(function() {\n                        userChoice = obtainUserPreference(cleanUpFunc);\n                    }, 3000);\n                }\n\n                // If the user clicks the \"Data preference\" item in the navigation menu,\n                // show them the dialogue box to re-enter their local storage choice.\n                $('a[href*=\"datapref\"]').click(function (e) {\n                    e.preventDefault();\n                    obtainUserPreference(cleanUpFunc);\n                });\n            });\n        }\n    };\n\n});"],"names":["define","$","storageUserConsent","GIVEN","DENIED","localStorageKeyElements","userPrefStorage","user","storageType","local","session","Enabled","userId","userChoice","encodeStorageKey","storageAllowed","browserChoice","localStorage","getItem","setAllowed","allowedOrNot","setItem","obtainUserPreference","cleanUpFunc","require","str","Notification","get_strings","key","component","done","s","confirm","storageInitialCheck","localOrSession","storage","sessionStorage","removeItem","err","log","debug","getStorageKey","init","userIdInit","assumeConsent","document","ready","setTimeout","click","e","preventDefault"],"mappings":"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"}